!function(e){var t={};function i(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(s,a,function(t){return e[t]}.bind(null,a));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/build/",i(i.s=1)}([function(e,t){e.exports=void 0},function(e,t,i){"use strict";i.r(t);i(0);class s extends Phaser.Scene{constructor(e=[0,0],t="myScene"){super(t),this.position=e}relativeX(e=0){return this.position[0]+e}relativeY(e=0){return this.position[1]+e}enableScene(){}disableScene(){}registerEvent(e,t){}preload(){}create(){}}class a{constructor(e,t,i,s,a,r,n="courier20",o=20){this.boundingBox=e.add.rectangle(i,s,a,r,2236962).setOrigin(0),this.boundingBox.strokeColor=12303291,this.boundingBox.isStroked=!0,this.boundingBox.lineWidth=2,this.text=e.add.bitmapText(i+a/2,s+r/2,n,t,o,1).setOrigin(.5)}setVisible(e){this.boundingBox.setVisible(e),this.text.setVisible(e)}destroy(){this.boundingBox.destroy(),this.text.destroy()}}var r=5,n=100,o=101,h=102,l=103,c=104,d=105,u=106,g=107,m=108,p=109,y=110,v=0,b=1,f=2,x=3,w=4,k=5,C=0,T=1,M=2,B=3,D=4,H=5,R=["Wood","Leather","Metal","Fiber","Stone","Crystal"],L=0,S=1,_=2,P=.66,I=.4,E=1,A=7,G=7,U=5,Y=.1,q=.2,O=.01,W=.01,F=.025,V=.5,N=.03,X=.83,j=.75,K=1.1,z=1.027,Q=50,J=50,Z=2,$=400,ee=1.2,te=.0025,ie=80,se=.75,ae=8e4,re=13,ne=8,oe=2500,he=.5,le=1.03,ce=.15,de=10,ue=4,ge=1.66,me=1.5,pe=50,ye=6e4,ve=12e4,be=1e3,fe=100,xe=.9,we=90,ke=3600,Ce=2,Te=.95,Me=1.5,Be=["Primas","Twin","Threed","Tera","Pentas","Hexat","Septus","Octor","Novum","Deccan","Hendeka","Dodecan","Zenith"],De=1e3,He=24e3,Re=672e3,Le=8736e3,Se=6e4,_e={"0001":0,"0010":1,"0011":2,"0100":3,"0101":4,"0110":5,"0111":6,1e3:7,1001:8,1010:9,1011:10,1100:11,1101:12,1110:13,1111:14};class Pe{static getDistance(e,t,i,s){return Math.sqrt(Math.pow(i-e,2)+Math.pow(s-t,2))}static randint(e,t){return Math.floor(e+Math.random()*(t-e))}static pointInList(e,t,i){for(var s=0;s<i.length;s++)if(i[s].x===e&&i[s].y===t)return!0;return!1}static numberString(e){var t=new Intl.NumberFormat("en-US").format(e);return t.length>=16?t=t.substr(0,t.length-12)+"B":t.length>=12?t=t.substr(0,t.length-8)+"M":t.length>=9&&(t=t.substr(0,t.length-4)+"K"),t}static nearestPointsInList(e,t,i,s){for(var a=[],r=0;r<i.length;r++)a.push([r,Pe.getDistance(e,t,i[r].x,i[r].y)]);return a.sort((function(e,t){return e[1]-t[1]})),a.slice(0,s)}static nearestPointInList(e,t,i,s=!1){for(var a=0,r=this.getDistance(e,t,i[0].x,i[0].y),n=1;n<i.length;n++){var o=this.getDistance(e,t,i[n].x,i[n].y);if(o<r){if(!0===s&&0===o)continue;a=n,r=o}}return[a,r]}static sumList(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t}static canCraft(e,t){for(var i=0;i<t.length;i++)if(t[i]<e[i])return!1;return!0}static getBonusText(e,t){switch(e){case"health":return"+ "+Math.floor(t)+" Health";case"damageMin":return"+ "+Math.floor(t)+" Min Damage";case"damageMax":return"+ "+Math.floor(t)+" Max Damage";case"strength":return"+ "+Math.floor(t)+" Strength";case"dexterity":return"+ "+Math.floor(t)+" Dexterity";case"agility":return"+ "+Math.floor(t)+" Agility";case"endurance":return"+ "+Math.floor(t)+" Endurance";case"recovery":return"+ "+Math.floor(t)+" Recovery";case"defense":return"+ "+Math.floor(t)+" Defense";case"accuracy":return"+ "+Math.floor(t)+" Accuracy";case"hit":return"+ "+Math.floor(t)+" Hit";case"evasion":return"+ "+Math.floor(t)+" Evasion";case"critDamage":return"+ "+Math.floor(100*t)+"% Crit Damage";case"critChance":return"+ "+Math.floor(100*t)+"% Crit Chance";case"healthRegen":return"+ "+Math.floor(10*t)/10+"/s Health Regen";case"armor":return"+ "+Math.floor(t)+" Armor"}}static getCostText(e,t){switch(e){case 0:return Pe.numberString(Math.floor(t))+" Wood";case 1:return Pe.numberString(Math.floor(t))+" Leather";case 2:return Pe.numberString(Math.floor(t))+" Metal";case 3:return Pe.numberString(Math.floor(t))+" Fiber";case 4:return Pe.numberString(Math.floor(t))+" Stone";case 5:return Pe.numberString(Math.floor(t))+" Crystal"}}static processText(e,t){for(var i=e.split("\n"),s="",a=0;a<i.length;a++)if(i[a].length<t)s+=i[a]+(a<i.length-1?"\n":"");else{for(var r=0,n=t;n<i[a].length;){for(;n>r&&" "!==i[a][n];)n--;s+=i[a].substring(r,n)+"\n",r=n+1,n=Math.min(r+t,i[a].length)}r<i[a].length&&(s+=i[a].substring(r,i[a].length)),a!==i.length-1&&(s+="\n")}return s}static colorLerp(e,t,i){var s=Phaser.Display.Color.IntegerToRGB(e),a=Phaser.Display.Color.IntegerToRGB(t);return Phaser.Display.Color.GetColor(s.r+(a.r-s.r)*i,s.g+(a.g-s.g)*i,s.b+(a.b-s.b)*i)}static yieldHelper(e,t){for(var i=0,s=0;s<t.length;s++)if(t[s].type===e){i=t[s].rate;break}return i}}class Ie{constructor(){return Ie.instance||(this.moonlight=0,this.challengePoints=0,this.moonperks={str:{name:"Moon's Strength",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:0}},dex:{name:"Moon's Dexterity",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:1}},agi:{name:"Moon's Agility",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:2}},end:{name:"Moon's Endurance",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:3}},rec:{name:"Moon's Recovery",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:4}},def:{name:"Moon's Defense",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:5}},acc:{name:"Moon's Accuracy",level:0,maxLevel:-1,requires:[],cost:[10,2,1.025],texture:{sprite:"moonicons",tile:6}},vault:{name:"Hero's Vault",level:0,maxLevel:-1,requires:[],cost:[60,30,1.25],texture:{sprite:"moonicons",tile:9}},nightmarket:{name:"Night Market",level:0,maxLevel:-1,requires:[],cost:[35,45,1.05],texture:{sprite:"moonicons",tile:22}},hardenedvillagers:{name:"Hardened Villagers",level:0,maxLevel:5,requires:[],cost:[40,25,1.5],texture:{sprite:"moonicons",tile:11}},shadow:{name:"Shadow's Blessing",level:0,maxLevel:-1,requires:[],cost:[10,10,1.125],texture:{sprite:"moonicons",tile:12}},runes:{name:"Moon Runes",level:0,maxLevel:1,requires:[],cost:[1e3,0,0],texture:{sprite:"moonicons",tile:8}},direbeasts:{name:"Dire Beasts",level:0,maxLevel:1,requires:[],cost:[250,0,0],texture:{sprite:"moonicons",tile:13}},heartofdarkness:{name:"Heart of Darkness",level:0,maxLevel:-1,requires:[],cost:[100,100,1.25],texture:{sprite:"moonicons",tile:10}},blackirongear:{name:"Blackiron Gear",level:0,maxLevel:-1,requires:["heartofdarkness"],cost:[30,100,1.25],texture:{sprite:"moonicons",tile:10}},runelands:{name:"Runelands",level:0,maxLevel:-1,requires:["runes"],cost:[500,0,1.5],texture:{sprite:"moonicons",tile:8}},moonlightworkers:{name:"Moonlight Workers",level:0,maxLevel:-1,requires:["hardenedvillagers"],cost:[100,100,1.2],texture:{sprite:"moonicons",tile:19}},heropouch:{name:"Hero's Pouch",level:0,maxLevel:-1,requires:["vault"],cost:[35,45,1.05],texture:{sprite:"moonicons",tile:9}},moonwine:{name:"Moonwine",level:0,maxLevel:2,requires:["nightmarket"],cost:[500,0,5],texture:{sprite:"moonicons",tile:14}}},this.challenges={time:{name:"A Matter of Years",completions:0,maxCompletions:10,unlocked:!0,fastestTime:0},forge:{name:"Forged Ahead",completions:0,maxCompletions:10,unlocked:!1,fastestTime:0},explore:{name:"Vast Continent",completions:0,maxCompletions:10,unlocked:!1,fastestTime:0},buildings:{name:"Forgotten Labor",completions:0,maxCompletions:10,unlocked:!1,fastestTime:0},talent:{name:"Talentless",completions:0,maxCompletions:10,unlocked:!1,fastestTime:0}},Ie.instance=this),Ie.instance}getChallengeFromName(e){switch(e){case"A Matter of Years":return this.challenges.time;case"Forged Ahead":return this.challenges.forge;case"Vast Continent":return this.challenges.explore;case"Forgotten Labor":return this.challenges.buildings;case"Talentless":return this.challenges.talent}}static getMoonlightEarned(e,t){return Math.floor(e*Math.pow(Me,t))}save(){var e=[];for(const t in this.moonperks)e.push([t,this.moonperks[t].level]);var t=[];for(const e in this.challenges)t.push([e,this.challenges[e].completions,this.challenges[e].unlocked,this.challenges[e].fastestTime]);return{ml:this.moonlight,mp:e,cp:this.challengePoints,c:t}}load(e,t){this.moonlight=e.ml;for(var i=0;i<e.mp.length;i++)this.moonperks[e.mp[i][0]].level=e.mp[i][1];this.challengePoints=e.cp;for(i=0;i<e.c.length;i++)this.challenges[e.c[i][0]].completions=e.c[i][1],this.challenges[e.c[i][0]].unlocked=e.c[i][2],this.challenges[e.c[i][0]].fastestTime=e.c[i][3]}}class Ee{constructor(){return Ee.instance||(this.unlocks={gearTab:!1,exploreTab:!1,combatTab:!1,townTab:!1,talentsTab:!1,worldTab:!1,infuseUI:!1,resourceUI:!1,craftingUI:!1,buildings:!1,motes:!1},this.exploreUnlocks=[{count:1,text:"Well that's everything I can see in this area. If I want to keep searching I'll need to leave this weirdly square land and find another square to explore. You think you saw a town in the distance towards the north, but you could be seeing things."},{count:5,text:"You've seen a lot of what this world has to offer by now, and most of it wants to kill you. The people in the town seem nice though, and many of them have been wanting some way to help out. With the lands sort of safe to walk again they can get back to working.\n\nThe only problem is they don't have anything to build with so they want you to bring them some from the monsters you've been killing."},{count:10,text:"Your surprised at how easy this has been going. Sure, every day is a new battle for your life against horrible shadow monsters, but the tile's you've cleared seem way more vibrant and full of life.\n\nSome of the townsfolk have been worried that the mists will return but the odds of that happening have got to be astronomically low. Just to get them off your back you told them to give you some kind of alert on the Region tab if something goes wrong. Hah! Like that will ever happen."},{count:30,text:"From what the townsfolk have told me there's a barrier preventing people from leaving this region. I wonder what happens after I explore every tile there is to explore?"},{count:70,text:"How many years has it been since I started this journey? All the days sort of melt together into one long blur of monster slaying. You swear it's only been like, 1, 2 days tops though."}],this.killUnlocks=[{count:1,text:"What the hell was that? It looked like a normal beast, but like, made of shadows? Is this whole land filled with these monsters?"},{count:5,text:"You're starting to get the hang of this, although your starting to wonder what happened to the previous owner of this gear..."},{count:100,text:"You did it, you've killed your 100th monster. This accomplishment fills you with pride for a moment before you shrug and move onto the next one."}],this.shadeUnlocks=[{count:50,text:"These strange monsters have been leaving behind these shadowy.. things. I think I'll call them shade. It's strange, but I'm pretty sure it wants me to do something with it."},{count:400,text:"Now that I've collected enough of this shade stuff, I think I can do something even better with it, I just need enough of it all in one place."},{count:5e3,text:"I've found a load of this shade stuff, where is it all coming from?"}],this.resourceUnlocks=[{count:25,text:"I've noticed some monsters leave behind more than just shadows. things like wood, stone and metal.... Definitely things they shouldn't have inside them. You have enough now that you could try and improve your gear with them. Slapping some metal onto the end of your sword should do the trick."},{count:100,text:"You have so many resources your not sure what to do with them. Maybe its time to try your hand at making some new gear? You've strapped enough garbage around your broken sword that it's more of a club now then anyhting. You don't have a forge or tools, but it can't be harder than upgrading your gear."},{count:1e3,text:"So let me get this straight. It costs, what, 30-40 resources to craft a sword, but hundreds to make it a little sharper? The townsfolk assure me this is normal, but I'm starting to think they just want me to bring them free resources."}],this.statPointUnlocks=[{count:1,text:"You finally got enough of that shade to try something. You grab a handful of the stuff and try squeezing it into a ball only to find it slip from your hands and enter your chest! You look around and see '+1 Stat Point' appear above your head. You're not sure what that means, but you feel stronger than you did before! You're pretty sure you'll need even more shade to do this again, but at least you found one use for it."},{count:25,text:"You're not entirely sure what this shade is doing, but boy do you feel strong!"},{count:50,text:"You've been infusing a lot of shade lately, is there a limit to how much your body can take?"},{count:100,text:"doesn't seem like it. At least 100 isn't the limit."},{count:300,text:"I've lost count. By all measures my abilities shouldn't be humanly possible, yet I'm still finding monsters stronger than me."}],this.deathUnlocks=[{count:1,text:"It was bound to happen eventually, you're not exactly adventurer material. You open your eyes, wondering where the next stage of existence will take you... and it looks like, wilderness? Wait a minute, you know this place! This is where you died! Or not? You pick yourself up and dust off your clothes, turns out your injuries aren't as bad as you thought.\n\nLooking over your gear it seems you lost some of your shade, is that what those things were after?"},{count:5,text:"I guess I should be happy these things aren't killing me, but getting knocked out this many times can't be good for me."},{count:12,text:"I feel like I'm not paying enough attention, wandering around thinking about what I should do next, how my gear is doing, then suddenly BAM! Ambushed by a literal whale and knocked unconscious."}],this.loreUnlocks={},this.loreTexts={},this.exploresUnlocked=0,this.killsUnlocked=0,this.shadesUnlocked=0,this.resourceUnlocked=0,this.statPointUnlocked=0,this.deathUnlocked=0,this.counts={tilesExplored:0,monsterKills:0,shadeGained:0,resourcesGained:0,statPointsGained:0,deaths:0},this.persistentUnlocks={challenges:!1,autoExplore:!1},this.totalCounts={tilesExplored:0,monsterKills:0,shadeGained:0,resourcesGained:0,statPointsGained:0,deaths:0,timesGated:0},this.onUnlockHandlers=[],Ee.instance=this),Ee.instance}rebirth(){this.unlocks={gearTab:!1,exploreTab:!1,combatTab:!1,townTab:!1,talentsTab:Ie.instance.challenges.talent.completions>0,worldTab:!1,infuseUI:!1,resourceUI:!1,craftingUI:!1,buildings:!1,motes:!1},this.exploresUnlocked=0,this.killsUnlocked=0,this.shadesUnlocked=0,this.resourceUnlocked=0,this.statPointUnlocked=0,this.deathUnlocked=0,this.counts={tilesExplored:0,monsterKills:0,shadeGained:0,resourcesGained:0,statPointsGained:0,deaths:0},this.totalCounts.timesGated+=1,this.persistentUnlocks.autoExplore=!0}_onUnlock(e,t,i){for(var s=0;s<this.onUnlockHandlers.length;s++)this.onUnlockHandlers[s](e,t,i)}addOnUnlockHandler(e){this.onUnlockHandlers.push(e)}registerTileExplored(){this.counts.tilesExplored+=1,this.totalCounts.tilesExplored+=1;for(var e=this.exploresUnlocked;e<this.exploreUnlocks.length;e++)this.exploreUnlocks[e].count<=this.counts.tilesExplored&&(this._onUnlock(v,this.exploreUnlocks[e].count,this.exploreUnlocks[e].text),this.exploresUnlocked=e+1)}registerMonsterKill(){this.counts.monsterKills+=1,this.totalCounts.monsterKills+=1;for(var e=this.killsUnlocked;e<this.killUnlocks.length;e++)this.killUnlocks[e].count<=this.counts.monsterKills&&(this._onUnlock(b,this.killUnlocks[e].count,this.killUnlocks[e].text),this.killsUnlocked=e+1)}registerShadeGain(e){this.counts.shadeGained+=e,this.totalCounts.shadeGained+=e;for(var t=this.shadesUnlocked;t<this.shadeUnlocks.length;t++)this.shadeUnlocks[t].count<=this.counts.shadeGained&&(this._onUnlock(f,this.shadeUnlocks[t].count,this.shadeUnlocks[t].text),this.shadesUnlocked=t+1)}registerResourceGain(e){this.counts.resourcesGained+=Pe.sumList(e),this.totalCounts.resourcesGained+=Pe.sumList(e);for(var t=this.resourceUnlocked;t<this.resourceUnlocks.length;t++)this.resourceUnlocks[t].count<=this.counts.resourcesGained&&(this._onUnlock(x,this.resourceUnlocks[t].count,this.resourceUnlocks[t].text),this.resourceUnlocked=t+1)}registerStatPointGain(e){this.counts.statPointsGained+=e,this.totalCounts.statPointsGained+=e;for(var t=this.statPointUnlocked;t<this.statPointUnlocks.length;t++)this.statPointUnlocks[t].count<=this.counts.statPointsGained&&(this._onUnlock(w,this.statPointUnlocks[t].count,this.statPointUnlocks[t].text),this.statPointUnlocked=t+1)}registerDeath(e){this.counts.deaths+=e,this.totalCounts.deaths+=e;for(var t=this.deathUnlocked;t<this.deathUnlocks.length;t++)this.deathUnlocks[t].count<=this.counts.deaths&&(this._onUnlock(k,this.deathUnlocks[t].count,this.deathUnlocks[t].text),this.deathUnlocked=t+1)}registerFeatureUnlocked(e,t){switch(e){case n:this.unlocks.gearTab=!0;break;case o:this.unlocks.exploreTab=!0;break;case h:this.unlocks.combatTab=!0;break;case l:this.unlocks.townTab=!0;break;case m:this.unlocks.talentsTab=!0;break;case c:this.unlocks.infuseUI=!0;break;case d:this.unlocks.resourceUI=!0;break;case u:this.unlocks.craftingUI=!0;break;case g:this.unlocks.buildings=!0;break;case y:this.unlocks.motes=!0;break;case p:this.unlocks.worldTab=!0}this._onUnlock(e,0,t)}save(){return{un:this.unlocks,eun:this.exploresUnlocked,kun:this.killsUnlocked,sun:this.shadesUnlocked,run:this.resourceUnlocked,stun:this.statPointUnlocked,dun:this.deathUnlocked,count:this.counts,tcount:this.totalCounts,pun:this.persistentUnlocks}}load(e,t){this.unlocks=e.un,this.exploresUnlocked=e.eun,this.killsUnlocked=e.kun,this.shadesUnlocked=e.sun,this.resourceUnlocked=e.run,this.statPointUnlocked=e.stun,this.deathUnlocked=e.dun,this.counts=e.count,this.totalCounts=e.tcount,this.persistentUnlocks=e.pun}}class Ae{constructor(e,t,i,s,a,r,n){this.tier=t,this.slotType=i,this.name=e,this.statBonuses=s,this.statsPerLevel=a,this.level=0,this.costs=r,this.costsPerLevel=n,this.motesFused=0}bringToLevel(e){for(var t=this.level;t<e;t++){if(t-1>=0)for(const e in this.statBonuses)this.statBonuses[e]+=this.statsPerLevel[e]*Math.ceil((t+1)/5);for(const e in this.costs)this.costs[e]+=this.costsPerLevel[e]*(t+1)}this.level=e}save(){return{lv:this.level,mote:this.motesFused}}load(e,t){this.bringToLevel(e.lv),this.motesFused=e.mote}}class Ge{constructor(){return Ge.instance||(this.gear=[],this._initGear(),Ge.instance=this),Ge.instance}save(){for(var e=[],t=0;t<this.gear.length;t++)e.push(this.gear[t].save());return{gear:e,ta:this.tiersAvailable,msc:this.moteSoftCap}}load(e,t){for(var i=0;i<e.gear.length;i++)this.gear[i].load(e.gear[i],t);this.tiersAvailable=e.ta,this.moteSoftCap=e.msc}getMotePower(e){return(Math.min(this.moteSoftCap,e)+Math.pow(Math.max(0,e-this.moteSoftCap),se))*te}rebirth(){this._initGear()}getGearByName(e){for(var t=0;t<this.gear.length;t++)if(this.gear[t].name===e)return this.gear[t]}_initGear(){var e=new Ie;this.gear=[],this.tiersAvailable=0,this.moteSoftCap=ie+40*e.moonperks.blackirongear.level;var t={health:0,damageMin:1,damageMax:1,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:.25,damageMax:.5,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,0,0,0,0,0],a=[5,0,10,0,0,0];this.gear.push(new Ae("Broken Sword",0,L,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:1},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:.25},s=[0,0,0,0,0,0],a=[0,10,0,5,0,0];this.gear.push(new Ae("Old Leathers",0,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:1,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:.5,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,0,0,0,0,0],a=[10,0,0,0,5,0];this.gear.push(new Ae("Barrel Lid",0,_,t,i,s,a)),this.gear[0].bringToLevel(1),this.gear[1].bringToLevel(1),this.gear[2].bringToLevel(1);t={health:0,damageMin:2,damageMax:4,strength:0,dexterity:1,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:.05,healthRegen:0,armor:0},i={health:0,damageMin:.75,damageMax:1.5,strength:0,dexterity:1,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[10,0,25,5,0,0],a=[6,0,15,4,0,5];this.gear.push(new Ae("Iron Sword",1,L,t,i,s,a));t={health:0,damageMin:1,damageMax:5,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:.05,critChance:.07,healthRegen:0,armor:0},i={health:0,damageMin:.6,damageMax:1.6,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:.025,critChance:0,healthRegen:0,armor:0},s=[20,0,15,5,0,0],a=[13,0,9,3,0,5];this.gear.push(new Ae("Iron Axe",1,L,t,i,s,a));t={health:0,damageMin:1,damageMax:3,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:15,evasion:5,critDamage:0,critChance:.15,healthRegen:0,armor:0},i={health:0,damageMin:.4,damageMax:.9,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:10,evasion:3,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[5,0,20,10,0,5],a=[3,0,14,8,0,5];this.gear.push(new Ae("Dagger",1,L,t,i,s,a));t={health:0,damageMin:3,damageMax:5,strength:1,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-15,evasion:0,critDamage:0,critChance:.05,healthRegen:0,armor:0},i={health:0,damageMin:1.25,damageMax:2,strength:1,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-7,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[10,10,0,0,0,20],a=[8,8,0,0,0,14];this.gear.push(new Ae("Crystal Hammer",1,L,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:6,evasion:12,critDamage:0,critChance:0,healthRegen:0,armor:1},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:3,evasion:6,critDamage:0,critChance:0,healthRegen:0,armor:.25},s=[0,10,0,30,0,0],a=[0,5,0,20,0,5];this.gear.push(new Ae("Cloak",1,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:1,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:2},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:1,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:.5},s=[0,30,0,10,0,0],a=[0,20,0,5,0,5];this.gear.push(new Ae("Hide Armor",1,S,t,i,s,a));t={health:5,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:-6,critDamage:0,critChance:0,healthRegen:0,armor:3},i={health:3,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:-4,critDamage:0,critChance:0,healthRegen:0,armor:1},s=[0,10,30,0,0,0],a=[0,5,20,0,0,5];this.gear.push(new Ae("Half Plate",1,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:2,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:1},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:1,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:.25},s=[30,0,10,0,0,0],a=[17,0,10,0,0,8];this.gear.push(new Ae("Wooden Shield",1,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:.3,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:.15,armor:0},s=[0,0,10,0,25,5],a=[0,0,7,0,20,8];this.gear.push(new Ae("Warm Stone",1,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:1,agility:1,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:.05,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:.8,agility:.8,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,20,0,10,0,10],a=[0,15,0,7,0,13];this.gear.push(new Ae("Wolf-Tooth Necklace",1,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:1,hit:15,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:1,hit:8,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,15,0,20,0,5],a=[0,10,0,17,0,8];this.gear.push(new Ae("Gloves",1,_,t,i,s,a));t={health:0,damageMin:11,damageMax:18,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-40,evasion:50,critDamage:0,critChance:.12,healthRegen:0,armor:0},i={health:0,damageMin:3.5,damageMax:6,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-14,evasion:20,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[25,0,25,0,0,0],a=[14,0,14,0,0,7];this.gear.push(new Ae("Great Spear",2,L,t,i,s,a));t={health:0,damageMin:9,damageMax:16,strength:1,dexterity:4,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:.12,healthRegen:0,armor:0},i={health:0,damageMin:3,damageMax:4.5,strength:.8,dexterity:1.5,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[15,0,25,10,0,0],a=[9,0,14,5,0,7];this.gear.push(new Ae("Steel Sword",2,L,t,i,s,a));t={health:0,damageMin:5,damageMax:12,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:50,evasion:0,critDamage:.1,critChance:.17,healthRegen:0,armor:0},i={health:0,damageMin:1.75,damageMax:3.5,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:17,evasion:0,critDamage:.04,critChance:0,healthRegen:0,armor:0},s=[5,0,20,15,0,10],a=[4,0,15,9,0,7];this.gear.push(new Ae("Hunting Dagger",2,L,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:30,evasion:75,critDamage:0,critChance:0,healthRegen:0,armor:4},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:14,evasion:27,critDamage:0,critChance:0,healthRegen:0,armor:1},s=[0,15,0,35,0,0],a=[0,9,0,19,0,7];this.gear.push(new Ae("Thief Garb",2,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:4,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:6},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:2,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:1.75},s=[0,35,0,15,0,0],a=[0,19,0,9,0,7];this.gear.push(new Ae("Hunting Leathers",2,S,t,i,s,a));t={health:20,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:-50,critDamage:0,critChance:0,healthRegen:0,armor:9},i={health:5,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:-23,critDamage:0,critChance:0,healthRegen:0,armor:2.5},s=[0,0,35,15,0,0],a=[0,0,19,9,0,7];this.gear.push(new Ae("Full Plate",2,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:2,recovery:0,defense:4,accuracy:6,hit:0,evasion:0,critDamage:0,critChance:.03,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:1,recovery:0,defense:1.5,accuracy:2,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,10,0,0,30,10],a=[0,8,0,0,22,10];this.gear.push(new Ae("Lucky Rock",2,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:5,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:50,critDamage:0,critChance:0,healthRegen:0,armor:1},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:2,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:20,critDamage:0,critChance:0,healthRegen:0,armor:.25},s=[0,30,0,15,0,5],a=[0,19,0,11,0,10];this.gear.push(new Ae("Boots of Speed",2,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:6,accuracy:0,hit:-30,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:1},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:2,accuracy:0,hit:-12,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:.5},s=[0,15,0,10,25,0],a=[0,8,0,6,16,10];this.gear.push(new Ae("Heavy Bracers",2,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:3,dexterity:3,agility:3,endurance:3,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:1.2,dexterity:1.2,agility:1.2,endurance:1.2,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,10,25,0,0,15],a=[0,8,17,0,0,15];this.gear.push(new Ae("Adventurer's Medallion",2,_,t,i,s,a));t={health:0,damageMin:35,damageMax:70,strength:0,dexterity:0,agility:5,endurance:0,recovery:5,defense:0,accuracy:0,hit:-40,evasion:50,critDamage:.2,critChance:.14,healthRegen:0,armor:0},i={health:0,damageMin:8,damageMax:15,strength:0,dexterity:0,agility:2,endurance:0,recovery:2,defense:0,accuracy:0,hit:-14,evasion:20,critDamage:.08,critChance:0,healthRegen:0,armor:0},s=[0,10,35,0,20,0],a=[0,7,17,0,11,10];this.gear.push(new Ae("Thunder Spear",3,L,t,i,s,a));t={health:0,damageMin:31,damageMax:64,strength:0,dexterity:7,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:155,evasion:0,critDamage:0,critChance:.14,healthRegen:0,armor:0},i={health:0,damageMin:7,damageMax:11,strength:0,dexterity:2.5,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:46,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[15,0,40,0,0,10],a=[8,0,22,0,0,15];this.gear.push(new Ae("Ardent Blade",3,L,t,i,s,a));t={health:0,damageMin:22,damageMax:30,strength:14,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:50,evasion:0,critDamage:.1,critChance:.17,healthRegen:0,armor:0},i={health:0,damageMin:4.5,damageMax:8,strength:5,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:17,evasion:0,critDamage:.04,critChance:0,healthRegen:0,armor:0},s=[0,25,25,15,0,0],a=[0,15,15,5,0,10];this.gear.push(new Ae("Dire Claw",3,L,t,i,s,a));t={health:0,damageMin:2,damageMax:5,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:170,critDamage:0,critChance:0,healthRegen:0,armor:12},i={health:0,damageMin:1,damageMax:2.25,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:57,critDamage:0,critChance:0,healthRegen:0,armor:3},s=[0,20,0,45,0,0],a=[0,10,0,25,0,10];this.gear.push(new Ae("Assassin Cloak",3,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:4,recovery:7,defense:0,accuracy:0,hit:100,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:19},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:1.5,recovery:3,defense:0,accuracy:0,hit:36,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:4.25},s=[0,45,0,20,0,0],a=[0,25,0,10,0,10];this.gear.push(new Ae("Beastmaster Vest",3,S,t,i,s,a));t={health:40,damageMin:0,damageMax:0,strength:4,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-30,evasion:-160,critDamage:0,critChance:0,healthRegen:0,armor:26},i={health:13,damageMin:0,damageMax:0,strength:1.5,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:-11,evasion:-48,critDamage:0,critChance:0,healthRegen:0,armor:6},s=[0,20,45,0,0,0],a=[0,10,25,0,0,10];this.gear.push(new Ae("Lizardscale Armor",3,S,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:11,agility:0,endurance:0,recovery:0,defense:0,accuracy:7,hit:0,evasion:0,critDamage:0,critChance:.07,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:4,agility:0,endurance:0,recovery:0,defense:0,accuracy:2.75,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,40,0,15,0,10],a=[0,27,0,10,0,13];this.gear.push(new Ae("Wolf Gloves",3,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:211,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:79,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,0,0,0,35,30],a=[0,0,0,0,24,26];this.gear.push(new Ae("Hyperstone",3,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:10,accuracy:0,hit:0,evasion:-70,critDamage:0,critChance:0,healthRegen:0,armor:5},i={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:3.5,accuracy:0,hit:0,evasion:-24,critDamage:0,critChance:0,healthRegen:0,armor:1},s=[15,10,40,0,0,0],a=[9,6,22,0,0,13];this.gear.push(new Ae("Tower Shield",3,_,t,i,s,a));t={health:0,damageMin:0,damageMax:0,strength:12,dexterity:0,agility:0,endurance:5,recovery:0,defense:0,accuracy:0,hit:-60,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},i={health:0,damageMin:0,damageMax:0,strength:5,dexterity:0,agility:0,endurance:2,recovery:0,defense:0,accuracy:0,hit:-17,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},s=[0,35,0,20,10,0],a=[0,18,0,13,6,13];this.gear.push(new Ae("Ogre Belt",3,_,t,i,s,a))}}class Ue{constructor(){this.stats={strength:5,dexterity:5,agility:5,endurance:5,recovery:5,defense:5,accuracy:5,hit:40,evasion:40,critDamage:1},this.statBonuses={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},this.hitAnim="claws",this.critAnim="clawscrit",this.level=0,this.currentHealth=25,this.attackCooldown=0,this.attackSpeed=1500,this.stunTimer=0,this.name="",this.xpReward=0,this.drops=[],this.motes=0,this.icon={sprite:"enemyicons",tile:8},this.healthChangedHandlers=[],this.attackCooldownChangedHandlers=[]}MaxHealth(){var e=this.statBonuses.health+this.Endurance()*U;return Math.floor(e)}Strength(){var e=this.stats.strength+this.statBonuses.strength;return Math.floor(e)}Dexterity(){var e=this.stats.dexterity+this.statBonuses.dexterity;return Math.floor(e)}Agility(){var e=this.stats.agility+this.statBonuses.agility;return Math.floor(e)}Endurance(){var e=this.stats.endurance+this.statBonuses.endurance;return Math.floor(e)}Recovery(){var e=this.stats.recovery+this.statBonuses.recovery;return Math.floor(e)}Defense(){var e=this.stats.defense+this.statBonuses.defense;return Math.floor(e)}Accuracy(){var e=this.stats.accuracy+this.statBonuses.accuracy;return Math.floor(e)}Hit(){var e=this.stats.hit+this.statBonuses.hit+this.Dexterity()*A;return Math.floor(e)}Evasion(){var e=this.stats.evasion+this.statBonuses.evasion+this.Agility()*G;return Math.floor(e)}CritChance(){var e=this.statBonuses.critChance;return Math.floor(100*e)/100}CritDamage(){var e=this.stats.critDamage+this.statBonuses.critDamage+this.Accuracy()*F;return e=Math.pow(e,X),Math.floor(100*e)/100}DamageMin(){var e=this.statBonuses.damageMin*(1+this.Strength()*W)+this.Strength()*I;return Math.floor(Math.max(1,e))}DamageMax(){var e=this.statBonuses.damageMax*(1+this.Strength()*W)+this.Strength()*E;return Math.floor(Math.max(1,e))}HealthRegen(){var e=this.statBonuses.healthRegen+this.Recovery()*Y;return Math.floor(10*e)/10}Armor(){var e=this.Defense()*q+this.statBonuses.armor*(1+this.Defense()*O);return Math.floor(e)}registerEvent(e,t){"onHealthChanged"===e?this.healthChangedHandlers.push(t):"onAttackCooldownChanged"===e&&this.attackCooldownChangedHandlers.push(t)}_onHealthChanged(){for(var e=0;e<this.healthChangedHandlers.length;e++)this.healthChangedHandlers[e](this.currentHealth)}_onAttackCooldownChanged(){for(var e=0;e<this.attackCooldownChangedHandlers.length;e++)this.attackCooldownChangedHandlers[e](this.attackCooldown)}canAttack(){return this.attackCooldown>=this.attackSpeed}takeDamage(e,t){var i=e;return i=Math.max(1,i-this.Armor()),this.currentHealth-=i,this._onHealthChanged(),i}rollDamage(){return Pe.randint(this.DamageMin(),this.DamageMax()+1)}tickRegen(e,t=!0){var i=this.currentHealth;this.currentHealth=Math.min(this.MaxHealth(),this.currentHealth+this.HealthRegen()*(e/1e3)*1),i!=this.currentHealth&&this._onHealthChanged()}tickAttackCooldown(e,t){if(this.stunTimer>0)this.stunTimer-=e;else{var i=this.attackCooldown;this.attackCooldown=Math.min(this.attackSpeed,this.attackCooldown+e*t),i!=this.attackCooldown&&this._onAttackCooldownChanged()}}attack(e,t=!1){var i=this.rollDamage();!0===t&&(i*=this.CritDamage());var s=e.takeDamage(i,t);return this.attackCooldown=0,this._onAttackCooldownChanged(),s}equip(e){var t=1+(new Ge).getMotePower(e.motesFused);for(const i in this.statBonuses)this.statBonuses[i]+=e.statBonuses[i]*t}unequip(e){var t=1+(new Ge).getMotePower(e.motesFused);for(const i in this.statBonuses)this.statBonuses[i]-=e.statBonuses[i]*t}setMonsterStats(e,t,i,s,a,r,n,o){this.level=a;var h=a-1,l=Math.max(0,h),c=h*K,d=Math.pow(z,l);this.stats.strength=(this.stats.strength+c)*t.strength*d,this.stats.dexterity=(this.stats.dexterity+c)*t.dexterity*d,this.stats.agility=(this.stats.agility+c)*t.agility*d,this.stats.endurance=(this.stats.endurance+c)*t.endurance*d,this.stats.recovery=(this.stats.recovery+c)*t.recovery*d,this.stats.defense=(this.stats.defense+c)*t.defense*d,this.stats.accuracy=(this.stats.accuracy+c)*t.accuracy*d,this.statBonuses.armor=this.Armor()*(t.armor-1),this.statBonuses.healthRegen=this.HealthRegen()*(t.healthRegen-1),this.statBonuses.damageMin=this.DamageMin()*(t.damageMin-1),this.statBonuses.damageMax=this.DamageMax()*(t.damageMax-1),this.statBonuses.hit=this.Hit()*(t.hit-1),this.statBonuses.evasion=this.Evasion()*(t.evasion-1),this.statBonuses.health=this.MaxHealth()*(t.health-1),this.statBonuses.critChance=s,this.attackSpeed=i,this.attackCooldown=0,this.currentHealth=this.MaxHealth(),this.name=a<1?"Weak "+e:e,this.xpReward=r+r/4*h,this.drops=n,this.icon=o}addTemplate(e){switch(e){case"Dire":this.name="Dire "+this.name,this.stats.strength=1.2*this.stats.strength,this.stats.dexterity=1.2*this.stats.dexterity,this.stats.agility=1.2*this.stats.agility,this.stats.endurance=1.2*this.stats.endurance,this.stats.recovery=1.2*this.stats.recovery,this.stats.defense=1.2*this.stats.defense,this.stats.accuracy=1.2*this.stats.accuracy,this.xpReward=2*this.xpReward;for(var t=[],i=0;i<this.drops.length;i++)t.push({type:this.drops[i].type,rate:2*this.drops[i].rate});this.motes+=1+Math.floor(this.level/5)}}}var Ye={};Ye.wolf={name:"Wolf",scaleBlock:{strength:.85,dexterity:1.3,agility:1,endurance:.7,recovery:1,defense:.8,accuracy:1.3,armor:1.4,health:1,healthRegen:1,damageMin:1.3,damageMax:1.33,hit:1,evasion:1.3},attackSpeed:1100,critChance:.3,shadeBase:18,rewards:[{type:C,amount:1},{type:T,amount:1.3},{type:B,amount:.6}],icon:{sprite:"enemyicons",tile:2}},Ye.bear={name:"Bear",scaleBlock:{strength:1.3,dexterity:.8,agility:.8,endurance:1.4,recovery:1.2,defense:1,accuracy:.8,armor:1.7,health:1.2,healthRegen:1,damageMin:.9,damageMax:1.35,hit:1,evasion:1},attackSpeed:1800,critChance:.14,shadeBase:26,rewards:[{type:M,amount:.9},{type:B,amount:1.1},{type:D,amount:1.8}],icon:{sprite:"enemyicons",tile:5}},Ye.plant={name:"Plant",scaleBlock:{strength:.85,dexterity:1.2,agility:1.2,endurance:1.2,recovery:1,defense:1,accuracy:1,armor:1.5,health:.8,healthRegen:1.3,damageMin:1,damageMax:1.125,hit:1.2,evasion:1},attackSpeed:1350,critChance:.1,shadeBase:18,rewards:[{type:C,amount:1.8},{type:B,amount:1},{type:H,amount:.5}],icon:{sprite:"enemyicons",tile:3}},Ye.slime={name:"Slime",scaleBlock:{strength:.825,dexterity:1,agility:1.2,endurance:1,recovery:1.2,defense:.8,accuracy:.8,armor:1.2,health:1,healthRegen:2.3,damageMin:1,damageMax:1.05,hit:1,evasion:1.2},attackSpeed:1200,critChance:.1,shadeBase:15,rewards:[{type:C,amount:1},{type:M,amount:1.2},{type:D,amount:.8},{type:H,amount:1.4}],icon:{sprite:"enemyicons",tile:0}},Ye.bloom={name:"Bloom",scaleBlock:{strength:1,dexterity:1.4,agility:.6,endurance:1,recovery:1.2,defense:1,accuracy:.6,armor:1.4,health:1,healthRegen:1.4,damageMin:1.1,damageMax:1.1,hit:1,evasion:1.2},attackSpeed:1100,critChance:.17,shadeBase:16,rewards:[{type:C,amount:.8},{type:T,amount:.8},{type:B,amount:1.6}],icon:{sprite:"enemyicons",tile:4}},Ye.goblin={name:"Goblin",scaleBlock:{strength:.72,dexterity:1.2,agility:1.6,endurance:.8,recovery:.8,defense:1,accuracy:1.4,armor:1,health:1,healthRegen:.8,damageMin:1.3,damageMax:1.4,hit:.9,evasion:1.2},attackSpeed:1200,critChance:.4,shadeBase:14,rewards:[{type:C,amount:1.2},{type:M,amount:1.4},{type:H,amount:.6}],icon:{sprite:"enemyicons",tile:12}},Ye.formation={name:"Formation",scaleBlock:{strength:1.1,dexterity:1.1,agility:.8,endurance:1.1,recovery:1.1,defense:1.1,accuracy:1.1,armor:2.5,health:1,healthRegen:1,damageMin:1.1,damageMax:1.1,hit:1.1,evasion:1.1},attackSpeed:1300,critChance:.11,shadeBase:24,rewards:[{type:M,amount:1.6},{type:D,amount:1.8},{type:H,amount:2.2}],icon:{sprite:"enemyicons",tile:10}},Ye.whale={name:"Whale",scaleBlock:{strength:1.5,dexterity:.85,agility:.55,endurance:1.5,recovery:1.5,defense:.8,accuracy:.8,armor:1.4,health:1.5,healthRegen:1.5,damageMin:1.5,damageMax:1.55,hit:1,evasion:1},attackSpeed:2300,critChance:.1,shadeBase:32,rewards:[{type:C,amount:2.4},{type:T,amount:2},{type:M,amount:1.4}],icon:{sprite:"enemyicons",tile:6}},Ye.fish={name:"Fish",scaleBlock:{strength:.9,dexterity:1.1,agility:1.4,endurance:1,recovery:.8,defense:1.2,accuracy:1,armor:1.3,health:1,healthRegen:1,damageMin:1,damageMax:1.1,hit:1,evasion:1.3},attackSpeed:1100,critChance:.17,shadeBase:18,rewards:[{type:T,amount:1.4},{type:B,amount:1.1},{type:H,amount:.8}],icon:{sprite:"enemyicons",tile:7}},Ye.lizard={name:"Lizard",scaleBlock:{strength:1.5,dexterity:1.4,agility:.7,endurance:1.3,recovery:.6,defense:1.4,accuracy:1,armor:1.8,health:1.3,healthRegen:1,damageMin:1.15,damageMax:1.15,hit:1.1,evasion:1.2},attackSpeed:1600,critChance:.14,shadeBase:28,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:13}},Ye.gateguardian={name:"Gate Guardian",scaleBlock:{strength:1.65,dexterity:1.1,agility:.8,endurance:1.5,recovery:1.5,defense:1,accuracy:.6,armor:2.5,health:1.2,healthRegen:1,damageMin:1.2,damageMax:1.3,hit:1,evasion:1},attackSpeed:1900,critChance:.19,shadeBase:40,rewards:[{type:C,amount:1},{type:T,amount:1},{type:M,amount:1},{type:B,amount:1},{type:D,amount:1},{type:H,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.elk={name:"Elk",scaleBlock:{strength:1.1,dexterity:1.5,agility:1.2,endurance:1.2,recovery:.7,defense:1,accuracy:.5,armor:1.5,health:1.15,healthRegen:1,damageMin:1,damageMax:1.2,hit:1,evasion:1},attackSpeed:1500,critChance:.15,shadeBase:20,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:1}},Ye.drake={name:"Drake",scaleBlock:{strength:1.4,dexterity:1.1,agility:1.1,endurance:1.5,recovery:1,defense:1.5,accuracy:1,armor:1.8,health:1,healthRegen:1,damageMin:1.25,damageMax:1.35,hit:1,evasion:1.2},attackSpeed:1750,critChance:.17,shadeBase:36,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.cactus={name:"Cactus",scaleBlock:{strength:.9,dexterity:1.2,agility:.7,endurance:.9,recovery:1.3,defense:1.3,accuracy:1,armor:1.9,health:1.2,healthRegen:1.5,damageMin:.9,damageMax:1.05,hit:1,evasion:.9},attackSpeed:1400,critChance:.31,shadeBase:24,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:11}},Ye.moss={name:"Moss",scaleBlock:{strength:1.3,dexterity:1.2,agility:1,endurance:1.2,recovery:1.5,defense:1.8,accuracy:1,armor:1.5,health:1,healthRegen:1.5,damageMin:1.1,damageMax:1.2,hit:1,evasion:.9},attackSpeed:1750,critChance:.21,shadeBase:34,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.lion={name:"Lion",scaleBlock:{strength:1.4,dexterity:.9,agility:1.4,endurance:1.5,recovery:1,defense:1.1,accuracy:1.4,armor:1.4,health:1.3,healthRegen:.9,damageMin:1.3,damageMax:1.5,hit:1,evasion:1.1},attackSpeed:2200,critChance:.21,shadeBase:34,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.gnoll={name:"Gnoll",scaleBlock:{strength:1.1,dexterity:1.5,agility:1.2,endurance:1.1,recovery:.5,defense:1,accuracy:1.2,armor:2,health:1.1,healthRegen:1,damageMin:1.2,damageMax:1.3,hit:1,evasion:1},attackSpeed:1300,critChance:.1,shadeBase:26,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.coyote={name:"Coyote",scaleBlock:{strength:1,dexterity:1.5,agility:1.4,endurance:1,recovery:1,defense:.8,accuracy:1.6,armor:1.3,health:1.1,healthRegen:1,damageMin:1.15,damageMax:1.2,hit:1.1,evasion:1},attackSpeed:1200,critChance:.25,shadeBase:26,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}},Ye.catfish={name:"Catfish",scaleBlock:{strength:1.2,dexterity:1.1,agility:1.7,endurance:1,recovery:1,defense:1.2,accuracy:1.3,armor:1.2,health:1,healthRegen:1,damageMin:.95,damageMax:1.2,hit:1.2,evasion:1},attackSpeed:1150,critChance:.27,shadeBase:24,rewards:[{type:T,amount:2},{type:B,amount:1.6},{type:D,amount:1}],icon:{sprite:"enemyicons",tile:9}};class qe{static GetCreatureByName(e,t){var i=new Ue;return i.setMonsterStats(Ye[e].name,Ye[e].scaleBlock,Ye[e].attackSpeed,Ye[e].critChance,t,Ye[e].shadeBase,Ye[e].rewards,Ye[e].icon),i}}class Oe extends Ue{constructor(e){super(),this.player=e,this.moonData=new Ie}rebirth(){this.stats={strength:5+this.moonData.moonperks.str.level,dexterity:5+this.moonData.moonperks.dex.level,agility:5+this.moonData.moonperks.agi.level,endurance:5+this.moonData.moonperks.end.level,recovery:5+this.moonData.moonperks.rec.level,defense:5+this.moonData.moonperks.def.level,accuracy:5+this.moonData.moonperks.acc.level,hit:40,evasion:40,critDamage:1},this.statBonuses={health:0,damageMin:0,damageMax:0,strength:0,dexterity:0,agility:0,endurance:0,recovery:0,defense:0,accuracy:0,hit:0,evasion:0,critDamage:0,critChance:0,healthRegen:0,armor:0},this.hitAnim="claws",this.critAnim="clawscrit",this.level=0,this.currentHealth=25,this.attackCooldown=0,this.secondWindCooldown=8e4,this.secondWindDuration=1e4,this.hitCounter=0,this.encounterCounter=0}MaxHealth(){var e=this.statBonuses.health+this.Endurance()*U;return e+=this.Endurance()*this.player.talents.end.level,Math.floor(e)}Strength(){var e=this.stats.strength+this.statBonuses.strength;return e*=1+.01*(this.moonData.moonperks.str.level+Ie.instance.challengePoints),Math.floor(e)}Dexterity(){var e=this.stats.dexterity+this.statBonuses.dexterity;return e*=1+.01*(this.moonData.moonperks.dex.level+Ie.instance.challengePoints),Math.floor(e)}Agility(){var e=this.stats.agility+this.statBonuses.agility;return e*=1+.01*(this.moonData.moonperks.agi.level+Ie.instance.challengePoints),Math.floor(e)}Endurance(){var e=this.stats.endurance+this.statBonuses.endurance;return e*=1+.01*(this.moonData.moonperks.end.level+Ie.instance.challengePoints),Math.floor(e)}Recovery(){var e=this.stats.recovery+this.statBonuses.recovery;return e*=1+.01*(this.moonData.moonperks.rec.level+Ie.instance.challengePoints),Math.floor(e)}Defense(){var e=this.stats.defense+this.statBonuses.defense;return e*=1+.01*(this.moonData.moonperks.def.level+Ie.instance.challengePoints),Math.floor(e)}Accuracy(){var e=this.stats.accuracy+this.statBonuses.accuracy;return e*=1+.01*(this.moonData.moonperks.acc.level+Ie.instance.challengePoints),Math.floor(e)}Hit(){var e=this.stats.hit+this.statBonuses.hit+this.Dexterity()*A;return e+=this.Dexterity()*this.player.talents.dex.level,e*=1+.02*this.player.talents.hit.level,Math.floor(e)}Evasion(){var e=this.stats.evasion+this.statBonuses.evasion+this.Agility()*G;return e+=this.Agility()*this.player.talents.agi.level,e*=1+.02*this.player.talents.evasion.level,Math.floor(e)}CritChance(){var e=this.statBonuses.critChance;return e+=.01*this.player.talents.crit.level,Math.floor(100*e)/100}CritDamage(){var e=this.stats.critDamage+this.statBonuses.critDamage+this.Accuracy()*F;return e+=this.Accuracy()*this.player.talents.acc.level*.005,e=Math.pow(e,X),Math.floor(100*e)/100}DamageMin(){var e=this.statBonuses.damageMin*(1+Math.pow(this.Strength(),j)*W)+this.Strength()*I;return e+=this.Strength()*this.player.talents.str.level*.02,Math.floor(Math.max(1,e))}DamageMax(){var e=this.statBonuses.damageMax*(1+Math.pow(this.Strength(),j)*W)+this.Strength()*E;return e+=this.Strength()*this.player.talents.str.level*.05,Math.floor(Math.max(1,e))}HealthRegen(){var e=this.statBonuses.healthRegen+this.Recovery()*Y;return e+=this.Recovery()*this.player.talents.rec.level*.005,Math.floor(10*e)/10}Armor(){var e=this.Defense()*q+this.statBonuses.armor*(1+Math.pow(this.Defense(),j)*O);return e+=this.Defense()*this.player.talents.def.level*.01,Math.floor(e)}takeDamage(e,t){if(this.player.talents.dodge.level>0&&(this.hitCounter-=1,this.hitCounter<=0))return this.hitCounter=re-this.player.talents.dodge.level,0;var i=e;!0===t&&(i=Math.max(2,i-.05*this.Endurance()*this.player.talents.resilient.level)),Math.random()<.05*this.player.talents.parry.level&&(i/=2),i=super.takeDamage(e,t),this.player.talents.secondwind.level>0&&this.secondWindCooldown<0&&this.currentHealth<this.MaxHealth()/2&&(this.secondWindDuration=1e4,this.secondWindCooldown=ae-1e4*this.player.talents.secondwind.level),this.currentHealth<=0&&this.player.talents.defydeath.level>0&&this.encounterCounter<=0&&(this.currentHealth=1,this.encounterCounter=ne-this.player.talents.defydeath.level)}tickRegen(e,t=!0){var i=this.currentHealth,s=1;!1===t&&(s=1+.25*this.player.talents.quickrecovery.level),this.secondWindDuration>0&&(this.secondWindDuration-=e,s*=3),this.currentHealth=Math.min(this.MaxHealth(),this.currentHealth+this.HealthRegen()*(e/1e3)*s),i!=this.currentHealth&&this._onHealthChanged()}attack(e,t=!1){Math.random()<.05*this.player.talents.stun.level&&(e.stunTimer=500);var i=this.rollDamage();!0===t&&(i*=this.CritDamage(),Math.random()<.01*this.player.talents.doublecrit.level*this.CritChance()&&(i*=2));var s=e.takeDamage(i,t);return this.attackCooldown=0,Math.random()<.05*this.player.talents.followthrough.level&&(this.attackCooldown=this.attackSpeed/2),this._onAttackCooldownChanged(),s}cleave(e,t=!1){Math.random()<.05*this.player.talents.stun.level&&(e.stunTimer=500);var i=this.Strength()*this.player.talents.cleave.level*.2;return!0===t&&(i*=this.CritDamage(),Math.random()<.01*this.player.talents.doublecrit.level*this.CritChance()&&(i*=2)),e.takeDamage(i,t)}save(){return{stat:this.stats,ha:this.hitAnim,ca:this.critAnim,chp:this.currentHealth,acd:this.attackCooldown}}load(e,t){this.stats=e.stat,this.hitAnim=e.ha,this.critAnim=e.ca,this.currentHealth=e.chp,this.attackCooldown=e.acd}}class We{constructor(){return We.instance||(this.minGateRegion=1,this.regionSize=[9,11],this.regionDifficultyIncrease=20,this.maxGearTier=8,this.maxResourceTier=8,this.buildingsAllowed=!0,this.gearAllowed=!0,this.gearCostMulti=1,this.maxRunTime=-1,this.exploreSpeed=1,this.talentsEnabled=!0,this.challengeName="",We.instance=this),We.instance}reset(){this.minGateRegion=1,this.regionSize=[9,11],this.regionDifficultyIncrease=20,this.maxGearTier=8,this.maxResourceTier=8,this.buildingsAllowed=!0,this.gearAllowed=!0,this.gearCostMulti=1,this.maxRunTime=-1,this.exploreSpeed=1,this.talentsEnabled=!0,this.challengeName=""}setupChallenge(e){switch(this.reset(),this.challengeName=e.name,e.name){case"A Matter of Years":this.minGateRegion=1,this.maxRunTime=Le*(10-e.completions);case"Forged Ahead":this.minGateRegion=1,this.gearCostMulti=10+5*e.completions;case"Vast Continent":this.minGateRegion=e.completions,this.exploreSpeed=.04;case"Forgotten Labor":this.minGateRegion=e.completions,this.buildingsAllowed=!1;case"Talentless":this.minGateRegion=e.completions,this.talentsEnabled=!1}}save(){return{mgr:this.minGateRegion,rs:this.regionSize,rdi:this.regionDifficultyIncrease,mgt:this.maxGearTier,mrt:this.maxResourceTier,ba:this.buildingsAllowed,ga:this.gearAllowed,gcm:this.gearCostMulti,mrun:this.maxRunTime,es:this.exploreSpeed,te:this.talentsEnabled,cn:this.challengeName}}load(e){this.minGateRegion=e.mgr,this.regionSize=e.rs,this.regionDifficultyIncrease=e.rdi,this.maxGearTier=e.mgt,this.maxResourceTier=e.mrt,this.buildingsAllowed=e.ba,this.gearAllowed=e.ga,this.gearCostMulti=e.gcm,this.maxRunTime=e.mrun,this.exploreSpeed=e.es,this.talentsEnabled=e.te,this.challengeName=e.cn}}class Fe{constructor(){return Fe.instance||(this.statBlock=new Oe(this),this.shade=0,this.statPoints=3,this.talentPoints=0,this.statLevel=1,this.talentLevel=1,this.nextStatCost=Q,this.nextTalentCost=$,this.resources=[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0]],this.resourceTierReached=0,this.statChangedHandlers=[],this.resourceChangedHandlers=[],this.talentChangedHandlers=[],this.craftingCosts=[1,1,1,1,1,1,1,1],this.gold=0,this.motes=0,this.challengeExploreMulti=1,Ie.instance.challenges.explore.completions>0&&(this.challengeExploreMulti=1.25+.1*Ie.instance.challenges.explore.completions),this.weapon=void 0,this.armor=void 0,this.trinket=void 0,this.talents={str:{name:"Strength",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:0}},dex:{name:"Dexterity",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:1}},agi:{name:"Agility",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:2}},end:{name:"Endurance",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:3}},rec:{name:"Recovery",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:4}},def:{name:"Defense",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:5}},acc:{name:"Accuracy",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:6}},cleave:{name:"Cleave",level:0,maxLevel:5,requires:["str"],texture:{sprite:"icons",tile:8}},hit:{name:"Hit",level:0,maxLevel:-1,requires:["dex"],texture:{sprite:"icons",tile:9}},evasion:{name:"Evasion",level:0,maxLevel:-1,requires:["agi"],texture:{sprite:"icons",tile:10}},resilient:{name:"Resilient",level:0,maxLevel:10,requires:["end"],texture:{sprite:"icons",tile:11}},quickrecovery:{name:"Quick Recovery",level:0,maxLevel:12,requires:["rec"],texture:{sprite:"icons",tile:12}},block:{name:"Block",level:0,maxLevel:12,requires:["def"],texture:{sprite:"icons",tile:13}},crit:{name:"Critical",level:0,maxLevel:15,requires:["acc"],texture:{sprite:"icons",tile:14}},stun:{name:"Stunning Hit",level:0,maxLevel:5,requires:["cleave"],texture:{sprite:"icons",tile:16}},followthrough:{name:"Follow Through",level:0,maxLevel:5,requires:["hit"],texture:{sprite:"icons",tile:17}},dodge:{name:"Dodge",level:0,maxLevel:5,requires:["evasion"],texture:{sprite:"icons",tile:18}},defydeath:{name:"Defy Death",level:0,maxLevel:5,requires:["resilient"],texture:{sprite:"icons",tile:19}},secondwind:{name:"Second Wind",level:0,maxLevel:5,requires:["quickrecovery"],texture:{sprite:"icons",tile:20}},parry:{name:"Parry",level:0,maxLevel:5,requires:["block"],texture:{sprite:"icons",tile:21}},doublecrit:{name:"Double Crit",level:0,maxLevel:5,requires:["crit"],texture:{sprite:"icons",tile:22}},bounty:{name:"Bounty",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:7}},explorer:{name:"Explorer",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:15}},guardian:{name:"Guardian",level:0,maxLevel:5,requires:[],texture:{sprite:"icons",tile:39}},governance:{name:"Governance",level:0,maxLevel:10,requires:[],texture:{sprite:"icons",tile:38}}},Fe.instance=this),Fe.instance}rebirth(){this.statBlock.rebirth(),this.shade=0,this.statPoints=3,this.talentPoints=Ie.instance.challenges.talent.completions,this.statLevel=1,this.talentLevel=1,this.nextStatCost=Q,this.nextTalentCost=$,this.resources=[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0]],this.craftingCosts=[1,1,1,1,1,1,1,1];for(var e=0;e<this.craftingCosts.length;e++)this.craftingCosts[e]=this.craftingCosts[e]*We.instance.gearCostMulti,this.craftingCosts[e]=this.craftingCosts[e]*Math.pow(Te,Ie.instance.challenges.forge.completions);this.gold=0,this.motes=0,this.challengeExploreMulti=1,Ie.instance.challenges.explore.completions>0&&(this.challengeExploreMulti=1.25+.1*Ie.instance.challenges.explore.completions),this.weapon=void 0,this.armor=void 0,this.trinket=void 0,this.talents={str:{name:"Strength",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:0}},dex:{name:"Dexterity",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:1}},agi:{name:"Agility",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:2}},end:{name:"Endurance",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:3}},rec:{name:"Recovery",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:4}},def:{name:"Defense",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:5}},acc:{name:"Accuracy",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:6}},cleave:{name:"Cleave",level:0,maxLevel:5,requires:["str"],texture:{sprite:"icons",tile:8}},hit:{name:"Hit",level:0,maxLevel:-1,requires:["dex"],texture:{sprite:"icons",tile:9}},evasion:{name:"Evasion",level:0,maxLevel:-1,requires:["agi"],texture:{sprite:"icons",tile:10}},resilient:{name:"Resilient",level:0,maxLevel:10,requires:["end"],texture:{sprite:"icons",tile:11}},quickrecovery:{name:"Quick Recovery",level:0,maxLevel:12,requires:["rec"],texture:{sprite:"icons",tile:12}},block:{name:"Block",level:0,maxLevel:12,requires:["def"],texture:{sprite:"icons",tile:13}},crit:{name:"Critical",level:0,maxLevel:15,requires:["acc"],texture:{sprite:"icons",tile:14}},stun:{name:"Stunning Hit",level:0,maxLevel:5,requires:["cleave"],texture:{sprite:"icons",tile:16}},followthrough:{name:"Follow Through",level:0,maxLevel:5,requires:["hit"],texture:{sprite:"icons",tile:17}},dodge:{name:"Dodge",level:0,maxLevel:5,requires:["evasion"],texture:{sprite:"icons",tile:18}},defydeath:{name:"Defy Death",level:0,maxLevel:5,requires:["resilient"],texture:{sprite:"icons",tile:19}},secondwind:{name:"Second Wind",level:0,maxLevel:5,requires:["quickrecovery"],texture:{sprite:"icons",tile:20}},parry:{name:"Parry",level:0,maxLevel:5,requires:["block"],texture:{sprite:"icons",tile:21}},doublecrit:{name:"Double Crit",level:0,maxLevel:5,requires:["crit"],texture:{sprite:"icons",tile:22}},bounty:{name:"Bounty",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:7}},explorer:{name:"Explorer",level:0,maxLevel:-1,requires:[],texture:{sprite:"icons",tile:15}},guardian:{name:"Guardian",level:0,maxLevel:5,requires:[],texture:{sprite:"icons",tile:39}},governance:{name:"Governance",level:0,maxLevel:10,requires:[],texture:{sprite:"icons",tile:38}}}}increaseStat(e,t){var i=Math.min(this.statPoints,t);switch(this.statPoints-=i,e){case"str":this.statBlock.stats.strength+=i;break;case"dex":this.statBlock.stats.dexterity+=i;break;case"agi":this.statBlock.stats.agility+=i;break;case"end":this.statBlock.stats.endurance+=i;break;case"rec":this.statBlock.stats.recovery+=i;break;case"def":this.statBlock.stats.defense+=i;break;case"acc":this.statBlock.stats.accuracy+=i}this._onStatChanged()}_onStatChanged(){for(var e=0;e<this.statChangedHandlers.length;e++)this.statChangedHandlers[e]()}_onResourcesChanged(){for(var e=0;e<this.resourceChangedHandlers.length;e++)this.resourceChangedHandlers[e]()}_onTalentChanged(){for(var e=0;e<this.talentChangedHandlers.length;e++)this.talentChangedHandlers[e]()}registerEvent(e,t){"onStatChanged"===e?this.statChangedHandlers.push(t):"onResourcesChanged"===e?this.resourceChangedHandlers.push(t):"onTalentChanged"===e&&this.talentChangedHandlers.push(t)}earnableMoonlight(e){return Ie.getMoonlightEarned(this.statLevel-1+3*(this.talentLevel-1),e)}getStatCost(e){for(var t=0,i=0;i<e;i++)t+=Q+J*(this.statLevel-1+i);return t}getTalentCost(e){for(var t=0,i=Ie.instance.challenges.talent.completions>0?.02:0,s=0;s<e;s++)t+=$*Math.pow(ee-i,this.talentLevel-1+s);return t}buyStat(e){for(var t=0;t<e;t++)this.statPoints+=Z,this.shade-=this.nextStatCost,this.nextStatCost=Q+J*this.statLevel,this.statLevel+=1}buyTalent(e){for(var t=Ie.instance.challenges.talent.completions>0?.02:0,i=0;i<e;i++)this.talentPoints+=1,this.shade-=this.nextTalentCost,this.nextTalentCost=$*Math.pow(ee-t,this.talentLevel),this.talentLevel+=1;this._onTalentChanged()}levelTalent(e){(e.level<e.maxLevel||-1===e.maxLevel)&&(e.level+=1,this.talentPoints-=1,this._onTalentChanged())}addResource(e,t){this.resourceTierReached=Math.max(this.resourceTierReached,t);for(var i=0;i<e.length;i++)this.resources[t][i]+=e[i];this._onResourcesChanged()}spendResource(e,t){for(var i=0;i<e.length;i++)this.resources[t][i]=Math.max(0,this.resources[t][i]-e[i]);this._onResourcesChanged()}addGold(e){var t=new Je;this.gold=Math.min(t.getGoldCap(),this.gold+e),this._onResourcesChanged()}addMote(e){this.motes+=e,this._onResourcesChanged()}equip(e){switch(e.slotType){case L:void 0!==this.weapon&&this.unequip(L),this.weapon=e,this.statBlock.equip(this.weapon);break;case S:void 0!==this.armor&&this.unequip(S),this.armor=e,this.statBlock.equip(this.armor);break;case _:void 0!==this.trinket&&this.unequip(_),this.trinket=e,this.statBlock.equip(this.trinket)}this._onStatChanged()}unequip(e){switch(e){case L:this.statBlock.unequip(this.weapon),this.weapon=void 0;break;case S:this.statBlock.unequip(this.armor),this.armor=void 0;break;case _:this.statBlock.unequip(this.trinket),this.trinket=void 0}this._onStatChanged()}applyForgeUpgrade(e){for(var t=0;t<e;t++)this.craftingCosts[t]=this.craftingCosts[t]*Te}save(){return{stats:this.statBlock.save(),shade:this.shade,sp:this.statPoints,tp:this.talentPoints,spl:this.statLevel,tpl:this.talentLevel,nsp:this.nextStatCost,ntp:this.nextTalentCost,res:this.resources,rtr:this.resourceTierReached,crf:this.craftingCosts,gold:this.gold,mote:this.motes,talents:this.talents,w:void 0===this.weapon?"":this.weapon.name,a:void 0===this.armor?"":this.armor.name,t:void 0===this.trinket?"":this.trinket.name}}load(e,t){this.statBlock.load(e.stats,t),this.shade=e.shade,this.statPoints=e.sp,this.talentPoints=e.tp,this.statLevel=e.spl,this.talentLevel=e.tpl,this.nextStatCost=e.nsp,this.nextTalentCost=e.ntp,this.resources=e.res,this.resourceTierReached=e.rtr,this.craftingCosts=e.crf,this.gold=e.gold,this.motes=e.mote,this.talents=e.talents;var i=new Ge;""!==e.w&&this.equip(i.getGearByName(e.w)),""!==e.a&&this.equip(i.getGearByName(e.a)),""!==e.t&&this.equip(i.getGearByName(e.t))}}class Ve{static getTechGoldCost(e,t){var i=e.level,s=e.goldCosts[0],a=i*e.goldCosts[1],r=Math.pow(i*e.goldCosts[2],me),n=Math.pow(ge,t-1);return 5*Math.floor((s+a+r)/5*n)}static getTechResourceCost(e,t){for(var i=e.level,s=[],a=0;a<e.resources.length;a++){var r=e.resources[a][0],n=i*e.resources[a][1],o=Math.pow(i*e.resources[a][2],me),h=Math.pow(ge,t-1);s.push(5*Math.floor((r+n+o)/5*h))}return s}constructor(e){var t=new Ie;this.currentPopulation=50,this.maxPopulation=100,this.tavernPopulation=0,this.tier=e,this.economyMulti=1,this.bountyMulti=1,this.productionMulti=1,this.exploreMulti=1,this.townDefenseBonus=0,this.goldCapBonus=100*t.moonperks.heropouch.level,this.baseIncome=he+.1*t.moonperks.vault.level,this.buildingIncome=0,this.townExplored=!1,this.researchEnabled=!1,this.buildings={forge:{name:"Forge",level:0,maxLevel:-1,requires:[],goldCosts:[50,25,15],resources:[[0,0,0],[0,0,0],[10,10,5],[0,0,0],[10,10,5],[0,0,0]]},guilds:{name:"Guilds",level:0,maxLevel:-1,requires:[],goldCosts:[100,50,25],resources:[[0,0,0],[10,10,5],[0,0,0],[10,10,5],[0,0,0],[10,10,5]]},townhall:{name:"Town Hall",level:0,maxLevel:-1,requires:[],goldCosts:[50,30,15],resources:[[15,10,8],[0,0,0],[0,0,0],[0,0,0],[10,10,5],[0,0,0]]}},this.upgrades={reinforcedhouses:{name:"Reinforced Houses",level:0,maxLevel:5,requires:[],goldCosts:[75,75,40],resources:[[0,0,0],[0,0,0],[20,20,10],[0,0,0],[40,40,20],[0,0,0]]},banking:{name:"Banking",level:0,maxLevel:-1,requires:[],goldCosts:[20,20,15],resources:[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[15,15,8],[10,10,5]]},mapmaking:{name:"Map Making",level:0,maxLevel:-1,requires:[],goldCosts:[25,25,15],resources:[[0,0,0],[10,10,5],[0,0,0],[5,5,5],[0,0,0],[0,0,0]]},tavern:{name:"Tavern",level:0,maxLevel:3,requires:[],goldCosts:[250,150,50],resources:[[150,150,40],[0,0,0],[0,0,0],[0,0,0],[100,100,35],[0,0,0]]},market:{name:"Market",level:0,maxLevel:3,requires:[],goldCosts:[400,250,60],resources:[[150,150,30],[75,75,30],[0,0,0],[75,75,30],[100,100,35],[75,75,30]]}}}increaseTechLevel(e){switch(e.level+=1,e.name){case"Forge":for(var t=new Fe,i=0;i<this.tier;i++)t.craftingCosts[i]=t.craftingCosts[i]*Te;break;case"Guilds":this.productionMulti+=.1;break;case"Town Hall":this.bountyMulti+=.1;break;case"Reinforced Houses":this.townDefenseBonus+=1,Je.instance.getCurrentRegion().handleReinforcedHouses();break;case"Banking":this.economyMulti+=.05,this.goldCapBonus+=50;break;case"Map Making":this.exploreMulti+=.1}}increaseMaxPop(e){this.maxPopulation+=e}calculateEconMulti(e){this.economyMulti=1+e+.05*this.upgrades.banking.level}getTownIncome(){var e=new Fe;return(Math.floor(this.currentPopulation)*this.baseIncome+this.buildingIncome)*this.economyMulti*(1+.03*e.talents.governance.level)}getGoldCap(){var e=new Fe;return(this.currentPopulation*de+this.goldCapBonus)*this.economyMulti*(1+.03*e.talents.governance.level)}getMaxPopulation(){return this.maxPopulation+this.tavernPopulation}setTavernPopulation(e){this.tavernPopulation=e}endOfDay(){}endOfWeek(){!0===this.townExplored&&(this.currentPopulation=Math.min(this.getMaxPopulation(),this.currentPopulation*le),(new Fe).addGold(this.getTownIncome()))}save(){var e=[];for(const t in this.buildings)e.push([t,this.buildings[t].level]);var t=[];for(const e in this.upgrades)t.push([e,this.upgrades[e].level]);return{cp:this.currentPopulation,mp:this.maxPopulation,t:this.tier,em:this.economyMulti,bm:this.bountyMulti,pm:this.productionMulti,exm:this.exploreMulti,bi:this.baseIncome,bld:e,up:t,gc:this.goldCapBonus,te:this.townExplored,re:this.researchEnabled}}load(e,t){this.currentPopulation=e.cp,this.maxPopulation=e.mp,this.tier=e.t,this.economyMulti=e.em,this.bountyMulti=e.bm,this.productionMulti=e.pm,this.exploreMulti=e.exm,this.baseIncome=e.bi,this.goldCapBonus=e.gc,this.townExplored=e.te,this.researchEnabled=e.re;for(var i=0;i<e.bld.length;i++)this.buildings[e.bld[i][0]].level=e.bld[i][1];for(i=0;i<e.up.length;i++)this.upgrades[e.up[i][0]].level=e.up[i][1]}}var Ne={TILE_TYPES:{mountain:{name:"Mountains",enemies:["wolf","bear","goblin","formation"],clr:Phaser.Display.Color.GetColor(140,110,0),explorationNeeded:35e3,yields:[{type:C,rate:1.25},{type:M,rate:2.25},{type:D,rate:1.5},{type:H,rate:1}]},drakemountain:{name:"Drake Mountains",enemies:["wolf","bear","goblin","formation","drake"],clr:Phaser.Display.Color.GetColor(130,30,30),explorationNeeded:28e3,yields:[{type:M,rate:2.25},{type:D,rate:2.25},{type:H,rate:1.5}]},forest:{name:"Forest",enemies:["wolf","bear","plant","bloom","slime","goblin"],clr:Phaser.Display.Color.GetColor(0,160,0),explorationNeeded:16e3,yields:[{type:C,rate:1.75},{type:T,rate:1.25},{type:B,rate:1.5}]},wode:{name:"Wode",enemies:["wolf","bear","plant","bloom","slime","elk"],clr:Phaser.Display.Color.GetColor(0,130,30),explorationNeeded:2e4,yields:[{type:C,rate:2.25},{type:T,rate:1},{type:B,rate:1.5},{type:H,rate:.6}]},ancientforest:{name:"Ancient Forest",enemies:["bear","moss","plant","elk","bloom"],clr:Phaser.Display.Color.GetColor(0,90,0),explorationNeeded:24e3,yields:[{type:C,rate:2.5},{type:B,rate:1.25},{type:D,rate:1},{type:H,rate:1}]},plains:{name:"Plains",enemies:["slime","goblin","lizard","bloom"],clr:Phaser.Display.Color.GetColor(20,220,20),explorationNeeded:1e4,yields:[{type:C,rate:.9},{type:T,rate:2.5},{type:B,rate:1.25},{type:D,rate:.75}]},savanna:{name:"Savanna",enemies:["gnoll","lion","coyote","lizard","bloom"],clr:Phaser.Display.Color.GetColor(190,190,60),explorationNeeded:17500,yields:[{type:C,rate:.75},{type:T,rate:1.5},{type:B,rate:2},{type:D,rate:1.25}]},desert:{name:"Desert",enemies:["formation","coyote","slime","cactus"],clr:Phaser.Display.Color.GetColor(220,190,140),explorationNeeded:16e3,yields:[{type:C,rate:.75},{type:D,rate:1.75},{type:H,rate:2}]},hills:{name:"Hills",enemies:["slime","goblin","lizard","bloom","formation"],clr:Phaser.Display.Color.GetColor(130,190,50),explorationNeeded:14e3,yields:[{type:T,rate:1},{type:D,rate:2.75},{type:H,rate:.75}]},plateau:{name:"Plateau",enemies:["elk","goblin","lizard","cactus","wolf"],clr:Phaser.Display.Color.GetColor(200,120,40),explorationNeeded:15e3,yields:[{type:T,rate:3},{type:D,rate:2},{type:B,rate:.75}]},lake:{name:"Lake",enemies:["whale","slime","bear","fish"],clr:Phaser.Display.Color.GetColor(20,40,170),explorationNeeded:3e4,yields:[]},oasis:{name:"Oasis",enemies:["catfish","fish","coyote","cactus"],clr:Phaser.Display.Color.GetColor(0,140,190),explorationNeeded:21e3,yields:[]},swamp:{name:"Swamp",enemies:["lizard","slime","goblin","bloom"],clr:Phaser.Display.Color.GetColor(0,110,90),explorationNeeded:25e3,yields:[{type:C,rate:1},{type:T,rate:1.5},{type:B,rate:2.25},{type:H,rate:.7}]},town:{name:"Town",enemies:["wolf"],clr:Phaser.Display.Color.GetColor(230,230,230),explorationNeeded:10,yields:[]},mysticgate:{name:"Mystic Gate",enemies:["gateguardian"],clr:Phaser.Display.Color.GetColor(153,50,204),explorationNeeded:3e4,yields:[]}},REGION_TYPES:{temperate:{name:"Temperate",points:[{terrain:"mountain",power:[7,12],amount:2},{terrain:"mountain",power:[3,7],amount:3},{terrain:"forest",power:[6,11],amount:2},{terrain:"forest",power:[4,9],amount:1},{terrain:"wode",power:[5,10],amount:2},{terrain:"wode",power:[3,8],amount:2},{terrain:"plains",power:[4,9],amount:5},{terrain:"lake",power:[4,9],amount:3},{terrain:"swamp",power:[3,8],amount:2},{terrain:"swamp",power:[5,10],amount:1},{terrain:"hills",power:[3,8],amount:5}]},mountains:{name:"Mountains",points:[{terrain:"mountain",power:[7,12],amount:3},{terrain:"mountain",power:[3,7],amount:4},{terrain:"forest",power:[4,9],amount:3},{terrain:"wode",power:[5,10],amount:2},{terrain:"wode",power:[3,6],amount:4},{terrain:"plateau",power:[3,7],amount:4},{terrain:"lake",power:[4,9],amount:3},{terrain:"hills",power:[3,8],amount:4},{terrain:"drakemountain",power:[5,8],amount:3}]},desert:{name:"Desert",points:[{terrain:"mountain",power:[3,6],amount:4},{terrain:"forest",power:[3,5],amount:4},{terrain:"plateau",power:[3,6],amount:3},{terrain:"oasis",power:[3,5],amount:3},{terrain:"hills",power:[3,6],amount:3},{terrain:"savanna",power:[3,5],amount:5},{terrain:"desert",power:[7,10],amount:5}]},forest:{name:"Forest",points:[{terrain:"mountain",power:[7,12],amount:2},{terrain:"forest",power:[6,9],amount:4},{terrain:"wode",power:[5,8],amount:3},{terrain:"plains",power:[4,6],amount:2},{terrain:"ancientforest",power:[5,7],amount:4},{terrain:"lake",power:[8,11],amount:2},{terrain:"swamp",power:[4,9],amount:3},{terrain:"hills",power:[3,8],amount:2}]},hills:{name:"Hills",points:[{terrain:"mountain",power:[4,7],amount:1},{terrain:"forest",power:[3,6],amount:3},{terrain:"plateau",power:[3,7],amount:4},{terrain:"plains",power:[4,6],amount:3},{terrain:"lake",power:[6,8],amount:2},{terrain:"savanna",power:[3,5],amount:3},{terrain:"hills",power:[4,7],amount:3}]}}};class Xe{static getBuildingByName(e){switch(e){case"wood":return new je("Lumberyard","wood",1,{sprite:"bldicons",tile:0},[0,5,0,10,15,0],25,5);case"leather":return new je("Hunter's Lodge","leather",1,{sprite:"bldicons",tile:1},[20,0,10,0,0,0],25,5);case"metal":return new je("Mine","metal",1,{sprite:"bldicons",tile:2},[10,0,0,0,15,5],25,5);case"fiber":return new je("Herbalist's Hut","fiber",1,{sprite:"bldicons",tile:3},[15,10,0,0,0,5],25,5);case"stone":return new je("Quarry","stone",1,{sprite:"bldicons",tile:4},[10,0,20,0,0,0],25,5);case"crystal":return new je("Crystal Loom","crystal",1,{sprite:"bldicons",tile:5},[10,0,5,0,15,0],25,5);case"house":return new je("Town House","house",1,{sprite:"bldicons",tile:6},[5,5,5,5,5,0],10,5);case"watchtower":return new je("Watch Tower","watchtower",1,{sprite:"bldicons",tile:7},[25,0,0,0,40,0],40,5);case"market":return new je("Market","market",1,{sprite:"bldicons",tile:32},[20,10,0,10,10,10],50,5);case"tavern":return new je("Tavern","tavern",1,{sprite:"bldicons",tile:33},[20,5,0,15,0,5],50,5);case"road":return new je("Road","road",1,{sprite:"roadicons",tile:0},[5,0,0,0,3,0],5,7);case"docks":return new je("Docks","docks",1,{sprite:"bldicons",tile:34},[15,10,0,0,10,0],50,5);case"town":return new je("Town","town",3,{sprite:"roadicons",tile:38},[15,10,0,0,10,0],50,5)}}}class je{constructor(e,t,i,s,a,r,n){this.name=e,this.regName=t,this.tier=i,this.texture=s,this.resourceCosts=a,this.goldCost=r,this.costMulti=n}increaseCosts(){for(var e=0;e<this.resourceCosts.length;e++)this.resourceCosts[e]=this.resourceCosts[e]*this.costMulti;this.goldCost=this.goldCost*this.costMulti}save(){return{t:this.tier,reg:this.regName}}static loadFromFile(e,t){for(var i=Xe.getBuildingByName(e.reg),s=i.tier;s<=e.t;s++)i.increaseCosts();return i.tier=e.t,i}static getTooltip(e,t,i){var s=Je.instance.getCurrentRegion(),a=1+e.defense*Ie.instance.moonperks.moonlightworkers.level*.01;switch(t){case"Lumberyard":var r=i*Pe.yieldHelper(C,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Wood at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Hunter's Lodge":r=i*Pe.yieldHelper(T,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Leather at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Mine":r=i*Pe.yieldHelper(M,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Metal at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Herbalist's Hut":r=i*Pe.yieldHelper(B,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Fiber at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Quarry":r=i*Pe.yieldHelper(D,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Stone at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Crystal Loom":r=i*Pe.yieldHelper(H,e.yields)*a*e.roadBonus*s.townData.productionMulti;return"Produces "+Math.floor(100*r)/100+" Crystal at the end of each day. Production at "+Math.floor(100*e.roadBonus)+"% based on distance to roads.";case"Town House":return"Increases the Town's max population by "+5*i+".";case"Watch Tower":return"Increases the defense of all tiles within 2 tiles of this watch tower by "+2*i+".";case"Market":var n=Pe.nearestPointInList(e.x,e.y,s.markets,!0),o=Math.max(0,Math.min(10,n[1]/ue*10))*i/100;return"Increases the Town's economy by "+Math.floor(1e4*o)/100+"%, based on distance to the Town and other Markets.";case"Tavern":o=0;for(var h=0,l=Math.max(0,e.y-1);l<Math.min(s.height,e.y+1+1);l++)for(var c=Math.max(0,e.x-1);c<Math.min(s.width,e.x+1+1);c++)Math.abs(l-e.y)+Math.abs(c-e.x)<=1&&void 0!==s.map[l][c].building&&"Town House"===s.map[l][c].building.name&&(o+=.02,h+=1);return"Increases the Town's population by "+h+" and economy by "+Math.floor(i*o*100)+"%, based on nearby Town Houses.";case"Road":return"Most buildings must be built adjacent to roads. Production buildings get a boost being adjacent to a road, and produce nothing when more than "+i+" tiles away.";case"Docks":o=2*i*s.townData.economyMulti;return"Docks don't need roads and enables roads to be built beside them. Increases gold earned per week by "+Math.floor(o)+"."}}}class Ke{constructor(e=65280,t=0,i=0){this.regName="plains",this.explored=!1,this.revealed=!1,this.difficulty=0,this.amountExplored=0,this.isInvaded=!1,this.invasionPower=0,this.invasionFights=0,this.building=void 0,this.fightCooldown=oe,this.defense=0,this.x=t,this.y=i,this.name="",this.exploreSpeed=1,this.color=e,this.borderColor=16777215,this.explorationNeeded=1e3,this.enemies=[],this.yields=[],this.roadDist=-1,this.roadBonus=0,this.roadBuildable=!1,this.dockBuildable=!1,this.houseBuildable=!1}save(){return{exp:this.explored,rev:this.revealed,dif:this.difficulty,rn:this.regName,ae:this.amountExplored,in:this.isInvaded,ip:this.invasionPower,if:this.invasionFights,bld:void 0===this.building?"":this.building.save(),def:this.defense,fcd:this.fightCooldown,x:this.x,y:this.y}}static loadFromSave(e,t){var i=new Ke;return i.regName=e.rn,i.explored=e.exp,i.revealed=e.rev,i.difficulty=e.dif,i.amountExplored=e.ae,i.isInvaded=e.in,i.invasionPower=e.ip,i.invasionFights=e.if,i.building=""===e.bld?void 0:je.loadFromFile(e.bld,t),i.defense=e.def,i.fightCooldown=e.fcd,i.x=e.x,i.y=e.y,i}init(e,t,i){var s=Ne.TILE_TYPES[e];this.regName=e,this.difficulty=t,this.exploreSpeed=1+t*ce,this.color=s.clr,this.name=s.name,this.enemies=s.enemies,this.explorationNeeded=s.explorationNeeded;var a=Math.min(1,Math.max(0,t-i)/20);this.borderColor=Phaser.Display.Color.GetColor(255,255-(a>.5?255*(a-.5)*2:0),255-Math.min(255,255*a*2)),this.yields=[];for(var r=0;r<s.yields.length;r++)this.yields.push({type:s.yields[r].type,tier:Math.min(8,Math.max(1,Math.floor(t/20))),rate:s.yields[r].rate})}sighting(){this.isInvaded=!0,this.invasionPower=0,this.invasionFights=5}invade(){this.isInvaded=!1,this.invasionPower=0,this.amountExplored=0,this.invasionFights=0,this.explored=!1,this.revealed=!0}getInvasionMulti(){return Math.min(5,Math.floor(Math.max(0,Math.log2(this.invasionPower/ye))))}explore(e){this.amountExplored+=e/this.exploreSpeed}incInvasionPower(e){if(this.getInvasionMulti()<5){var t=e+this.defense,i=Math.max(.1,1+.1*(this.difficulty-t));this.invasionPower+=He*i}}generateMonsters(){var e=[];if(!0===this.isInvaded){var t=this.difficulty+this.getInvasionMulti();e.push(qe.GetCreatureByName(this.enemies[Pe.randint(0,this.enemies.length)],t)),e.push(qe.GetCreatureByName(this.enemies[Pe.randint(0,this.enemies.length)],this.difficulty-1)),e.push(qe.GetCreatureByName(this.enemies[Pe.randint(0,this.enemies.length)],this.difficulty-1))}else for(var i=this.difficulty<30?1:2,s=(this.difficulty<5?2:3)+(this.difficulty>15?1:0),a=this.difficulty>0?Pe.randint(i,s):1,r=0;r<a;r++){var n=Pe.randint(0,this.enemies.length);e.push(qe.GetCreatureByName(this.enemies[n],this.difficulty))}return e}}class ze{constructor(e=8,t=8,i,s,a=!1){if(this.tileChangedHandler=void 0,this.resourcesPerDay=[0,0,0,0,0,0],this.taverns=[],this.roads=[],this.markets=[],this.productionBuildings=[],!0===a)return!0;this.width=e,this.height=t,this.regionLevel=i,this.townData=new Ve(i+1),this.tilesExplored=0,this.sightings=[],this.sightingsDelay=0,this.invasionCounter=0,this.worldHeight=350,this.type=s,this.map=[];for(var r=0;r<t;r++){for(var n=[],o=0;o<e;o++)n.push(new Ke(0,o,r));this.map.push(n)}var h=[];for(r=0;r<Ne.REGION_TYPES[s].points.length;r++)for(var l=Ne.REGION_TYPES[s].points[r],c=0;c<l.amount;c++)h.push({x:Pe.randint(0,e),y:Pe.randint(0,t),power:Pe.randint(l.power[0],l.power[1]),terrainData:l.terrain});this.generateTerrain(h),this._init()}save(){for(var e=[],t=0;t<this.height;t++){for(var i=[],s=0;s<this.width;s++)i.push(this.map[t][s].save());e.push(i)}return{w:this.width,h:this.height,rl:this.regionLevel,td:this.townData.save(),te:this.tilesExplored,map:e,sight:this.sightings,sd:this.sightingsDelay,ic:this.invasionCounter,wh:this.worldHeight,type:this.type}}static loadFromSave(e,t){var i=new ze(0,0,0,"temperate",!0);i.width=e.w,i.height=e.h,i.regionLevel=e.rl,i.townData=new Ve(1),i.townData.load(e.td),i.tilesExplored=e.te,i.sightings=e.sight,i.sightingsDelay=e.sd,i.invasionCounter=e.ic,i.worldHeight=e.wh,i.type=e.type,i.map=[];for(var s=0;s<e.map.length;s++){for(var a=[],r=0;r<e.map[s].length;r++){var n=Ke.loadFromSave(e.map[s][r],t);n.init(n.regName,n.difficulty,this.regionLevel*We.instance.regionDifficultyIncrease),a.push(n)}i.map.push(a)}return i._init(),i}generateTerrain(e){var t=this.regionLevel*We.instance.regionDifficultyIncrease,i=t+We.instance.regionDifficultyIncrease,s=[Math.floor(this.width/2),this.height-3],a=[s[0]+Math.floor(2*Math.random())];a.push(s[1]+2-Math.abs(s[0]-a[0]));var r=[];r.push({x:s[0],y:s[1],power:t-2}),r.push({x:a[0],y:a[1],power:t-4});for(var n=0;n<8;n++){for(var o=Pe.randint(0,this.width),h=Pe.randint(0,this.height);Pe.pointInList(o,h,r);)o=Pe.randint(0,this.width),h=Pe.randint(0,this.height);var l=t+Pe.getDistance(o,h,s[0],s[1])/(.7*this.height)*We.instance.regionDifficultyIncrease;r.push({x:o,y:h,power:l+Pe.randint(-4,4)})}for(n=0;n<this.height;n++)for(var c=0;c<this.width;c++){var d=Pe.nearestPointsInList(c,n,e,2),u=void 0;u=e[d[0][0]].power/(1+d[0][1])>e[d[1][0]].power/(1+d[1][1])?e[d[0][0]].terrainData:e[d[1][0]].terrainData,d=Pe.nearestPointInList(c,n,r);var g=t+Pe.getDistance(c,n,s[0],s[1])/(.79*this.height)*We.instance.regionDifficultyIncrease,m=Math.max(t,Math.min(i-1,Math.floor(g+(r[d[0]].power-g)/(2+d[1]))));this.map[n][c].init(u,m,t)}var p=[],y=0,v=[0,0];for(n=0;n<this.height;n++)for(c=0;c<this.width;c++)this.map[n][c].difficulty>=i-1&&p.push([n,c]),this.map[n][c].difficulty>y&&(v[0]=n,v[1]=c,y=this.map[n][c].difficulty);p.push(v);var b=p[Pe.randint(0,p.length)];this.map[b[0]][b[1]].init("mysticgate",i,t),this.map[s[1]][s[0]].init("town",t,t),this.map[s[1]][s[0]].building=Xe.getBuildingByName("town"),this.placeBuilding(s[0],s[1],Xe.getBuildingByName("town")),this.map[a[1]][a[0]].revealed=!0}onTileChanged(e){this.tileChangedHandler=e}removeTileChanged(){this.tileChangedHandler=void 0}_onTileChanged(e){void 0!==this.tileChangedHandler&&this.tileChangedHandler(e)}getExplorePercent(){return this.tilesExplored/(this.width*this.height)}isExplorable(e,t){return this.map[t][e].revealed}exploreTile(e,t){return!0===this.map[t][e].revealed&&(this.tilesExplored+=1,this.map[t][e].explored=!0,"Town"===this.map[t][e].name&&(this.townData.townExplored=!0),this.tilesExplored>=10&&(this.townData.researchEnabled=!0),t>0&&(this.map[t-1][e].revealed=!0,this._onTileChanged(this.map[t-1][e])),t<this.height-1&&(this.map[t+1][e].revealed=!0,this._onTileChanged(this.map[t+1][e])),e>0&&(this.map[t][e-1].revealed=!0,this._onTileChanged(this.map[t][e-1])),e<this.width-1&&(this.map[t][e+1].revealed=!0,this._onTileChanged(this.map[t][e+1]))),this._onTileChanged(this.map[t][e]),this.map[t][e]}_invade(){this.invasionCounter=0;var e=this.sightings[Pe.randint(0,this.sightings.length)];this.map[e[0]][e[1]].invade(),null!=this.map[e[0]][e[1]].building&&this.destroyBuilding(e[1],e[0]),this.townData.currentPopulation=this.townData.currentPopulation*xe,this.tilesExplored-=1,this.endSighting(e[1],e[0])}_addSighting(){var e=Math.min(we*(1+this.sightings.length*Ce),ke),t=Math.min(2*e,ke);this.sightingsDelay=1e3*Pe.randint(e,t);for(var i=[],s=1;s<this.height-1;s++)for(var a=1;a<this.width-1;a++)if(!1!==this.map[s][a].explored&&"Town"!==this.map[s][a].name&&"Mystic Gate"!==this.map[s][a].name){for(var r=!1,n=-1;n<2;n++)for(var o=-1;o<2;o++)!0===this.map[s+n][a+o].revealed&&!1===this.map[s+n][a+o].explored&&(r=!0);!0===r&&i.push([s,a])}if(!(i.length<=0)){var h=i[Pe.randint(0,i.length)];this.sightings.push(h),this.map[h[0]][h[1]].sighting()}}endSighting(e,t){this.map[t][e].isInvaded=!1,this.map[t][e].invasionPower=0,this.invasionCounter=Math.max(0,this.invasionCounter-fe),this.sightings=this.sightings.filter(e=>!0===this.map[e[0]][e[1]].isInvaded),this._onTileChanged(this.map[t][e])}_canDock(e,t){return t>0&&this.map[t-1][e].name!=this.map[t][e].name||t<this.height-1&&this.map[t+1][e].name!=this.map[t][e].name||e>0&&this.map[t][e-1].name!=this.map[t][e].name||e<this.width-1&&this.map[t][e+1].name!=this.map[t][e].name}_init(){this.roads=[],this.markets=[{x:Math.floor(this.width/2),y:this.height-3}],this.taverns=[],this.productionBuildings=[];for(var e=0;e<this.height;e++)for(var t=0;t<this.width;t++)void 0!==this.map[e][t].building&&("Road"===this.map[e][t].building.name||"Town"===this.map[e][t].building.name?this.roads.push([e,t]):"Market"===this.map[e][t].building.name?this.markets.push({x:t,y:e}):"Tavern"===this.map[e][t].building.name?this.taverns.push([e,t]):"Town House"!==this.map[e][t].building.name&&this.productionBuildings.push([e,t])),"Lake"!==this.map[e][t].name&&"Oasis"!==this.map[e][t].name||(this.map[e][t].dockBuildable=this._canDock(t,e));this._calculateTileBonuses()}_calculateTileBonuses(){var e=0,t=0;this.townData.buildingIncome=0,this.resourcesPerDay=[0,0,0,0,0,0];for(var i=0;i<this.height;i++)for(var s=0;s<this.width;s++)this.map[i][s].roadDist=-1,this.map[i][s].roadBonus=0,this.map[i][s].roadBuildable=!1,this.map[i][s].houseBuildable=!1;var a=[[1,.5,0],[1.25,.75,.25],[1.5,1,.5]];for(i=0;i<this.roads.length;i++)for(var r=this.map[this.roads[i][0]][this.roads[i][1]].building.tier,n=Math.max(0,this.roads[i][0]-r);n<Math.min(this.height,this.roads[i][0]+r+1);n++)for(var o=Math.max(0,this.roads[i][1]-r);o<Math.min(this.width,this.roads[i][1]+r+1);o++){var h=Math.abs(n-this.roads[i][0])+Math.abs(o-this.roads[i][1]);Math.abs(n-this.roads[i][0])+Math.abs(o-this.roads[i][1])<=r&&(this.map[n][o].roadDist=-1===this.map[n][o].roadDist?h:Math.min(this.map[n][o].roadDist,h),this.map[n][o].roadBuildable=this.map[n][o].roadDist<=1,this.map[n][o].roadBonus=Math.max(this.map[n][o].roadBonus,a[r-1][this.map[n][o].roadDist-1]),this.map[n][o].houseBuildable=Math.abs(n-this.roads[i][0])<=1&&Math.abs(o-this.roads[i][1])<=1)}var l=Math.floor(this.width/2),c=this.height-3;this.map[c][l-1].roadBuildable=!0,this.map[c][l+1].roadBuildable=!0,this.map[c-1][l].roadBuildable=!0,this.map[c+1][l].roadBuildable=!0;for(i=1;i<this.markets.length;i++){var d=10+Ie.instance.moonperks.nightmarket.level,u=this.map[this.markets[i].y][this.markets[i].x].building.tier,g=Pe.nearestPointInList(this.markets[i].x,this.markets[i].y,this.markets,!0);e+=Math.max(0,Math.min(d,g[1]/ue*d))*u/100}for(i=0;i<this.taverns.length;i++){r=1+Ie.instance.moonperks.moonwine.level;var m=0;for(u=this.map[this.taverns[i][0]][this.taverns[i][1]].building.tier,n=Math.max(0,this.roads[i][0]-r);n<Math.min(this.height,this.roads[i][0]+r+1);n++)for(o=Math.max(0,this.roads[i][1]-r);o<Math.min(this.width,this.roads[i][1]+r+1);o++)Math.abs(n-this.roads[i][0])+Math.abs(o-this.roads[i][1])<=r&&void 0!==this.map[n][o].building&&"Town House"===this.map[n][o].building.name&&(m+=.02,t+=1);e+=m*u}for(i=0;i<this.productionBuildings.length;i++){var p=this.map[this.productionBuildings[i][0]][this.productionBuildings[i][1]],y=1+p.defense*Ie.instance.moonperks.moonlightworkers.level*.01;switch(p.building.name){case"Lumberyard":this.resourcesPerDay[C]+=p.building.tier*Pe.yieldHelper(C,p.yields)*y*p.roadBonus;break;case"Hunter's Lodge":this.resourcesPerDay[T]+=p.building.tier*Pe.yieldHelper(T,p.yields)*y*p.roadBonus;break;case"Mine":this.resourcesPerDay[M]+=p.building.tier*Pe.yieldHelper(M,p.yields)*y*p.roadBonus;break;case"Herbalist's Hut":this.resourcesPerDay[B]+=p.building.tier*Pe.yieldHelper(B,p.yields)*y*p.roadBonus;break;case"Quarry":this.resourcesPerDay[D]+=p.building.tier*Pe.yieldHelper(D,p.yields)*y*p.roadBonus;break;case"Crystal Loom":this.resourcesPerDay[H]+=p.building.tier*Pe.yieldHelper(H,p.yields)*y*p.roadBonus;break;case"Docks":this.townData.buildingIncome+=2*p.building.tier,p.y>0&&(this.map[p.y-1][p.x].roadBuildable=!0),p.y<this.height-1&&(this.map[p.y+1][p.x].roadBuildable=!0),p.x>0&&(this.map[p.y][p.x-1].roadBuildable=!0),p.x<this.width-1&&(this.map[p.y][p.x+1].roadBuildable=!0)}}this.townData.setTavernPopulation(t),this.townData.calculateEconMulti(e)}_addBuilding(e){switch(e.building.name){case"Lumberyard":case"Hunter's Lodge":case"Mine":case"Herbalist's Hut":case"Quarry":case"Crystal Loom":case"Docks":this.productionBuildings.push([e.y,e.x]);break;case"Town House":this.townData.increaseMaxPop(5*e.building.tier);break;case"Watch Tower":for(var t=Math.max(0,e.y-2);t<Math.min(this.height,e.y+3);t++)for(var i=Math.max(0,e.x-2);i<Math.min(this.width,e.x+3);i++)Math.abs(i-e.x)+Math.abs(t-e.y)<=2&&(this.map[t][i].defense+=2*e.building.tier);break;case"Market":this.markets.push({x:e.x,y:e.y});break;case"Tavern":this.taverns.push([e.y,e.x]);break;case"Road":case"Town":this.roads.push([e.y,e.x])}}_removeBuilding(e){switch(e.building.name){case"Lumberyard":case"Hunter's Lodge":case"Mine":case"Herbalist's Hut":case"Quarry":case"Crystal Loom":case"Docks":this.productionBuildings=this.productionBuildings.filter(t=>t[1]!==e.x||t[0]!==e.y);break;case"Town House":this.townData.increaseMaxPop(-5*e.building.tier);break;case"Watch Tower":for(var t=Math.max(0,e.y-2);t<Math.min(this.height,e.y+3);t++)for(var i=Math.max(0,e.x-2);i<Math.min(this.width,e.x+3);i++)Math.abs(i-e.x)+Math.abs(t-e.y)<=2&&(this.map[t][i].defense-=2*e.building.tier);break;case"Market":this.markets=this.markets.filter(t=>t.x!==e.x||t.y!==e.y);break;case"Tavern":this.taverns=this.taverns.filter(t=>t[1]!==e.x||t[0]!==e.y);break;case"Road":this.roads=this.roads.filter(t=>t[1]!==e.x||t[0]!==e.y)}}nextWeakestTile(){for(var e=[-1,-1],t=this.regionLevel*We.instance.regionDifficultyIncrease+50,i=0;i<this.height;i++)for(var s=0;s<this.width;s++)!1===this.map[i][s].explored&&!0===this.map[i][s].revealed&&this.map[i][s].difficulty<t&&(e=[s,i],t=this.map[i][s].difficulty);return e}handleReinforcedHouses(){for(var e=0;e<this.height;e++)for(var t=0;t<this.width;t++)void 0!==this.map[e][t].building&&(this.map[e][t].defense+=1);this._calculateTileBonuses()}placeBuilding(e,t,i){this.map[t][e].building=i,this.map[t][e].building.increaseCosts(),this._addBuilding(this.map[t][e]),this._calculateTileBonuses(),this._onTileChanged(this.map[t][e])}upgradeBuilding(e,t){this._removeBuilding(this.map[t][e]),this.map[t][e].building.tier+=1,this.map[t][e].building.increaseCosts(),this._addBuilding(this.map[t][e]),this._calculateTileBonuses(),this._onTileChanged(this.map[t][e])}destroyBuilding(e,t){this._removeBuilding(this.map[t][e]),this.map[t][e].building=void 0,this._calculateTileBonuses(),this._onTileChanged(this.map[t][e])}update(e){}updateDay(){this.townData.endOfDay();for(var e=new Fe,t=[],i=1+.03*e.talents.governance.level,s=0;s<this.resourcesPerDay.length;s++)t.push(Math.max(0,this.resourcesPerDay[s]*this.townData.productionMulti*i));e.addResource(t,Math.floor(this.regionLevel)),this.tilesExplored>=11&&(this.sightingsDelay-=He,this.sightingsDelay<=0&&this._addSighting());for(s=0;s<this.sightings.length;s++){var a=this.sightings[s];this.map[a[0]][a[1]].incInvasionPower(this.regionLevel),this.invasionCounter+=this.map[a[0]][a[1]].getInvasionMulti()*(1/(1+.25*e.talents.guardian.level))}this.invasionCounter>be&&this._invade()}updateWeek(){this.townData.endOfWeek()}}class Qe{constructor(e=0){this.time=e,this.offlineTime=0,this.frameDelta=0,this.delta=0,this.timescale=1,this.onDayEndHandlers=[],this.onWeekEndHandlers=[]}getYears(){return Math.floor(this.time/Le)}getMonths(){return Math.floor(this.time%Le/Re)}getDays(){return Math.floor(this.time%Le%Re/He)}getHours(){return Math.floor(this.time%Le%Re%He/De)}getOfflineTimeString(){var e=Math.floor(this.offlineTime/36e5),t=Math.floor(this.offlineTime%36e5/6e4),i=Math.floor(this.offlineTime%6e4/1e3);return("0"+e).slice(-2)+":"+("0"+t).slice(-2)+":"+("0"+i).slice(-2)}_onDayEnd(){for(var e=0;e<this.onDayEndHandlers.length;e++)this.onDayEndHandlers[e]()}_onWeekEnd(){for(var e=0;e<this.onWeekEndHandlers.length;e++)this.onWeekEndHandlers[e]()}registerEvent(e,t){"onDayEnd"===e?this.onDayEndHandlers.push(t):"onWeekEnd"===e&&this.onWeekEndHandlers.push(t)}setTimeScale(e){this.offlineTime<=0||(this.timescale=e)}setFrameDelta(e){this.delta=e,this.frameDelta=e*this.timescale}addOfflineTime(e){this.offlineTime=Math.min(864e5,this.offlineTime+e/2)}update(e){var t=this.getDays();this.time+=this.frameDelta;var i=this.getDays();t!==i&&this._onDayEnd(),Math.floor(t/7)!==Math.floor(i/7)&&this._onWeekEnd(),this.timescale>1&&(this.offlineTime-=this.delta*(this.timescale-1),this.offlineTime<=0&&(this.timescale=1,this.offlineTime=0))}timeSince(e){return new Qe(this.time-e)}getText(){return"Year "+(this.getYears()+1)+", "+Be[this.getMonths()]+" "+(this.getDays()+1)+", "+this.getHours()+":00"}getTimespanText(){var e="",t=this.getYears();t>0&&(e+=t+" Years");var i=this.getMonths();i>0&&(e+=(e.length>0?", ":"")+i+" Months");var s=this.getDays();s>0&&(e+=(e.length>0?", ":"")+s+" Days");var a=this.getHours();return a>0&&(e+=(e.length>0?", ":"")+a+" Hours"),e}save(){return{time:this.time,otime:this.offlineTime}}load(e,t){t<=4&&(e.otime=0),this.time=e.time,this.offlineTime=e.otime}}class Je{constructor(){if(!Je.instance){var e=We.instance.regionSize;this.regionList=[],this.regionList.push(new ze(e[0],e[1],0,"temperate")),this.currentRegion=0,this.nextRegions=[],this.timeAtRunStart=0,this.time=new Qe,this.time.registerEvent("onDayEnd",()=>{this.updateDay()}),this.time.registerEvent("onWeekEnd",()=>{this.updateWeek()}),Je.instance=this}return Je.instance}rebirth(){var e=We.instance.regionSize;this.regionList=[],this.regionList.push(new ze(e[0],e[1],0,"temperate")),this.currentRegion=0,this.nextRegions=[],this.timeAtRunStart=this.time.time}getRegion(e){return this.regionList[e]}setRegion(e){this.currentRegion=e}getCurrentRegion(){return this.getRegion(this.currentRegion)}setCurrentRegion(e){this.currentRegion=e}getGoldCap(){for(var e=0,t=0;t<this.regionList.length;t++)e+=this.regionList[t].townData.getGoldCap();return e}generateRegionChoices(){var e=Pe.randint(2,5),t=["temperate","mountains","desert","forest","hills"];this.nextRegions=[];for(var i=0;i<e;i++){var s=Pe.randint(0,t.length);this.nextRegions.push(t[s]),t.splice(s,1)}}addRegion(e){var t=We.instance.regionSize;this.regionList.push(new ze(t[0],t[1],this.regionList.length,this.nextRegions[e])),this.regionList[this.regionList.length-1].worldHeight=Math.floor((e+1)*(700/(this.nextRegions.length+1))),this.nextRegions=[]}update(e){this.time.update(e);for(var t=0;t<this.regionList.length;t++)this.regionList[t].update(e)}updateDay(){for(var e=0;e<this.regionList.length;e++)this.regionList[e].updateDay()}updateWeek(){for(var e=0;e<this.regionList.length;e++)this.regionList[e].updateWeek()}save(){for(var e=[],t=0;t<this.regionList.length;t++)e.push(this.regionList[t].save());return{rl:e,cr:this.currentRegion,nr:this.nextRegions,st:this.timeAtRunStart,time:this.time.save()}}load(e,t){t<=4&&(e.st=0),this.regionList=[];for(var i=0;i<e.rl.length;i++)this.regionList.push(ze.loadFromSave(e.rl[i],t));this.currentRegion=e.cr,this.nextRegions=e.nr,this.timeAtRunStart=e.st,this.time.load(e.time,t)}}class Ze{constructor(e,t,i,s,a,r){this.backgroundRect=e.add.rectangle(t,i,s,a,0).setOrigin(0,0),this.backgroundRect.isStroked=!0,this.backgroundRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backgroundRect.lineWidth=1,this.rawText=r,this.text=e.add.bitmapText(t+s/2,i+a/2,"courier20",r).setOrigin(.5),this.enabled=!0,this.width=s,this.height=a,this.isNotifying=!1,this.textClr=16777215}setNotification(){return this.isNotifying=!0,this.text.setText("!"+this.rawText+"!"),this}setPosition(e,t){return this.backgroundRect.setPosition(e,t),this.text.setPosition(e+this.width/2,t+this.height/2),this}setVisible(e){return this.backgroundRect.setVisible(e),this.text.setVisible(e),this.text.setTint(!0===e?this.textClr:10066329),this}setEnable(e){return this.enabled=e,this.text.setTint(!0===e?this.textClr:10066329),this}setText(e){return this.text.setText(e),this}setTextColor(e){return this.text.setTint(e),this.textClr=e,this}_onClick(e){!0===this.isNotifying&&(this.isNotifying=!1,this.text.setText(this.rawText)),!0===this.enabled&&e()}_onPointerUp(e){!0===this.enabled&&e()}_onPointerOut(e){!0===this.enabled&&e()}_onPointerOver(e){!0===this.enabled&&e()}onClickHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this._onClick(e)}),this}onPointerOutHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerout",()=>{this._onPointerOut(e)}),this}onPointerUpHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerup",()=>{this._onPointerUp(e)}),this}onPointerOverHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerover",()=>{this._onPointerOver(e)}),this}destroy(){this.backgroundRect.destroy(),this.text.destroy()}}class $e{constructor(e,t,i,s,a,r){this.backgroundRect=e.add.rectangle(t,i,s,a,0).setOrigin(0,0),this.backgroundRect.isStroked=!0,this.backgroundRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backgroundRect.lineWidth=1,this.img=e.add.image(t+s/2,i+a/2,r.sprite,r.tile).setOrigin(.5),this.img.displayWidth=s,this.img.displayHeight=a,this.enabled=!0,this.width=s,this.height=a}setPosition(e,t){this.backgroundRect.setPosition(e,t),this.img.setPosition(e+this.width/2,t+this.height/2)}setVisible(e){this.backgroundRect.setVisible(e),this.img.setVisible(e)}setEnable(e){this.enabled=e}setBorderTint(e){this.backgroundRect.strokeColor=e}_onClick(e){!0===this.enabled&&e()}_onPointerUp(e){!0===this.enabled&&e()}_onPointerOut(e){!0===this.enabled&&e()}_onPointerOver(e){!0===this.enabled&&e()}onClickHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this._onClick(e)}),this}onPointerOutHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerout",()=>{this._onPointerOut(e)}),this}onPointerUpHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerup",()=>{this._onPointerUp(e)}),this}onPointerOverHandler(e){return this.backgroundRect.setInteractive({useHandCursor:!0}).on("pointerover",()=>{this._onPointerOver(e)}),this}destroy(){this.backgroundRect.destroy(),this.img.destroy()}}class et{constructor(e,t,i,s,a){this.boundingBox=e.add.rectangle(t,i,s,a,2236962).setOrigin(0),this.boundingBox.strokeColor=12303291,this.boundingBox.isStroked=!0,this.boundingBox.lineWidth=2,this.x=t,this.y=i,this.context=e,this.textList=[]}addText(e,t,i,s){return this.textList.push(this.context.add.bitmapText(this.x+e,this.y+t,i,s)),this}setVisible(e){this.boundingBox.setVisible(e);for(var t=0;t<this.textList.length;t++)this.textList[t].setVisible(e)}destroy(){this.boundingBox.destroy();for(var e=0;e<this.textList.length;e++)this.textList[e].destroy()}}class tt{constructor(e,t,i,s){var r=new Ee,n=(new Je).getCurrentRegion();this.backRect=e.add.rectangle(t,i,500,220,Phaser.Display.Color.GetColor(0,0,0)).setInteractive().setOrigin(0,0),this.backRect.isStroked=!0,this.backRect.strokeColor=Phaser.Display.Color.GetColor(128,128,128),this.backRect.lineWidth=2,this.titleLabel=e.add.bitmapText(t+5,i+5,"courier20",s.name);var o="";if(s.difficulty<1?o+="Difficulty: Weak\n":o+="Difficulty: "+s.difficulty+"\n",!1===s.explored?o+="Explored: "+Math.floor(s.amountExplored/s.explorationNeeded*100)+"%\n":o+="Explored\nDefense: "+Math.floor(s.defense)+"\n",!0===s.explored&&s.yields.length>0){o+="Yields:\n";for(var h=0;h<s.yields.length;h++)s.yields[h].rate>0&&(o+=" "+R[s.yields[h].type]+": "+s.yields[h].rate+"\n")}if(this.infoLabel=e.add.bitmapText(t+10,i+25,"courier16",o),this.buildingLabel=void 0,this.floatingText=void 0,this.buildingDesc=void 0,this.buildingCosts=void 0,this.upgradeButton=void 0,this.destroyButton=void 0,this.buildingButtons=[],!0===r.unlocks.buildings&&!0===s.explored)if(void 0===s.building){this.buildingLabel=e.add.bitmapText(t+180,i+5,"courier20","Buildings:");var l=[];s.yields.length>0&&!0===s.roadBuildable&&l.push("road");for(h=0;h<s.yields.length;h++)switch(s.yields[h].type){case C:l.push("wood");break;case T:l.push("leather");break;case M:l.push("metal");break;case B:l.push("fiber");break;case D:l.push("stone");break;case H:l.push("crystal")}!0===s.dockBuildable&&l.push("docks"),s.yields.length>0&&(s.houseBuildable&&(l.push("house"),n.townData.upgrades.market.level>0&&l.push("market")),n.townData.upgrades.tavern.level>0&&l.push("tavern"),l.push("watchtower"));for(h=0;h<l.length;h++){var c=t+180+h%9*34,d=i+30+34*Math.floor(h/9),u=Xe.getBuildingByName(l[h]);this.buildingButtons.push(this._makeBuildingBtn(e,c,d,s,u))}}else{this.buildingLabel=e.add.bitmapText(t+150,i+5,"courier20",s.building.name);var g=Pe.processText(je.getTooltip(s,s.building.name,s.building.tier),27);if(this.buildingDesc=e.add.bitmapText(t+150,i+25,"courier16",g),this._canUpgrade(s.building)){for(o="Upgrade:\n",h=0;h<s.building.resourceCosts.length;h++)s.building.resourceCosts[h]>0&&(o+=R[h]+": "+Pe.numberString(s.building.resourceCosts[h])+"\n");o+="Gold: "+s.building.goldCost,this.buildingCosts=e.add.bitmapText(t+395,i+25,"courier16",o),this.upgradeButton=new Ze(e,t+175,i+195,140,20,"Upgrade").onClickHandler(()=>{this._onAction("upgrade",{tile:s})})}this.destroyButton=new $e(e,t+130,i+5,16,16,{sprite:"icons",tile:23}).onClickHandler(()=>{this._onAction("destroy",{tile:s})}).onPointerOverHandler(()=>{var r="Remove the building from this tile. Costs "+s.building.tier*pe+"g.",n=t+130,o=i+5;this.floatingText=new a(e,Pe.processText(r,25),n+16,o-60,220,60,"courier16",16)}).onPointerOutHandler(()=>{this._clearTooltip()})}this.exploreButton=new Ze(e,t+30,i+195,140,20,"Explore").onClickHandler(()=>{this._onAction("explore",{tile:s})}),this.cancelButton=new Ze(e,t+320,i+195,140,20,"Cancel").onClickHandler(()=>{this._onAction("cancel")}),this.onActionHandlers=[]}_canUpgrade(e){return"Market"===e.name?e.tier<Je.instance.getCurrentRegion().townData.upgrades.market.level:"Tavern"===e.name?e.tier<Je.instance.getCurrentRegion().townData.upgrades.tavern.level:e.tier<3}_makeBuildingBtn(e,t,i,s,a){return new $e(e,t,i,32,32,a.texture).onClickHandler(()=>{this._onAction("build",{tile:s,building:a})}).onPointerOverHandler(()=>{for(var r="",n=0;n<a.resourceCosts.length;n++)a.resourceCosts[n]>0&&(r+=R[n]+": "+a.resourceCosts[n]+"\n");r+="Gold: "+a.goldCost,void 0!==this.floatingText&&this.floatingText.destroy();var o=Pe.processText(je.getTooltip(s,a.name,a.tier),24);this.floatingText=new et(e,t+(t+350>1100?-350:0),i-150,350,150).addText(5,5,"courier20",a.name).addText(230,5,"courier20","Costs:").addText(235,25,"courier16",r).addText(10,25,"courier16",o)}).onPointerOutHandler(()=>{this._clearTooltip()})}_clearTooltip(){this.floatingText.destroy(),this.floatingText=void 0}addOnActionHandler(e){this.onActionHandlers.push(e)}_onAction(e,t={}){for(var i=0;i<this.onActionHandlers.length;i++)this.onActionHandlers[i](e,t)}destroy(){this.backRect.destroy(),this.titleLabel.destroy(),this.infoLabel.destroy(),this.exploreButton.destroy(),this.cancelButton.destroy(),void 0!==this.floatingText&&this.floatingText.destroy(),void 0!==this.buildingLabel&&this.buildingLabel.destroy();for(var e=0;e<this.buildingButtons.length;e++)this.buildingButtons[e].destroy();void 0!==this.buildingDesc&&this.buildingDesc.destroy(),void 0!==this.buildingCosts&&this.buildingCosts.destroy(),void 0!==this.upgradeButton&&this.upgradeButton.destroy(),void 0!==this.destroyButton&&this.destroyButton.destroy()}}class it{constructor(e,t,i,s){this.backingRect=e.add.rectangle(t,i,400,270,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0).setInteractive(),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(200,0,200),this.backingRect.lineWidth=2,this.titleLabel=e.add.bitmapText(t+200,i+10,"courier20","Mystic Gate").setOrigin(.5,0),this.titleLabel.setTint(Phaser.Display.Color.GetColor(200,0,200));var a="You approach the mysterious, ancient gate. The air buzzes with energy as you peer into the pale blue portal. All those shadow beasts, guarding this place.. what's so important about this?";a=Pe.processText(a,48),this.descLabel=e.add.bitmapText(t+200,i+30,"courier16",a,16,1).setOrigin(.5,0),a='"THE MOON CALLS TO ALL IN THESE LANDS THAT WOULD HEAR IT. BE REBORN IN MOONLIGHT."',a=Pe.processText(a,48),this.desc2Label=e.add.bitmapText(t+200,i+107,"courier16",a,16,1).setOrigin(.5,0),this.desc2Label.setTint(Phaser.Display.Color.GetColor(96,172,177)),a="You hear a voice calling to you. Do you enter into the unknown, or continue your journey?",a=Pe.processText(a,48),this.desc3Label=e.add.bitmapText(t+200,i+150,"courier16",a,16,1).setOrigin(.5,0);var r="MOONLIGHT\n"+(new Fe).earnableMoonlight(s+1)*(1+.1*Ie.instance.challenges.time.completions);this.moonlightLabel=e.add.bitmapText(t+200,i+190,"courier20",r,20,1).setOrigin(.5,0),this.moonlightLabel.setTint(Phaser.Display.Color.GetColor(206,238,240)),this.rebirthButton=new Ze(e,t+30,i+240,155,20,"Enter"),this.leaveButton=new Ze(e,t+215,i+240,155,20,"Leave")}onRebirthHandler(e){return this.rebirthButton.onClickHandler(e),this}onLeaveHandler(e){return this.leaveButton.onClickHandler(e),this}destroy(){this.backingRect.destroy(),this.titleLabel.destroy(),this.descLabel.destroy(),this.desc2Label.destroy(),this.desc3Label.destroy(),this.moonlightLabel.destroy(),this.rebirthButton.destroy(),this.leaveButton.destroy()}}class st extends s{constructor(e,t){super(e,t),this.WIDTH=50,this.HEIGHT=50,this.tileClickHandlers=[];var i=new Je;this.region=i.getCurrentRegion(),this.offsetX=380-this.region.width*this.WIDTH/2,this.offsetY=350-this.region.height*this.HEIGHT/2,this.progression=new Ee,this.letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q"],this.sightingVal=0,this.tileSelectWindow=void 0,this.rebirthDialog=void 0,this.autoExploreActive=!1,this.updateBuildings=!1}preload(){}registerEvent(e,t){"onTileClick"===e&&this.tileClickHandlers.push(t)}_handleProgressionEvent(e,t,i){e===g&&this.invasionLabel.setVisible(!0)}_nextToConnector(e,t){return"Town"===this.region.map[t][e].name||void 0!==this.region.map[t][e].building&&"Docks"===this.region.map[t][e].building.name}_getRoadTexture(e,t){var i=e>0&&(0===this.region.map[t][e-1].roadDist||this._nextToConnector(e-1,t))?"1":"0",s=e<this.region.width-1&&(0===this.region.map[t][e+1].roadDist||this._nextToConnector(e+1,t))?"1":"0",a=t>0&&(0===this.region.map[t-1][e].roadDist||this._nextToConnector(e,t-1))?"1":"0",r=t<this.region.height-1&&(0===this.region.map[t+1][e].roadDist||this._nextToConnector(e,t+1))?"1":"0";return{sprite:"roadicons",tile:_e[i+s+a+r]+20*(this.region.map[t][e].building.tier-1)}}_getBuildingImage(e,t){return"Road"===this.region.map[t][e].building.name?this._getRoadTexture(e,t):{sprite:this.region.map[t][e].building.texture.sprite,tile:this.region.map[t][e].building.texture.tile+8*(this.region.map[t][e].building.tier-1)}}_setupTile(e,t){var i=this.region.map[t][e].color;this.region.map[t][e].borderColor;!1===this.region.map[t][e].revealed?(i=Phaser.Display.Color.GetColor(0,0,0),Phaser.Display.Color.GetColor(40,80,40)):!1===this.region.map[t][e].explored&&!0===this.region.map[t][e].revealed&&(i=Pe.colorLerp(i,Phaser.Display.Color.GetColor(0,0,0),.65));var s=this.add.rectangle(this.relativeX((e+.5)*this.WIDTH+this.offsetX),this.relativeY((t+.5)*this.HEIGHT+this.offsetY),this.WIDTH-1,this.HEIGHT-1,i);s.strokeColor=Phaser.Display.Color.GetColor(40,80,40),s.isStroked=!0,s.lineWidth=1.5,s.setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this._handleTileClick(e,t)}).on("pointerover",()=>{this._setTooltip(e,t)}).on("pointerout",()=>{this._disableTooltip()});var a=void 0;if(void 0!==this.region.map[t][e].building){var r=this._getBuildingImage(e,t);(a=this.add.image(this.relativeX((e+.5)*this.WIDTH+this.offsetX),this.relativeY((t+.5)*this.HEIGHT+this.offsetY),r.sprite,r.tile)).displayWidth=48,a.displayHeight=48}return{rect:s,building:a}}_setTooltip(e,t){void 0!==this.floatingText&&this._disableTooltip();var i="Tile "+this.letters[t]+(e+1)+"\n";!0===this.region.map[t][e].revealed?(i+=this.region.map[t][e].name+"\n",this.region.map[t][e].difficulty<1?i+="Difficulty: Weak\n":i+="Difficulty: "+this.region.map[t][e].difficulty+"\n",!1===this.region.map[t][e].explored?i+="Explored: "+Math.floor(this.region.map[t][e].amountExplored/this.region.map[t][e].explorationNeeded*100)+"%\n":i+="Explored\n"):i+="Unknown";var s=this.relativeX(e*this.WIDTH+this.offsetX);s+=s+190>1100?-150:0;var r=this.relativeY(t*this.HEIGHT+this.offsetY-75);r+=r<100?115:0,this.floatingText=new a(this,i,s,r,190,75)}_disableTooltip(){this.floatingText.destroy(),this.floatingText=void 0}_handleTileClick(e,t){!1===this.region.map[t][e].explored&&!1===this.region.map[t][e].revealed||("Town"!==this.region.map[t][e].name?"Mystic Gate"!==this.region.map[t][e].name||!0!==this.region.map[t][e].explored?(void 0!==this.tileSelectWindow&&(this.tileSelectWindow.destroy(),this.tileSelectWindow=void 0),this.tileSelectWindow=new tt(this,this.relativeX(200),this.relativeY(200),this.region.map[t][e]),this.tileSelectWindow.addOnActionHandler((e,t)=>{this._tileActionHandler(e,t)})):this.rebirthDialog=new it(this,this.relativeX(250),this.relativeY(215),this.region.regionLevel).onRebirthHandler(()=>{this._rebirthClickedHandler()}).onLeaveHandler(()=>{this._leaveClickedHandler()}):!1===this.progression.unlocks.townTab&&(this.region.map[t][e].amountExplored=this.region.map[t][e].explorationNeeded,this.region.exploreTile(e,t),this.progression.registerFeatureUnlocked(l,"You've finally made it to the town you saw in the distance, the only square not covered in this horrible fog. As you approach the gate a voice calls to you from the wall.\n\n\"Oh hey, you must be the new hero we've heard about, give me a minute to open the gate.\"\n\nHero? You woke up naked and alone in the wilderness. Come to think of it, it's amazing you're even still alive. You're still contemplating your existence when the door opens.\n\n\"So hero, you don't mind if I call you hero do you? Just makes things easier. Anyway we have a house laid out for you, don't expect much. The Forge has seen better days and the guilds have all been abandoned but I'm sure you'll see to that, Mr. Hero.\"\n\nYou begin to ask what all this hero nonsense is about when they speak up again.\n\n \"Oh that reminds me, we don't have much, but we can pay you for every one of those monsters you kill. Don't try to lie about how many you've beat, we can tell. Oh, and we'll pay you more when you're clearing new land for us. What were you trying to ask?\"\n\nYou say it was nothing and ask them to lead the way. You don't know about this hero stuff, but money is money. Besides you were already fighting this monsters anyway, might as well make money while you do it.")))}_tileActionHandler(e,t){switch(e){case"explore":this._exploreTile(t.tile.x,t.tile.y,!1);break;case"build":var i=new Fe,s=Math.floor(this.region.regionLevel);!0===Pe.canCraft(t.building.resourceCosts,i.resources[s])&&t.building.goldCost<=i.gold&&(i.spendResource(t.building.resourceCosts,s),i.addGold(-t.building.goldCost),this.region.placeBuilding(t.tile.x,t.tile.y,t.building),t.tile.building=t.building,this.scene.get("TownScene")._updateStatus());break;case"upgrade":i=new Fe,s=Math.floor(this.region.regionLevel);!0===Pe.canCraft(t.tile.building.resourceCosts,i.resources[s])&&t.tile.building.goldCost<=i.gold&&(i.spendResource(t.tile.building.resourceCosts,s),i.addGold(-t.tile.building.goldCost),this.region.upgradeBuilding(t.tile.x,t.tile.y),this.tileElements[t.tile.y][t.tile.x].building.setTexture(t.tile.building.texture.sprite,t.tile.building.texture.tile+8*(t.tile.building.tier-1)),this.scene.get("TownScene")._updateStatus());break;case"destroy":Fe.instance.gold>=t.tile.building.tier*pe&&(Fe.instance.addGold(-t.tile.building.tier*pe),this.region.destroyBuilding(t.tile.x,t.tile.y))}this.tileSelectWindow.destroy(),this.tileSelectWindow=void 0}_rebirthClickedHandler(){this.rebirthDialog.destroy(),this.rebirthDialog=void 0;var e=Fe.instance.earnableMoonlight(this.region.regionLevel+1)*(1+.1*Ie.instance.challenges.time.completions);if(Ie.instance.moonlight+=e,this.region.regionLevel>=1&&(Ee.instance.persistentUnlocks.challenge=!0),this.region.regionLevel>=2&&(Ie.instance.challenges.buildings.unlocked=!0,Ie.instance.challenges.talent.unlocked=!0),-1!==We.instance.maxRunTime&&Je.instance.time.time-Je.instance.timeAtRunStart<We.instance.maxRunTime){var t=Ie.instance.getChallengeFromName(We.instance.challengeName);switch(t.name){case"A Matter of Years":0==t.completions&&(Ie.instance.challenges.forge.unlocked=!0,Ie.instance.challenges.explore.unlocked=!0)}t.completions<t.maxCompletions&&(t.completions+=1)}var i=this.scene.get("MoonlightScene");i.enableLeveling(),i._onMoonlightChanged(),this.scene.bringToTop("MoonlightScene")}_leaveClickedHandler(){this.rebirthDialog.destroy(),this.rebirthDialog=void 0}_exploreTile(e,t,i){!1===this.progression.unlocks.combatTab&&this.progression.registerFeatureUnlocked(h,"Well this isn't so bad, walking aimlessly through this fog covered wilderness.\nI wonder if I'll meet a new friend.\n");for(var s=0;s<this.tileClickHandlers.length;s++)this.tileClickHandlers[s](e,t,i)}_onExploredCallback(e){if(0===e.y&&(!1===this.progression.unlocks.worldTab&&this.progression.registerFeatureUnlocked(p,"You did it, you've reached the edge of the world. This is all there is...\n\nOh wait, it looks like there's a trail over there leading to a new region! there's a whole world out there. I was wondering what that last tab was going to be."),Je.instance.regionList.length-1===Je.instance.currentRegion&&0===Je.instance.nextRegions.length&&(Je.instance.generateRegionChoices(),this.scene.get("WorldScene")._refreshRegions())),!1===e.explored&&(this.region.exploreTile(e.x,e.y),this.progression.registerTileExplored(),!0===this.autoExploreActive)){var t=this.region.nextWeakestTile();-1!==t[0]&&this._exploreTile(t[0],t[1],!0)}}_updateTile(e){var t=e.color;e.borderColor;if(!1===e.revealed?(t=Phaser.Display.Color.GetColor(0,0,0),Phaser.Display.Color.GetColor(40,80,40)):!1===e.explored&&!0===e.revealed&&(t=Pe.colorLerp(t,Phaser.Display.Color.GetColor(0,0,0),.65)),this.tileElements[e.y][e.x].rect.fillColor=t,void 0!==e.building){this.updateBuildings=!0;var i=this._getBuildingImage(e.x,e.y);if(void 0!==this.tileElements[e.y][e.x].building?this.tileElements[e.y][e.x].building.setTexture(i.sprite,i.tile):(this.tileElements[e.y][e.x].building=this.add.image(this.relativeX((e.x+.5)*this.WIDTH+this.offsetX),this.relativeY((e.y+.5)*this.HEIGHT+this.offsetY),i.sprite,i.tile),this.tileElements[e.y][e.x].building.displayWidth=48,this.tileElements[e.y][e.x].building.displayHeight=48),"Road"===e.building.name){if(e.x>0&&void 0!==this.region.map[e.y][e.x-1].building&&"Road"===this.region.map[e.y][e.x-1].building.name){var s=this._getBuildingImage(e.x-1,e.y);this.tileElements[e.y][e.x-1].building.setTexture(s.sprite,s.tile)}if(e.x<this.region.width-1&&void 0!==this.region.map[e.y][e.x+1].building&&"Road"===this.region.map[e.y][e.x+1].building.name){s=this._getBuildingImage(e.x+1,e.y);this.tileElements[e.y][e.x+1].building.setTexture(s.sprite,s.tile)}if(e.y>0&&void 0!==this.region.map[e.y-1][e.x].building&&"Road"===this.region.map[e.y-1][e.x].building.name){s=this._getBuildingImage(e.x,e.y-1);this.tileElements[e.y-1][e.x].building.setTexture(s.sprite,s.tile)}if(e.y<this.region.height-1&&void 0!==this.region.map[e.y+1][e.x].building&&"Road"===this.region.map[e.y+1][e.x].building.name){s=this._getBuildingImage(e.x,e.y+1);this.tileElements[e.y+1][e.x].building.setTexture(s.sprite,s.tile)}}}else void 0!==this.tileElements[e.y][e.x].building&&(this.tileElements[e.y][e.x].building.destroy(),this.tileElements[e.y][e.x].building=void 0)}changeRegion(){this.rebirth()}rebirth(){this.region.removeTileChanged(),this.region=Je.instance.getCurrentRegion(),this.region.onTileChanged(e=>{this._updateTile(e)});for(var e=0;e<this.region.height;e++)for(var t=0;t<this.region.width;t++)this.tileElements[e][t].rect.destroy(),void 0!==this.tileElements[e][t].building&&this.tileElements[e][t].building.destroy();this.tileElements=[];for(e=0;e<this.region.height;e++){var i=[];for(t=0;t<this.region.width;t++)i.push(this._setupTile(t,e));this.tileElements.push(i)}var s=this.region.invasionCounter/be;this.invasionLabel.setText("Invasion\n"+Math.floor(100*s)+"%"),this.invasionLabel.setVisible(this.progression.unlocks.buildings),this.autoExploreLabel.setVisible(this.progression.persistentUnlocks.autoExplore),this.autoExploreButton.setVisible(this.progression.persistentUnlocks.autoExplore)}_toggleAutoExplore(){this.autoExploreActive=!this.autoExploreActive,!0===this.autoExploreActive?(this.autoExploreButton.setText("ON"),this.autoExploreButton.setTextColor(Phaser.Display.Color.GetColor(255,255,255))):(this.autoExploreButton.setText("OFF"),this.autoExploreButton.setTextColor(Phaser.Display.Color.GetColor(175,0,140)))}create(){this.scene.get("CombatScene").registerEvent("onExplore",e=>{this._onExploredCallback(e)}),this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.invasionLabel=this.add.bitmapText(this.relativeX(720),this.relativeY(90),"courier20","Invasion",20,1),this.invasionLabel.setVisible(this.progression.unlocks.buildings);var e=this.region.invasionCounter/be;this.invasionLabel.setTint(Phaser.Display.Color.GetColor(40+215*e,40+215*e,40+215*e)),this.offlineLabel=this.add.bitmapText(this.relativeX(660),this.relativeY(140),"courier20","Offline Time: "+Je.instance.time.getOfflineTimeString()),this.speed1xButton=new Ze(this,this.relativeX(795),this.relativeY(160),30,20,"1x").onClickHandler(()=>{Je.instance.time.setTimeScale(1)}),this.speed2xButton=new Ze(this,this.relativeX(830),this.relativeY(160),30,20,"2x").onClickHandler(()=>{Je.instance.time.setTimeScale(2)}),this.speed5xButton=new Ze(this,this.relativeX(865),this.relativeY(160),30,20,"5x").onClickHandler(()=>{Je.instance.time.setTimeScale(5)}),this.autoExploreLabel=this.add.bitmapText(this.relativeX(660),this.relativeY(190),"courier20","Auto Explore:"),this.autoExploreButton=new Ze(this,this.relativeX(795),this.relativeY(190),40,20,"OFF").onClickHandler(()=>{this._toggleAutoExplore()}),this.autoExploreButton.setTextColor(Phaser.Display.Color.GetColor(175,0,140)),this.autoExploreLabel.setVisible(this.progression.persistentUnlocks.autoExplore),this.autoExploreButton.setVisible(this.progression.persistentUnlocks.autoExplore),this.floatingText=void 0,this.tileElements=[];for(var t=0;t<this.region.height;t++){for(var i=[],s=0;s<this.region.width;s++)i.push(this._setupTile(s,t));this.tileElements.push(i)}for(t=0;t<this.region.height;t++)this.add.bitmapText(this.relativeX(this.offsetX-this.WIDTH/2),this.relativeY(this.offsetY+(t+.5)*this.HEIGHT),"courier20",this.letters[t]).setOrigin(.5);for(t=0;t<this.region.width;t++)this.add.bitmapText(this.relativeX(this.offsetX+(t+.5)*this.WIDTH),this.relativeY(this.offsetY-this.HEIGHT/2),"courier20",""+(t+1)).setOrigin(.5);this.progression.addOnUnlockHandler((e,t,i)=>{this._handleProgressionEvent(e,t,i)}),this.region.onTileChanged(e=>{this._updateTile(e)})}update(e,t){if(this.offlineLabel.setText("Offline Time: "+Je.instance.time.getOfflineTimeString()),this.region.sightings.length>0){var i=this.region.invasionCounter/be;this.invasionLabel.setText("Invasion\n"+Math.floor(100*i)+"%"),this.invasionLabel.setTint(Phaser.Display.Color.GetColor(40+215*i,40+215*i,40+215*i)),this.sightingVal=(this.sightingVal+t)%2e3;for(var s=.5*Math.sin(this.sightingVal/2e3*Math.PI*2)+.5,a=0;a<this.region.sightings.length;a++){var r=this.region.sightings[a];!0===this.region.map[r[0]][r[1]].isInvaded&&this.region.map[r[0]][r[1]].invasionPower>=ve&&(this.tileElements[r[0]][r[1]].rect.fillColor=Pe.colorLerp(this.region.map[r[0]][r[1]].color,Phaser.Display.Color.GetColor(255,0,255),s))}}if(this.updateBuildings){this.updateBuildings=!1;for(a=0;a<this.region.roads.length;a++){var n=this.region.roads[a],o=this._getBuildingImage(n[1],n[0]);this.tileElements[n[0]][n[1]].building.setTexture(o.sprite,o.tile)}}}}class at{constructor(e,t,i,s,a,r,n,o){this.backgroundRect=e.add.rectangle(t,i,s,a,n).setOrigin(0,0),this.fillRect=e.add.rectangle(t+1,i+1,s-2,a-2,r).setOrigin(0,0),this.width=s,this.height=a,this.progressText=e.add.bitmapText(t+s/2,i+a/2,"courier16",o).setOrigin(.5,.5)}setPosition(e,t){this.backgroundRect.setPosition(e,t),this.fillRect.setPosition(e+1,t+1),this.progressText.setPosition(e+this.width/2,t+this.height/2)}setVisible(e){this.backgroundRect.setVisible(e),this.fillRect.setVisible(e),this.progressText.setVisible(e)}setFillPercent(e,t=""){e=Math.max(0,Math.min(1,e)),this.fillRect.displayWidth=Math.floor(e*(this.width-2)),this.progressText.setText(t)}}class rt{constructor(e,t,i){this.x=t,this.y=i,this.backingRect=e.add.rectangle(t,i,250,170,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(200,0,0),this.backingRect.lineWidth=2,this.imageRect=e.add.rectangle(t+5,i+5,64,64,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0),this.imageRect.isStroked=!0,this.imageRect.strokeColor=Phaser.Display.Color.GetColor(200,0,0),this.imageRect.lineWidth=2,this.image=e.add.image(t+5,i+5,"enemyicons",63).setOrigin(0),this.image.displayWidth=64,this.image.displayHeight=64,this.nameLabel=e.add.bitmapText(t+75,i+5,"courier20",""),this.damageLabel=e.add.bitmapText(t+75,i+25,"courier16",""),this.armorLabel=e.add.bitmapText(t+75,i+45,"courier16",""),this.hitnameLabel=e.add.bitmapText(t+75,i+65,"courier16",""),this.evasionLabel=e.add.bitmapText(t+75,i+85,"courier16",""),this.healthBar=new at(e,t+5,i+125,240,14,Phaser.Display.Color.GetColor(170,0,0),Phaser.Display.Color.GetColor(32,32,32)),this.attackBar=new at(e,t+5,i+145,240,14,Phaser.Display.Color.GetColor(0,140,40),Phaser.Display.Color.GetColor(32,32,32))}initWithCreature(e){this.nameLabel.setText(e.name),this.damageLabel.setText("Damage: "+Pe.numberString(Math.floor(e.DamageMin()))+"-"+Pe.numberString(Math.floor(e.DamageMax()))),this.armorLabel.setText("Armor: "+Pe.numberString(Math.floor(e.Armor()))),this.hitnameLabel.setText("Hit: "+Pe.numberString(Math.floor(e.Hit()))),this.evasionLabel.setText("Evasion: "+Pe.numberString(Math.floor(e.Evasion()))),this.healthBar.setFillPercent(e.currentHealth/e.MaxHealth()),this.attackBar.setFillPercent(e.attackCooldown/e.attackSpeed),this.image.setTexture(e.icon.sprite,e.icon.tile)}setVisible(e){this.backingRect.setVisible(e),this.imageRect.setVisible(e),this.image.setVisible(e),this.nameLabel.setVisible(e),this.damageLabel.setVisible(e),this.armorLabel.setVisible(e),this.hitnameLabel.setVisible(e),this.evasionLabel.setVisible(e),this.healthBar.setVisible(e),this.attackBar.setVisible(e)}setHealthBar(e,t=""){this.healthBar.setFillPercent(e,t)}setAttackBar(e,t=""){this.attackBar.setFillPercent(e,t)}getCenterX(){return this.x+125}getCenterY(){return this.y+85}}class nt{static getAttackSpeedMultiplier(e,t){return Math.pow(e,P)/Math.pow(t,P)}static getAnimInfoFromKey(e){var t=[];switch(e){case"claws":case"clawscrit":t.push({frameId:0,duration:80}),t.push({frameId:1,duration:80}),t.push({frameId:2,duration:80}),t.push({frameId:3,duration:80})}return t}}class ot{constructor(e,t,i,s,a,r){this.animInfo=a,this.frameIdx=0,this.duration=0,this.onCompleteCallback=r,this.spriteObj=e.add.image(t,i,s,a[0].frameId)}update(e){this.duration+=e,this.duration>this.animInfo[this.frameIdx].duration&&(this.duration-=this.animInfo[this.frameIdx].duration,this.frameIdx++,this.frameIdx>=this.animInfo.length&&(this.frameIdx=this.frameIdx%this.animInfo.length,void 0!==this.onCompleteCallback&&this.onCompleteCallback()),this.spriteObj.setFrame(this.animInfo[this.frameIdx].frameId))}destroy(){this.spriteObj.destroy()}}class ht extends s{constructor(e,t){super(e,t),this.tileRef=void 0,this.combatActive=!1,this.monsters=[],this.player=new Fe,this.globalAttackCooldown=0,this.onKillHandlers=[],this.onExploreHandlers=[],this.target=0,this.playerHitAnim=void 0,this.monsterHitAnim=[void 0,void 0,void 0],this.progression=new Ee}enableScene(){}disableScene(){}_monstersAlive(){for(var e=0;e<this.monsters.length;e++)if(this.monsters[e].currentHealth>0)return!0;return!1}_getTarget(){if(!1===this._monstersAlive())return 0;for(var e=Pe.randint(0,this.monsters.length);this.monsters[e].currentHealth<=0;)e=(e+1)%this.monsters.length;return e}_creatureWorkaround(e){this.monsterDiplays[e].setVisible(!0),this.monsterDiplays[e].initWithCreature(this.monsters[e]),this.monsters[e].registerEvent("onHealthChanged",t=>{this._monsterHealthCallback(t,e)}),this.monsters[e].registerEvent("onAttackCooldownChanged",t=>{this._monsterAttackCooldownCallback(t,e)}),this._monsterHealthCallback(this.monsters[e].currentHealth,e)}_setupCreatures(){if(this.monsters=this.tileRef.generateMonsters(),Ie.instance.moonperks.direbeasts.level>0)for(var e=0;e<this.monsters.length;e++)Math.random()<.05&&this.monsters[e].addTemplate("Dire");for(e=0;e<this.monsterDiplays.length;e++)this.monsterDiplays[e].setVisible(!1);for(e=0;e<this.monsters.length;e++)this._creatureWorkaround(e)}_playerHealthCallback(e){this.playerDisplay.setHealthBar(e/this.player.statBlock.MaxHealth(),Pe.numberString(Math.floor(e))+"/"+Pe.numberString(this.player.statBlock.MaxHealth()))}_playerAttackCooldownCallback(e){this.playerDisplay.setAttackBar(e/this.player.statBlock.attackSpeed,Math.floor(e/this.player.statBlock.attackSpeed*100)+"%")}_monsterHealthCallback(e,t){this.monsterDiplays[t].setHealthBar(e/this.monsters[t].MaxHealth(),Pe.numberString(Math.floor(e))+"/"+Pe.numberString(this.monsters[t].MaxHealth()))}_monsterAttackCooldownCallback(e,t){this.monsterDiplays[t].setAttackBar(e/this.monsters[t].attackSpeed,Math.floor(e/this.monsters[t].attackSpeed*100)+"%")}_updatePlayerBlock(){this.playerDisplay.initWithCreature(this.player.statBlock)}_onKill(e,t,i,s){for(var a=0;a<this.onKillHandlers.length;a++)this.onKillHandlers[a](e,t,i,s)}_onExplore(e){for(var t=0;t<this.onExploreHandlers.length;t++)this.onExploreHandlers[t](e)}_hideEnemyDisplays(){for(var e=0;e<this.monsterDiplays.length;e++)this.monsterDiplays[e].setVisible(!1)}_setupPlayerAnim(e,t=!1){void 0!==this.playerHitAnim&&this._removePlayerAnim();var i=this.playerDisplay.getCenterX(),s=this.playerDisplay.getCenterY(),a=!0===t?e.critAnim:e.hitAnim;this.playerHitAnim=new ot(this,i,s,a,nt.getAnimInfoFromKey(a),()=>{this._removePlayerAnim()})}_removePlayerAnim(){this.playerHitAnim.destroy(),this.playerHitAnim=void 0}_setupMonsterAnim(e,t=!1){void 0!==this.monsterHitAnim[e]&&this._removeMonsterAnim(e);var i=this.monsterDiplays[e].getCenterX(),s=this.monsterDiplays[e].getCenterY(),a=!0===t?this.player.statBlock.critAnim:this.player.statBlock.hitAnim;this.monsterHitAnim[e]=new ot(this,i,s,a,nt.getAnimInfoFromKey(a),()=>{this._removeMonsterAnim(e)})}_removeMonsterAnim(e){this.monsterHitAnim[e].destroy(),this.monsterHitAnim[e]=void 0}_restHandler(){!0===this.combatActive?(this.restButton.setText("Explore"),this.combatActive=!1):(this.restButton.setText("Rest"),this.initFight(this.tileRef))}registerEvent(e,t){"onKill"===e?this.onKillHandlers.push(t):"onExplore"===e&&this.onExploreHandlers.push(t)}initFight(e){this.combatActive=!0,this.tileRef=e,this.tileRef.fightCooldown>0?this._hideEnemyDisplays():(this._setupCreatures(),this.target=this._getTarget(),this.restButton.setVisible(!1)),this.playerDisplay.initWithCreature(this.player.statBlock)}rebirth(){this.tileRef=void 0,this.combatActive=!1,this.monsters=[],this.globalAttackCooldown=0,this._hideEnemyDisplays()}preload(){this.load.spritesheet("claws","./../../assets/anims/clawanim.png",{frameWidth:128,frameHeight:128}),this.load.spritesheet("clawscrit","./../../assets/anims/clawanimcrit.png",{frameWidth:128,frameHeight:128})}create(){this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.explorationBar=new at(this,this.relativeX(10),this.relativeY(10),880,20,Phaser.Display.Color.GetColor(0,0,255),Phaser.Display.Color.GetColor(32,32,64)),this.monsterDiplays=[],this.monsterDiplays.push(new rt(this,this.relativeX(325),this.relativeY(70))),this.monsterDiplays.push(new rt(this,this.relativeX(100),this.relativeY(170))),this.monsterDiplays.push(new rt(this,this.relativeX(550),this.relativeY(170))),this.playerDisplay=new rt(this,this.relativeX(325),this.relativeY(460)),this.playerDisplay.initWithCreature(this.player.statBlock),this._hideEnemyDisplays(),this.restButton=new Ze(this,this.relativeX(800),this.relativeY(40),80,20,"Rest").onClickHandler(()=>{this._restHandler()}),this.player.statBlock.registerEvent("onHealthChanged",e=>{this._playerHealthCallback(e)}),this.player.statBlock.registerEvent("onAttackCooldownChanged",e=>{this._playerAttackCooldownCallback(e)}),this.player.registerEvent("onStatChanged",()=>{this._updatePlayerBlock()})}_updateAnimations(e){void 0!==this.playerHitAnim&&this.playerHitAnim.update(e);for(var t=0;t<this.monsterHitAnim.length;t++)void 0!==this.monsterHitAnim[t]&&this.monsterHitAnim[t].update(e)}isInCombat(){return!0===this.combatActive&&this.globalAttackCooldown<=0&&this.tileRef.fightCooldown<=0}update(e,t){var i=Je.instance.time.frameDelta;if(this._updateAnimations(i),!1!==this.combatActive)if(this.globalAttackCooldown>0)this.globalAttackCooldown-=i;else{if(this.tileRef.fightCooldown>0){this.tileRef.fightCooldown-=i;var s=(new Je).getCurrentRegion(),a=(1+.1*this.player.talents.explorer.level)*s.townData.exploreMulti*(1+N*Math.pow(this.player.statBlock.Agility(),V))*We.instance.exploreSpeed*this.player.challengeExploreMulti;return this.tileRef.explore(i*a),this.tileRef.amountExplored>=this.tileRef.explorationNeeded?this.explorationBar.setFillPercent(this.tileRef.amountExplored/this.tileRef.explorationNeeded,"Explored"):this.explorationBar.setFillPercent(this.tileRef.amountExplored/this.tileRef.explorationNeeded,Math.floor(this.tileRef.amountExplored/this.tileRef.explorationNeeded*100)+"%"),this.tileRef.amountExplored>=this.tileRef.explorationNeeded&&!1===this.tileRef.explored&&this._onExplore(this.tileRef),void(this.tileRef.fightCooldown<=0&&(this._setupCreatures(),this.target=this._getTarget(),this.restButton.setVisible(!1)))}if(!0===this._monstersAlive()){for(var r=0;r<this.monsters.length;r++)if(!(this.monsters[r].currentHealth<=0)){var n=nt.getAttackSpeedMultiplier(this.monsters[r].Hit(),this.player.statBlock.Evasion());if(this.monsters[r].tickAttackCooldown(i,n),this.monsters[r].tickRegen(i),!0===this.monsters[r].canAttack()){var o=this.monsters[r].CritChance()>Math.random();this.monsters[r].attack(this.player.statBlock,o);return this._setupPlayerAnim(this.monsters[r],o),void(this.globalAttackCooldown=150)}}n=nt.getAttackSpeedMultiplier(this.player.statBlock.Hit(),this.monsters[this.target].Evasion());if(this.player.statBlock.tickAttackCooldown(i,n),!0===this.player.statBlock.canAttack()){o=this.player.statBlock.CritChance()>Math.random(),this.player.statBlock.attack(this.monsters[this.target],o);if(this._setupMonsterAnim(this.target,o),this.player.talents.cleave.level>0&&Math.random()<.2){var h=this.target;for(r=0;r<this.monsters.length;r++){var l=(h+r)%this.monsters.length;if(void 0!==this.monsters[l]&&this.monsters[l].currentHealth>0){h=l;break}}h!==this.target&&(o=this.player.statBlock.CritChance()>Math.random(),this.player.statBlock.cleave(this.monsters[h],o),this._setupMonsterAnim(h,o))}this.target=this._getTarget(),this.globalAttackCooldown=150}if(!1===this._monstersAlive()){var c=[0,0,0,0,0,0],d=0,u=0,g=0;for(r=0;r<this.monsters.length;r++){u+=1+Math.floor(Math.max(1,this.monsters[r].level)/5),d+=this.monsters[r].xpReward,g+=this.monsters[r].motes;for(var m=this.player.talents.bounty.level,p=1+m/10+(m%10/10>Math.random()?1:0),v=0;v<p;v++){var b=Pe.randint(0,this.monsters[r].drops.length),f=Math.max(1,this.monsters[r].level-Math.max(0,20*Math.min(8,Math.floor(this.monsters[r].level/20))));c[this.monsters[r].drops[b].type]+=Math.max(0,this.monsters[r].drops[b].amount*f)}}if(this.player.statBlock.encounterCounter-=1,this._onKill(this.tileRef,d,c,u),this.player.addMote(g),this._hideEnemyDisplays(),this.tileRef.fightCooldown=oe,!0===this.tileRef.isInvaded){!1===this.progression.unlocks.motes&&this.progression.registerFeatureUnlocked(y,"Well it happened. Some big bad monsters came back to spew their horrible mists all over the place again, but fortunately for you you had prepared for this. After killing the great misty one in the back it dropped something you haven't seen before... sort of like Shade, but like, more solid. You should probably just call them Motes of Darkness. I'm sure the townsfolk will be super impressed if you bring this dumb stone back and call it that.\n\nOh, you can probably try putting it on your weapon if you really wanted to. It's up to you.");var x=new Ie;if(this.player.addMote(1+x.moonperks.heartofdarkness.level),this.tileRef.invasionFights-=1,this.tileRef.invasionFights<=0)s=(new Je).getCurrentRegion().endSighting(this.tileRef.x,this.tileRef.y)}this.restButton.setVisible(!0)}this.player.statBlock.currentHealth<=0&&(this.player.statBlock.currentHealth=0,this._hideEnemyDisplays(),this.combatActive=!1,this.progression.registerDeath(1),this.restButton.setVisible(!0))}}}}class lt{constructor(e,t,i,s,a,r,n){var o=Pe.processText(s,a);this.textLabel=e.add.bitmapText(t,i,r,o,n),this.height=this.textLabel.getTextBounds(!0).local.height+5,this.separator=e.add.rectangle(t+10,i+this.height,t+a*n-20,4,Phaser.Display.Color.GetColor(64,64,64)).setOrigin(0,0),this.x=t,this.y=i}getHeight(){return this.y+this.height+10}getPosX(){return this.x}getPosY(){return this.y}setPosition(e,t){this.textLabel.setPosition(e,t),this.separator.setPosition(e,t+this.height)}destroy(){this.textLabel.destroy(),this.separator.destroy()}}class ct{constructor(){return ct.instance||(this.lore=[],ct.instance=this),ct.instance}rebirth(){this.lore=[]}addLore(e){this.lore.push(e)}save(){return{lore:this.lore}}load(e,t){this.lore=e.lore}}class dt extends s{constructor(e,t){super(e,t),this.labels=[],this.labelIndex=0,this.loreStore=new ct,this.labelCount=void 0}relativeX(e){return super.relativeX(e)+1e3}rebirth(){this.cameras.getCamera("loreBox").scrollY=this.relativeY(0);for(var e=0;e<this.labels.length;e++)this.labels[e].destroy();this.labels=[],this.labelIndex=0}create(){this.cameras.add(super.relativeX(0),this.relativeY(30),900,670,!1,"loreBox"),this.cameras.getCamera("loreBox").scrollX=this.relativeX(0),this.cameras.getCamera("loreBox").scrollY=this.relativeY(0),this.add.rectangle(super.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.progresion=new Ee,this.progresion.addOnUnlockHandler((e,t,i)=>{this._handleProgressionEvents(e,t,i)}),this.upButton=new Ze(this,super.relativeX(20),this.relativeY(5),60,20,"up"),this.upButton.onClickHandler(()=>{this._scrollUp()}),this.downButton=new Ze(this,super.relativeX(80),this.relativeY(5),60,20,"down"),this.downButton.onClickHandler(()=>{this._scrollDown()});for(var e=0;e<this.loreStore.lore.length;e++)this.addText(this.loreStore.lore[e],!1);this._scrollTo(this.labels.length-1),this.labelCount=this.add.bitmapText(super.relativeX(170),this.relativeY(5),"courier20",this.labelIndex+1+"/"+this.labels.length)}_scrollUp(){this.labelIndex>0&&(this.labelIndex-=1),this._scrollTo(this.labelIndex)}_scrollDown(){this.labelIndex<this.labels.length-1&&(this.labelIndex+=1),this._scrollTo(this.labelIndex)}_scrollTo(e){e<0||e>=this.labels.length||(this.labelIndex=e,this.cameras.getCamera("loreBox").scrollY=this.labels[this.labelIndex].getPosY()-10,void 0!==this.labelCount&&this.labelCount.setText(this.labelIndex+1+"/"+this.labels.length))}_handleProgressionEvents(e,t,i){void 0!==i&&""!==i&&this.addText(i)}addText(e,t=!0){!0===t&&this.loreStore.addLore(e);var i=this.relativeX(10),s=this.relativeY(10);0!==this.labels.length&&(i=this.labels[this.labels.length-1].getPosX(),s=this.labels[this.labels.length-1].getHeight()),this.labels.push(new lt(this,i,s,e,85,"courier20",20)),void 0!==this.labelCount&&this.labelCount.setText(this.labelIndex+1+"/"+this.labels.length)}}class ut{static getTalentTooltip(e){switch(e.name){case"Strength":return"Each point of Strength increases your damage more. Increases Damage gained by Strength by "+5*e.level+"% + (5%).";case"Dexterity":return"Each point of Dexterity gives more Hit. You gain "+(7+e.level)+" + (1) Hit per Dexterity.";case"Agility":return"Each point of Agility gives more Evasion. You gain "+(7+e.level)+" + (1) Evasion per Agility.";case"Endurance":return"Get more health from Endurance. You gain "+(5+e.level)+" + (1) max Health per Endurance.";case"Recovery":return"Heal wounds as fast as you get them! Increases Health Regen from Recovery by "+5*e.level+"% + (5%).";case"Defense":return"Get more armor from Defense. Increases Armor from Defense by "+10*e.level+"% + (10%).";case"Accuracy":return"Crit even harder. You gain "+(2.5+.5*e.level)+"% + (0.5%) Crit Damage per Accuracy.";case"Hit":return"Gain even more Hit from all sources. Increase your Hit by "+2*e.level+"% + (2%).";case"Evasion":return"Gain even more Evasion from all sources. Increase your Evasion by "+2*e.level+"% + (2%).";case"Critical":return"Everyone loves to crit, so here is some free crit chance. Increase your crit chance by "+1*e.level+"% + (1%).";case"Bounty":return"Somehow improves how much loot enemies drop. Increases your perception or something? Gain a "+10*e.level+"% + (10%) chance for enemies to drop loot twice.";case"Explorer":return"If you want to explore fast you gotta go fast. Increases your explore speed by "+10*e.level+"% + (10%).";case"Cleave":return"Hit everything super hard. You gain a 20% chance your attacks hit an additional target dealing "+20*e.level+"% + (20%) of your Strength in damage";case"Resilient":return"Brush off critical attacks like they were merely normal attacks. When hit by a crit you reduce the damage by "+5*e.level+"% + (5%) of your Endurance, to a minimum of 2.";case"Quick Recovery":return"All you need is a quick rest between fights and your good to go. Your Health Regen increases by "+25*e.level+"% + (25%) while out of combat.";case"Block":return"Your mastery of defense allows you to sometimes block part of a hit, isn't that great? You have a 20% chance to block "+25*e.level+" + (25%) of your Defense worth of damage.";case"Stunning Hit":return"Hit them so hard you leave them concussed, causing serious long term damage. Each attack has a "+5*e.level+"% + (5%) chance to halt their attack bar for 0.5 seconds.";case"Follow Through":return"The best attacks are those that are immediately followed by more attacks. After attacking, gives a "+5*e.level+"% + (5%) chance that your attack bar starts half full, or half empty if you prefer.";case"Dodge":return"All the Hit in the world can't touch you some of the time. You automatically dodge every "+(13-e.level)+" - (1) Attacks against you.";case"Defy Death":return"Have you tried just... not dying? The next time you take lethal damage, you survive at 1 Health. Can be used again after "+(8-e.level)+" - (1) encounters. I didn't even know I tracked encounters!";case"Second Wind":return"All the best heroes are able to get right back to it after a beat down. When you drop below 50% health your Health Regen is tripled for 10 seconds. Has a "+(80-10*e.level)+" - (10) second cooldown.";case"Parry":return"Why block when you can parry? gives a "+5*e.level+"% + (5%) chance an enemy causes a glancing hit, dealing half damage. Thats still something, right?";case"Double Crit":return"Crit so hard your crits have crits. Gain a chance to crit twice, doubling your crit damage for the attack. Double crit chance is "+1*e.level+"% + (1%) of your normal crit chance.";case"Guardian":return"Getting invaded while you weren't paying attention sucks. Isn't this supposed to be an idle game? Invasions build up "+25*e.level+"% + (25%) slower.";case"Governance":return"Spend less time fighting things and more time learning how they can fight for you! Increases economy and production by "+3*e.level+"% + (3%). This effect is multiplicative, not additive."}}static getBuildingTooltip(e,t){switch(e){case"Lumberyard":return"Produces "+t+"x this tile's Wood yield at the end of each day.";case"Hunter's Lodge":return"Produces "+t+"x this tile's Leather yield at the end of each day.";case"Mine":return"Produces "+t+"x this tile's Metal yield at the end of each day.";case"Herbalist's Hut":return"Produces "+t+"x this tile's Fiber yield at the end of each day.";case"Quarry":return"Produces "+t+"x this tile's Stone yield at the end of each day.";case"Crystal Loom":return"Produces "+t+"x this tile's Crystal yield at the end of each day.";case"Town House":return"Increases the Town's max population by "+5*t+".";case"Watch Tower":return"Increases the defense of all tiles within 2 tiles of this watch tower by "+2*t+".";case"Market":return"Increases the Town's economy by 0-"+10*t+"%, based on distance to the Town and other Markets. Reaches max bonus at 4 tiles.";case"Tavern":return"Increases the Town's economy by "+2*t+"% per house adjacent to them.";case"Road":return"Most buildings must be built adjacent to roads. Production buildings get a boost being adjacent to a road, and produce nothing when more than "+t+" tiles away.";case"Docks":return"Docks don't need roads and enables roads to be built beside them. Increases gold earned per week by "+2*t+", applied before any economy bonus."}}static getTechTooltip(e,t){switch(e.name){case"Forge":return"Each level reduces crafting costs of T"+t+" gear and below by 5%. Don't ask me how this works.";case"Guilds":return"Each level increases resource gain from buildings by 10%.";case"Town Hall":return"Each level increases Bounty gold from killing monsters in this region by 10%. The best quest is the one that pays the most.";case"Market":return"Unlocks the Market. Once built the Market increases tax income by 0-10% based on distance to the Town and other Markets.";case"Tavern":return"Everyone Needs a drink. Unlocks the Tavern, combining your two loves, getting more money and people that pay you money.";case"Reinforced Houses":return"Every man's home is a castle, but more literal. Increases the defense of all buildings by 1.";case"Banking":return"Learn how to make money from nothing! Each level increases tax income by 5% and increases your base gold cap by 50.";case"Map Making":return"Instead of wandering aimlessly, get some villagers to make some maps. Increases exploration speed by 10%."}}static getMoonlightTooltip(e){switch(e.name){case"Moon's Strength":return"Increases your starting Strength by "+e.level+" + (1) and increases Strength from all sources by "+e.level+"% + (1%).";case"Moon's Dexterity":return"Increases your starting Dexterity by "+e.level+" + (1) and increases Dexterity from all sources by "+e.level+"% + (1%).";case"Moon's Agility":return"Increases your starting Agility by "+e.level+" + (1) and increases Agility from all sources by "+e.level+"% + (1%).";case"Moon's Endurance":return"Increases your starting Endurance by "+e.level+" + (1) and increases Endurance from all sources by "+e.level+"% + (1%).";case"Moon's Recovery":return"Increases your starting Recovery by "+e.level+" + (1) and increases Recovery from all sources by "+e.level+"% + (1%).";case"Moon's Defense":return"Increases your starting Defense by "+e.level+" + (1) and increases Defense from all sources by "+e.level+"% + (1%).";case"Moon's Accuracy":return"Increases your starting Accuracy by "+e.level+" + (1) and increases Accuracy from all sources by "+e.level+"% + (1%).";case"Hero's Vault":return"Increases the base income per villager by "+.1*e.level+" + (0.1) gold.";case"Moonwine":return"Taverns count Town Houses within "+(1+e.level)+" + (1) tiles for their bonus.";case"Hardened Villagers":return"Buildings have "+e.level+" + (1) more defense.";case"Shadow's Blessing":return"You gain "+10*e.level+"% + (10%) more shade from monsters.";case"Moon Runes":return"Unlocks Runes. Runes can be found after exploring a tile and can be socketed into gear to provide a random set of bonuses.";case"Dire Beasts":return"Dire versions of beasts can be found which are much stronger than their normal counterparts. Defeating them grants bonus shade, resources, and Motes of Darkness.";case"Heart of Darkness":return"Defeating invasion monsters give "+e.level+" + (1) additional Motes of Darkness.";case"Blackiron Gear":return"Motes of Darkness can reach a "+(20+10*e.level)+"% + (10%) bonus before diminishing returns.";case"Runelands":return"Each region contains "+(1+e.level)+" + (1) hidden runes.";case"Moonlight Workers":return"Production buildings generate "+e.level+"% + (1%) more resources per defense.";case"Hero's Pouch":return"Increases your gold cap by "+100*e.level+" + (100) per town.";case"Night Market":return"Markets increase your economy by 0-"+(10+e.level)+"% + (1%) based on distance between the Town and other Markets."}}static getRegionTooltip(e){switch(e){case"temperate":return"A balanced area where all resources are equally abundant.";case"mountains":return"Mountains and plateau's as far as the eye can see. Home to flying beasts, there is plenty of metal and stone to be found here.";case"desert":return"A hot desert full of horrible creatures with the occasional dry plains full of hungry beasts. At least the crystals shine in the moonlight.";case"forest":return"A massive forest full of the oldest trees waiting to be cut down, beasts to be hunted and plants to be gathered.";case"hills":return"Rolling hills with few plains between them. Full of wild beasts, plants, and the Gnoll's who hunt them."}}static getChallengeDescription(e){switch(e.name){case"A Matter of Years":return"Now that you've reached out into the world and understand the basics why not do it again, but faster. As they say, practice makes perfect!\n\nRestrictions: Reach the 2nd Gate within "+(10-e.completions)+" Years.\n\nOn First Completion: Unlock new challenges.\nOn Every Completion: Increases moonlight earned by 10%\n                     +1 Challenge Point\n\nIt is possible to fail this challenge!\n\nCompletions: "+e.completions+"/"+e.maxCompletions+"\nFastest Time: "+new Qe(e.fastestTime).getTimespanText();case"Forged Ahead":return"Those forge upgrades sure are useful, especially now that all your gear costs "+(10+5*e.completions)+" times as much.\n\nRestrictions: Gear costs increased by "+(10+5*e.completions)+" times.\n              Reach the 2nd Gate.\n\nOn Every Completion: Gear costs are multiplied by x0.95\n                     +1 Challenge Points\n\nCompletions: "+e.completions+"/"+e.maxCompletions+"\nFastest Time: "+new Qe(e.fastestTime).getTimespanText();case"Vast Continent":return"A Hero must be able to reach all those in need, even the ones really really really far away.\n\nRestrictions: Explore speed is reduced by 25\n              Reach Gate "+(1+e.completions)+".\n\nOn First Completion: Increases explore speed by 25%\nOn Every Completion: Increases explore speed by 10%\n                     +2 Challenge Points\n\nCompletions: "+e.completions+"/"+e.maxCompletions+"\nFastest Time: "+new Qe(e.fastestTime).getTimespanText();case"Forgotten Labor":return"None of the townsfolk in this realm know how to work. Either that or they're just really lazy.\n\nRestrictions: Production buildings are unavailable.\n              Reach Gate "+(1+e.completions)+".\n\nOn First Completion: Unlock the Warehouse building.\nOn Every Completion: Increases building production by 3%\n                     +3 Challenge Points\n\nCompletions: "+e.completions+"/"+e.maxCompletions+"\nFastest Time: "+new Qe(e.fastestTime).getTimespanText();case"Talentless":return"You rely way too much on those talents. Let's see you get through without them.\n\nRestrictions: Talents are removed.\n              Reach Gate "+(1+e.completions)+".\n\nOn First Completion: Talent costs scale slightly slower.\nOn Every Completion: Start with +1 Talent points.\n                     +3 Challenge Points\n\nCompletions: "+e.completions+"/"+e.maxCompletions+"\nFastest Time: "+new Qe(e.fastestTime).getTimespanText()}}}class gt{constructor(e,t,i,s,a){this.tech=s,this.townTier=a,this.backingRect=e.add.rectangle(t+1,i+1,648,113,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(200,112,65),this.backingRect.lineWidth=1,this.nameLabel=e.add.bitmapText(t+5,i+5,"courier20",s.name+" Lv"+s.level),this.nameLabel.setTint(Phaser.Display.Color.GetColor(212,175,55));var r=Pe.processText(ut.getTechTooltip(s,a),77);this.descLabel=e.add.bitmapText(t+5,i+25,"courier16",r);for(var n="Cost: "+Ve.getTechGoldCost(s,a)+" Gold",o=Ve.getTechResourceCost(s,a),h=0;h<o.length;h++)o[h]>0&&(n+=", "+Pe.getCostText(h,o[h]));n=Pe.processText(n,67),this.costLabel=e.add.bitmapText(t+5,i+80,"courier16",n),-1!==s.maxLevel&&s.level>=s.maxLevel?(this.buyBtn=new Ze(e,t+545,i+90,100,20,"Maxed").onClickHandler(()=>{this._onClick()}),this.buyBtn.setEnable(!1)):this.buyBtn=new Ze(e,t+545,i+90,100,20,"Upgrade").onClickHandler(()=>{this._onClick()}),this.onClickHandlers=[]}registerClick(e){return this.onClickHandlers.push(e),this}_onClick(){for(var e=0;e<this.onClickHandlers.length;e++)this.onClickHandlers[e]()}destroy(){this.backingRect.destroy(),this.nameLabel.destroy(),this.descLabel.destroy(),this.costLabel.destroy(),this.buyBtn.destroy()}}class mt extends s{constructor(e,t){super(e,t),this.showBuildings=!0}rebirth(){this.showBuildings=!0,this._updateStatus(),this.upgradesBtn.setVisible(!1)}changeRegion(){this._updateStatus(),this.upgradesBtn.setVisible(Je.instance.getCurrentRegion().townData.researchEnabled)}create(){var e=new Ee;this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.townNameLabel=this.add.bitmapText(this.relativeX(10),this.relativeY(10),"courier20","Town"),this.regionNameLabel=this.add.bitmapText(this.relativeX(10),this.relativeY(30),"courier16","Region 1"),this.statsLabel=this.add.bitmapText(this.relativeX(15),this.relativeY(50),"courier16","Region 1"),this.buildingBtn=new Ze(this,this.relativeX(240),this.relativeY(10),120,20,"Buildings").onClickHandler(()=>{this._showBuildings(!0)}),this.upgradesBtn=new Ze(this,this.relativeX(370),this.relativeY(10),120,20,"Research").onClickHandler(()=>{this._showBuildings(!1)}),this.upgradesBtn.setVisible(Je.instance.getCurrentRegion().townData.researchEnabled),this.buildingDisplays=[],this._updateStatus(),(new Je).time.registerEvent("onDayEnd",()=>{this._endOfDay()}),e.addOnUnlockHandler((e,t,i)=>{this._handleProgressionChange(e)})}_handleProgressionChange(e){e===g&&this.upgradesBtn.setVisible(!0)}_setupTechDisplay(e,t,i,s){return new gt(this,e,t,i,s).registerClick(()=>{this._handleTechUpgrade(i)})}_handleTechUpgrade(e){var t=Je.instance.getCurrentRegion(),i=Ve.getTechGoldCost(e,t.townData.tier),s=Ve.getTechResourceCost(e,t.townData.tier),a=new Fe;a.gold>=i&&!0===Pe.canCraft(s,a.resources[t.townData.tier-1])&&(a.addGold(-i),a.spendResource(s,t.townData.tier-1),t.townData.increaseTechLevel(e),this._updateStatus())}_showBuildings(e){this.showBuildings=e,this._updateStatus()}_updateStatus(){for(var e=Je.instance.getCurrentRegion(),t=new Fe,i=1+.03*t.talents.governance.level,s="Population: "+Math.floor(e.townData.currentPopulation)+"/"+Math.floor(e.townData.getMaxPopulation())+"\nTax Income: "+Math.floor(e.townData.getTownIncome())+"g/week\nT"+e.townData.tier+" Crafting Cost: "+Math.floor(1e4*t.craftingCosts[e.townData.tier-1])/100+"%\nEconomy: "+Math.floor(100*e.townData.economyMulti*i)+"%\nProduction: "+Math.floor(100*e.townData.productionMulti)+"%\nBounty Gold: "+Math.floor(100*e.townData.bountyMulti)+"%\nDaily Production:\n",a=0;a<e.resourcesPerDay.length;a++)s+="  "+R[a]+": "+Math.floor(e.resourcesPerDay[a]*e.townData.productionMulti*i*100)/100+"\n";this.statsLabel.setText(s);for(a=0;a<this.buildingDisplays.length;a++)this.buildingDisplays[a].destroy();if(!0===this.showBuildings){var r=0;for(const t in e.townData.buildings)this.buildingDisplays.push(this._setupTechDisplay(this.relativeX(240),this.relativeY(50+120*r),e.townData.buildings[t],e.townData.tier)),r+=1}else{r=0;for(const t in e.townData.upgrades)this.buildingDisplays.push(this._setupTechDisplay(this.relativeX(240),this.relativeY(50+120*r),e.townData.upgrades[t],e.townData.tier)),r+=1}}_endOfDay(){this._updateStatus()}}class pt{constructor(e,t,i,s){var a=new Ee;this.gear=s,this.backingRect=e.add.rectangle(t+1,i+1,283,208,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backingRect.lineWidth=1;var r=s.name+" Lv"+s.level;this.nameLabel=e.add.bitmapText(t+5,i+5,r.length>18?"courier16":"courier20",r);var n=["Weapon","Armor","Trinket"],o=0===s.tier?"Broken "+n[s.slotType]:"Tier "+s.tier+" "+n[s.slotType];if(this.typeLabel=e.add.bitmapText(t+5,i+25,"courier16",o),this.moteButton=void 0,this.moteLabel=void 0,this.motePower=0,s.level>0&&!0===a.unlocks.motes){var h=new Ge;this.motePower=h.getMotePower(s.motesFused),s.motesFused>0&&(this.moteLabel=e.add.bitmapText(t+243,i+21,"courier16","+"+Math.floor(1e3*this.motePower)/10+"%").setOrigin(1,.5),this.moteLabel.setTint(Phaser.Display.Color.GetColor(200,0,200))),this.moteButton=new $e(e,t+248,i+5,32,32,{sprite:"icons",tile:39}).onClickHandler(()=>{this._onFuse()})}this.statLabels=[];var l="";for(const e in s.statBonuses)0!==s.statBonuses[e]&&(l+=Pe.getBonusText(e,s.statBonuses[e]*(1+this.motePower))+"\n");if(this.statLabels.push(e.add.bitmapText(t+5,i+45,"courier16",l)),!0===a.unlocks.resourceUI){var c=new Fe,d=s.tier<=0?1:c.craftingCosts[s.tier-1];l="";for(var u=0;u<s.costs.length;u++)0!==s.costs[u]&&(l+=Pe.getCostText(u,Math.floor(s.costs[u]*d))+"\n");this.statLabels.push(e.add.bitmapText(t+175,i+45,"courier16",l))}this.equipBtn=void 0,this.upgradeBtn=void 0,0===s.level?(this.upgradeBtn=new Ze(e,t+72,i+185,135,20,"Forge"),this.upgradeBtn.onClickHandler(()=>{this._onUpgrade()})):!0===a.unlocks.resourceUI?(this.equipBtn=new Ze(e,t+5,i+185,135,20,"Equip"),this.equipBtn.onClickHandler(()=>{this._onEquip()}),this.upgradeBtn=new Ze(e,t+145,i+185,135,20,"Upgrade"),this.upgradeBtn.onClickHandler(()=>{this._onUpgrade()})):(this.equipBtn=new Ze(e,t+72,i+185,135,20,"Equip"),this.equipBtn.onClickHandler(()=>{this._onEquip()})),this.onEquipHandlers=[],this.onUpgradeHandlers=[],this.onFuseHandlers=[]}registerEvents(e,t){return"onEquip"===e?this.onEquipHandlers.push(t):"onUpgrade"===e?this.onUpgradeHandlers.push(t):"onFuse"===e&&this.onFuseHandlers.push(t),this}_onEquip(){for(var e=0;e<this.onEquipHandlers.length;e++)this.onEquipHandlers[e](this.gear)}_onUpgrade(){for(var e=0;e<this.onUpgradeHandlers.length;e++)this.onUpgradeHandlers[e](this.gear)}_onFuse(){for(var e=0;e<this.onFuseHandlers.length;e++)this.onFuseHandlers[e](this.gear)}destroy(){this.backingRect.destroy(),this.nameLabel.destroy(),this.typeLabel.destroy();for(var e=0;e<this.statLabels.length;e++)this.statLabels[e].destroy();void 0!==this.equipBtn&&this.equipBtn.destroy(),void 0!==this.upgradeBtn&&this.upgradeBtn.destroy(),void 0!==this.moteLabel&&this.moteLabel.destroy(),void 0!==this.moteButton&&this.moteButton.destroy()}}class yt{constructor(e,t,i,s){var a=new Ee;if(void 0===s)this.nameLabel=e.add.bitmapText(t+5,i+5,"courier20","Nothing"),this.typeLabel=e.add.bitmapText(t+5,i+25,"courier16",""),this.statLabel=e.add.bitmapText(t+5,i+45,"courier16","");else{this.nameLabel=e.add.bitmapText(t+5,i+5,"courier20",s.name+" Lv"+s.level);if(this.typeLabel=e.add.bitmapText(t+5,i+25,"courier16","Tier "+s.tier+" "+["Weapon","Armor","Trinket"][s.slotType]),this.motePower=1,s.level>0&&!0===a.unlocks.motes){var r=new Ge;this.motePower=1+r.getMotePower(s.motesFused)}var n="";for(const e in s.statBonuses)0!==s.statBonuses[e]&&(n+=Pe.getBonusText(e,s.statBonuses[e]*this.motePower)+"\n");this.statLabel=e.add.bitmapText(t+5,i+45,"courier16",n)}}getTextBounds(){return 30+this.statLabel.getTextBounds(!0).local.height}destroy(){this.nameLabel.destroy(),this.typeLabel.destroy(),this.statLabel.destroy()}}class vt extends s{constructor(e,t){super(e,t),this.player=new Fe,this.page=0,this.gearList=[],this.craftDisplays=[],this.gearDisplays=[],this.progression=new Ee}create(){this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.allBtn=new Ze(this,this.relativeX(340),this.relativeY(10),50,20,"All"),this.allBtn.onClickHandler(()=>{this._changeFilter(-1)}),this.tier0Btn=new Ze(this,this.relativeX(390),this.relativeY(10),80,20,"Broken"),this.tier0Btn.onClickHandler(()=>{this._changeFilter(0)}),this.tier1Btn=new Ze(this,this.relativeX(470),this.relativeY(10),30,20,"T1"),this.tier1Btn.onClickHandler(()=>{this._changeFilter(1)}),this.tier2Btn=new Ze(this,this.relativeX(500),this.relativeY(10),30,20,"T2"),this.tier2Btn.onClickHandler(()=>{this._changeFilter(2)}),this.tier3Btn=new Ze(this,this.relativeX(530),this.relativeY(10),30,20,"T3"),this.tier3Btn.onClickHandler(()=>{this._changeFilter(3)}),this.tier4Btn=new Ze(this,this.relativeX(560),this.relativeY(10),30,20,"T4"),this.tier4Btn.onClickHandler(()=>{this._changeFilter(4)}),this.tier5Btn=new Ze(this,this.relativeX(590),this.relativeY(10),30,20,"T5"),this.tier5Btn.onClickHandler(()=>{this._changeFilter(5)}),this.tier6Btn=new Ze(this,this.relativeX(620),this.relativeY(10),30,20,"T6"),this.tier6Btn.onClickHandler(()=>{this._changeFilter(6)}),this.tier7Btn=new Ze(this,this.relativeX(650),this.relativeY(10),30,20,"T7"),this.tier7Btn.onClickHandler(()=>{this._changeFilter(7)}),this.tier8Btn=new Ze(this,this.relativeX(680),this.relativeY(10),30,20,"T8"),this.tier8Btn.onClickHandler(()=>{this._changeFilter(8)}),this.prevPageBtn=new Ze(this,this.relativeX(850),this.relativeY(10),20,20,"<").onClickHandler(()=>{this._prevPage()}),this.nextPageBtn=new Ze(this,this.relativeX(870),this.relativeY(10),20,20,">").onClickHandler(()=>{this._nextPage()}),this.weaponLabel=this.add.bitmapText(this.relativeX(0),this.relativeY(0),"courier20","Weapon"),this.armorLabel=this.add.bitmapText(this.relativeX(0),this.relativeY(0),"courier20","Armor"),this.trinketLabel=this.add.bitmapText(this.relativeX(0),this.relativeY(0),"courier20","Trinket"),this._updateTierButtons(),this._setupGearDisplays(),this._changeFilter(-1),(new Ee).addOnUnlockHandler((e,t,i)=>{this._handleProgressionEvents(e,t,i)})}_handleProgressionEvents(e,t,i){switch(e){case d:case u:this._updateTierButtons(),this._setupView()}}_updateTierButtons(){var e=new Ge;this.tier1Btn.setVisible(e.tiersAvailable>=1),this.tier2Btn.setVisible(e.tiersAvailable>=2),this.tier3Btn.setVisible(e.tiersAvailable>=3),this.tier4Btn.setVisible(e.tiersAvailable>=4),this.tier5Btn.setVisible(e.tiersAvailable>=5),this.tier6Btn.setVisible(e.tiersAvailable>=6),this.tier7Btn.setVisible(e.tiersAvailable>=7),this.tier8Btn.setVisible(e.tiersAvailable>=8)}_nextPage(){6*this.page+6<this.gearList.length&&(this.page+=1),this._setupView()}_prevPage(){this.page>0&&(this.page-=1),this._setupView()}_changeFilter(e){var t=new Ge;this.gearList=[],this.page=0;for(var i=0;i<t.gear.length;i++)(-1===e||e===t.gear[i].tier)&&t.gear[i].tier<=t.tiersAvailable&&this.gearList.push(t.gear[i]);this._setupView()}_isEquipedItem(e){switch(e.slotType){case L:return void 0!==this.player.weapon&&e.name===this.player.weapon.name;case S:return void 0!==this.player.armor&&e.name===this.player.armor.name;case _:return void 0!==this.player.trinket&&e.name===this.player.trinket.name}}_setupGearDisplays(){for(var e=0;e<this.gearDisplays.length;e++)this.gearDisplays[e].destroy();this.gearDisplays=[],this.weaponLabel.setPosition(this.relativeX(10),this.relativeY(10));var t=10+this.weaponLabel.getTextBounds(!0).local.height;this.gearDisplays.push(new yt(this,this.relativeX(20),this.relativeY(t),this.player.weapon)),t+=20+this.gearDisplays[0].getTextBounds(),this.armorLabel.setPosition(this.relativeX(10),this.relativeY(t)),t+=this.armorLabel.getTextBounds(!0).local.height,this.gearDisplays.push(new yt(this,this.relativeX(20),this.relativeY(t),this.player.armor)),t+=20+this.gearDisplays[1].getTextBounds(),this.trinketLabel.setPosition(this.relativeX(10),this.relativeY(t)),t+=this.trinketLabel.getTextBounds(!0).local.height,this.gearDisplays.push(new yt(this,this.relativeX(20),this.relativeY(t),this.player.trinket))}_onEquipHandler(e){this.player.equip(e),this._setupView(),this._setupGearDisplays()}_onUpgradeHandler(e){for(var t=e.tier<=0?1:this.player.craftingCosts[e.tier-1],i=[],s=0;s<e.costs.length;s++)i.push(e.costs[s]*t);!1!==Pe.canCraft(i,this.player.resources[Math.max(0,e.tier-1)])&&(this.player.spendResource(i,Math.max(0,e.tier-1)),this._isEquipedItem(e)?(this.player.unequip(e.slotType),e.bringToLevel(e.level+1),this.player.equip(e),this._setupGearDisplays()):e.bringToLevel(e.level+1),this._setupView())}_onFuseHandler(e){if(!(this.player.motes<=0)){var t=this._isEquipedItem(e);!0===t&&this.player.unequip(e.slotType);var i=Math.min(this.player.motes,this.scene.get("DarkWorld").buyAmount);this.player.addMote(-i),e.motesFused+=i,!0===t&&this.player.equip(e),this._setupView(),this._setupGearDisplays()}}_setupView(){for(var e=0;e<this.craftDisplays.length;e++)this.craftDisplays[e].destroy();this.craftDisplays=[];for(e=6*this.page;e<Math.min(this.gearList.length,6*this.page+6);e++){var t=this.relativeX(320+e%2*290),i=this.relativeY(40+215*Math.floor((e-6*this.page)/2));this.craftDisplays.push(new pt(this,t,i,this.gearList[e]).registerEvents("onEquip",e=>{this._onEquipHandler(e)}).registerEvents("onUpgrade",e=>{this._onUpgradeHandler(e)}).registerEvents("onFuse",e=>{this._onFuseHandler(e)}))}}rebirth(){this._updateTierButtons(),this._setupGearDisplays(),this._changeFilter(-1)}update(e,t){!1===this.progression.unlocks.exploreTab&&void 0!==this.player.weapon&&void 0!==this.player.armor&&void 0!==this.player.trinket&&this.progression.registerFeatureUnlocked(o,"Now that you're all equipped it's time to explore. It's not like\nstaying here is going to do you any good.\n")}}class bt extends s{constructor(e,t){super(e,t)}rebirth(){this.talentLabel.setText("Talent Points\n"+this.player.talentPoints);for(var e=[[264,288],[312,240],[360,216],[408,192],[456,216],[504,240],[552,288],[216,240],[264,192],[336,144],[408,120],[480,144],[552,192],[600,240],[168,192],[240,120],[312,72],[408,48],[504,72],[576,120],[648,192],[408,312],[480,384],[336,384],[408,456]],t=0;t<this.talentButtons.length;t++)this.talentButtons[t].destroy();this.talentButtons=[];var i=0;for(const t in this.player.talents){var s=this.relativeX(e[i][0]+18),a=this.relativeY(e[i][1]+20);this._setupTalentButton(this.player.talents[t],s,a,i),i++}}create(){this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.floatingText=void 0,this.talentLabel=this.add.bitmapText(this.relativeX(450),this.relativeY(25),"courier20","Talent Points\n0",20,1).setOrigin(.5);var e=[[264,288],[312,240],[360,216],[408,192],[456,216],[504,240],[552,288],[216,240],[264,192],[336,144],[408,120],[480,144],[552,192],[600,240],[168,192],[240,120],[312,72],[408,48],[504,72],[576,120],[648,192],[408,312],[480,384],[336,384],[408,456]];this.player=new Fe,this.talentButtons=[];var t=0;for(const a in this.player.talents){var i=this.relativeX(e[t][0]+18),s=this.relativeY(e[t][1]+20);this._setupTalentButton(this.player.talents[a],i,s,t),t++}this.player.registerEvent("onTalentChanged",()=>{this._onTalentChanged()})}_setupTalentButton(e,t,i,s){this.talentButtons.push(new $e(this,t,i,48,48,e.texture).onClickHandler(()=>{this._levelUpTalent(e),this._disableTooltip(),this._setTooltip(e,t,i),this._updateTalentButton(e,s)}).onPointerOverHandler(()=>{this._setTooltip(e,t,i)}).onPointerOutHandler(()=>{this._disableTooltip()})),this._updateTalentButton(e,s)}_updateTalentButton(e,t){e.level>=e.maxLevel&&-1!==e.maxLevel?this.talentButtons[t].setBorderTint(Phaser.Display.Color.GetColor(0,220,0)):e.level>0&&this.talentButtons[t].setBorderTint(Phaser.Display.Color.GetColor(212,175,55))}_onTalentChanged(){this.talentLabel.setText("Talent Points\n"+this.player.talentPoints)}_haveTalentRequirements(e){for(var t=0;t<e.requires.length;t++)if(0===this.player.talents[e.requires[t]].level)return!1;return!0}_levelUpTalent(e){this.player.talentPoints<=0||!1===this._haveTalentRequirements(e)||this.player.levelTalent(e)}_setTooltip(e,t,i){void 0!==this.FloatingTooltip&&this._disableTooltip();var s=e.name+" Lv"+e.level+"\n"+ut.getTalentTooltip(e)+"\n\n";if(e.requires.length>0){s+="Requires: ";for(var r=0;r<e.requires.length;r++)s+=this.player.talents[e.requires[r]].name+(r<e.requires.length-1?", ":"")}s=Pe.processText(s,53),this.floatingText=new a(this,s,t+(t+450>1100?-450:0),i+(i>300?-150:50),450,150,"courier16",16)}_disableTooltip(){this.floatingText.destroy(),this.floatingText=void 0}}class ft{constructor(e,t,i,s,a,r,n){this.backRect=e.add.rectangle(t,i,s,a,0).setOrigin(0,0),this.backRect.isStroked=!0,this.backRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backRect.lineWidth=1,this.img=e.add.image(t+s/2,i+a/2,r.sprite,r.tile).setOrigin(.5),this.img.displayWidth=s,this.img.displayHeight=a,this.scene=e,this.floatingText=void 0,this.x=t,this.y=i,this.width=s,this.height=a,this.tooltip=Pe.processText(n,40),this.backRect.setInteractive().on("pointerover",()=>{this._showTooltip()}).on("pointerout",()=>{this._removeTooltip()})}setPosition(e,t){this.x=e,this.y=t,this.backRect.setPosition(e,t),this.img.setPosition(e+this.width/2,t+this.height/2)}setVisible(e){this.backRect.setVisible(e),this.img.setVisible(e)}setTooltip(e){this.tooltip=Pe.processText(e,40)}_showTooltip(){void 0!==this.floatingText&&this.floatingText.destroy();var e=this.x+20+(this.x+350>1100?-350:0),t=this.y+(this.y-100<0?0:-100);this.floatingText=new a(this.scene,this.tooltip,e,t,350,100,"courier16",16)}_removeTooltip(){this.floatingText.destroy(),this.floatingText=void 0}}class xt{constructor(e,t,i){this.backingRect=e.add.rectangle(t,i,800,600,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0).setInteractive(),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backingRect.lineWidth=4,this.title=e.add.bitmapText(t+400,i+5,"courier20","CHALLENGES").setOrigin(.5,0),this.challengeBtns=[];var s=0;for(const a in Ie.instance.challenges)this.challengeBtns.push(this._setupChallengeButton(e,Ie.instance.challenges[a],t+10,i+30+25*s)),s+=1;this.challengeBox=e.add.bitmapText(t+220,i+30,"courier20",""),this.acceptBtn=new Ze(e,t+275,i+550,120,20,"Accept"),this.acceptBtn.setEnable(!1),this.cancelBtn=new Ze(e,t+405,i+550,120,20,"Cancel"),this.selectedChallenge=void 0}onAcceptHandler(e){return this.acceptBtn.onClickHandler(()=>{e(this.selectedChallenge)}),this}onCancelHandler(e){return this.cancelBtn.onClickHandler(()=>{e()}),this}_setupChallengeButton(e,t,i,s){var a=new Ze(e,i,s,190,20,t.unlocked?t.name:"Locked").onClickHandler(()=>{this._challengeClickHandler(t)});return a.setEnable(t.unlocked),a}_challengeClickHandler(e){this.challengeBox.setText(Pe.processText(ut.getChallengeDescription(e),57)),this.selectedChallenge=e,this.acceptBtn.setEnable(!0)}destroy(){this.backingRect.destroy(),this.title.destroy(),this.acceptBtn.destroy(),this.cancelBtn.destroy(),this.challengeBox.destroy();for(var e=0;e<this.challengeBtns.length;e++)this.challengeBtns[e].destroy()}}class wt{constructor(e,t,i){this.backingRect=e.add.rectangle(t,i,700,500,Phaser.Display.Color.GetColor(0,0,0)).setOrigin(0,0).setInteractive(),this.backingRect.isStroked=!0,this.backingRect.strokeColor=Phaser.Display.Color.GetColor(255,255,255),this.backingRect.lineWidth=4,this.title=e.add.bitmapText(t+350,i+5,"courier20",We.instance.challengeName).setOrigin(.5,0);var s=Je.instance.time.time-Je.instance.timeAtRunStart,a=ut.getChallengeDescription(Ie.instance.getChallengeFromName(We.instance.challengeName));a+="\nCurrent Run Time: "+new Qe(s).getTimespanText()+"\n\nYou may abandon this challenge, causing you to gate immediately. You will not get any Moonlight for this run if you abandon.",this.desc=e.add.bitmapText(t+10,i+30,"courier20",Pe.processText(a,70)).setOrigin(0),this.abandonBtn=new Ze(e,t+225,i+450,120,20,"Abandon"),this.cancelBtn=new Ze(e,t+355,i+450,120,20,"Cancel")}onAbandonHandler(e){return this.abandonBtn.onClickHandler(()=>{e()}),this}onCancelHandler(e){return this.cancelBtn.onClickHandler(()=>{e()}),this}destroy(){this.backingRect.destroy(),this.title.destroy(),this.abandonBtn.destroy(),this.cancelBtn.destroy(),this.desc.destroy()}}class kt extends s{constructor(e,t){super(e,t),this.canLevelPerks=!1}create(){this.add.rectangle(this.relativeX(0),this.relativeY(0),1100,800,0).setOrigin(0).setInteractive(),this.floatingText=void 0,this.moonlightLabel=this.add.bitmapText(this.relativeX(550),this.relativeY(400),"courier20","MOONLIGHT\n0",20,1).setOrigin(.5),this.moonlightLabel.setTint(Phaser.Display.Color.GetColor(206,238,240));var e=[[648,480],[672,408],[624,312],[552,240],[456,192],[360,144],[264,120],[168,144],[144,216],[192,312],[264,384],[360,432],[456,480],[552,504],[528,576],[312,504],[120,360],[120,72],[72,240]];this.moonlight=new Ie,this.moonlightButtons=[];var t=0;for(const a in this.moonlight.moonperks){var i=this.relativeX(e[t][0]+118),s=this.relativeY(e[t][1]+56);this._setupMoonlightButton(this.moonlight.moonperks[a],i,s),t++}this.exitButton=new Ze(this,this.relativeX(950),this.relativeY(730),120,40,"BACK").onClickHandler(()=>{if(!0===this.canLevelPerks){var e=this.scene.get("DarkWorld");this.canLevelPerks=!1,e.rebirth()}else this.scene.sendToBack()}),this.challengeBox=void 0,this.challengeBtn=new Ze(this,970,12,120,30,"Challenges").onClickHandler(()=>{this._setupChallengeWindow()}),this.challengePointIcon=new ft(this,20,20,16,16,{sprite:"moonicons",tile:7},"Challenge Points earned from completing challenges. Each point increases your core stats by an additional 1%."),this.challengePointLabel=this.add.bitmapText(40,20,"courier20",Ie.instance.challengePoints+""),this.challengeBtn.setVisible(Ee.instance.persistentUnlocks.challenges),this.challengePointIcon.setVisible(Ee.instance.persistentUnlocks.challenges),this.challengePointLabel.setVisible(Ee.instance.persistentUnlocks.challenges)}enableLeveling(){this.canLevelPerks=!0,this.challengeBtn.setVisible(Ee.instance.persistentUnlocks.challenges),this.challengePointIcon.setVisible(Ee.instance.persistentUnlocks.challenges),this.challengePointLabel.setText(Ie.instance.challengePoints+""),this.challengePointLabel.setVisible(Ee.instance.persistentUnlocks.challenges)}_setupChallengeWindow(){void 0!==this.challengeBox&&(this.challengeBox.destroy(),this.challengeBox=void 0),""!==We.instance.challengeName?this.challengeBox=new wt(this,200,150).onAbandonHandler(()=>{this._abandonChallenge()}).onCancelHandler(()=>{this._removeChallengeWindow()}):this.challengeBox=new xt(this,150,100).onAcceptHandler(e=>{this._beginChallenge(e)}).onCancelHandler(()=>{this._removeChallengeWindow()})}_removeChallengeWindow(){void 0!==this.challengeBox&&(this.challengeBox.destroy(),this.challengeBox=void 0)}_beginChallenge(e){if(!0===this.canLevelPerks){We.instance.setupChallenge(e);var t=this.scene.get("DarkWorld");this.canLevelPerks=!1,t.rebirth()}void 0!==this.challengeBox&&(this.challengeBox.destroy(),this.challengeBox=void 0)}_abandonChallenge(){void 0!==this.challengeBox&&(this.challengeBox.destroy(),this.challengeBox=void 0),this.canLevelPerks=!0}_setupMoonlightButton(e,t,i){this.moonlightButtons.push(new $e(this,t,i,48,48,e.texture).onClickHandler(()=>{this._levelUpPerk(e),this._onMoonlightChanged(),this._disableTooltip(),this._setTooltip(e,t,i)}).onPointerOverHandler(()=>{this._setTooltip(e,t,i)}).onPointerOutHandler(()=>{this._disableTooltip()}))}_onMoonlightChanged(){this.moonlightLabel.setText("MOONLIGHT\n"+Pe.numberString(this.moonlight.moonlight))}_haveMoonlightRequirements(e){for(var t=0;t<e.requires.length;t++)if(0===this.moonlight.moonperks[e.requires[t]].level)return!1;return!0}_levelUpPerk(e){if(!1!==this.canLevelPerks&&!(e.level>=e.maxLevel&&-1!==e.maxLevel)){var t=Math.floor((e.cost[0]+e.cost[1]*e.level)*Math.pow(e.cost[2],e.level));this.moonlight.moonlight<t||!1===this._haveMoonlightRequirements(e)||(this.moonlight.moonlight-=t,e.level+=1)}}_setTooltip(e,t,i){void 0!==this.FloatingTooltip&&this._disableTooltip();var s=e.name+" Lv"+e.level+"\n"+ut.getMoonlightTooltip(e)+"\n\n",r=Math.floor((e.cost[0]+e.cost[1]*e.level)*Math.pow(e.cost[2],e.level));if(s+="Costs "+Pe.numberString(r)+" Moonlight\n",e.requires.length>0){s+="Requires: ";for(var n=0;n<e.requires.length;n++)0===this.moonlight.moonperks[e.requires[n]].level&&(s+=this.moonlight.moonperks[e.requires[n]].name+(n<e.requires.length-1?", ":""))}s=Pe.processText(s,53),this.floatingText=new a(this,s,t+(t+450>1100?-450:0),i+(i>300?-150:50),450,150,"courier16",16)}_disableTooltip(){this.floatingText.destroy(),this.floatingText=void 0}}class Ct extends s{constructor(e,t){super(e,t),this.regionIcons=[],this.regionPaths=[],this.page=0,this.worldData=new Je}rebirth(){}create(){this.add.rectangle(this.relativeX(0),this.relativeY(0),900,700,0).setOrigin(0).setInteractive(),this.floatingText=void 0,this._refreshRegions()}_setupRegionTile(e,t,i,s){var a=i.regionLevel*We.instance.regionDifficultyIncrease+"-"+(i.regionLevel+1)*We.instance.regionDifficultyIncrease,r=Math.floor(100*i.getExplorePercent())+"%";this.regionIcons.push(new $e(this,e,t,64,64,{sprite:"icons",tile:40}).onClickHandler(()=>{this._selectRegion(s)}).onPointerOverHandler(()=>{this._createTooltip(e,t,a,r,i.type)}).onPointerOutHandler(()=>{this._disableTooltip()}))}_setupPotentialRegionTile(e,t,i,s){var a=20*this.worldData.regionList.length+"-"+(20*this.worldData.regionList.length+20);this.regionIcons.push(new $e(this,e,t,64,64,{sprite:"icons",tile:40}).onClickHandler(()=>{this._chooseNewRegion(s)}).onPointerOverHandler(()=>{this._createTooltip(e,t,a,void 0,i)}).onPointerOutHandler(()=>{this._disableTooltip()}))}_refreshRegions(){for(var e=0;e<this.regionIcons.length;e++)this.regionIcons[e].destroy();for(e=0;e<this.regionPaths.length;e++)this.regionPaths[e].destroy();this.regionIcons=[],this.regionPaths=[];for(e=8*this.page+1;e<Math.min(this.worldData.regionList.length,8*this.page+8);e++){var t=this.relativeX(50+(e-1)%8*100),i=this.relativeY(this.worldData.regionList[e-1].worldHeight),s=this.relativeX(50+e%8*100),a=this.relativeY(this.worldData.regionList[e].worldHeight);this.regionPaths.push(this.add.line(0,0,t,i,s,a,11141120).setOrigin(0).setLineWidth(4))}if(this.worldData.regionList.length<8*this.page+8)for(e=0;e<this.worldData.nextRegions.length;e++){var r=this.worldData.regionList.length%8;t=this.relativeX(50+(r-1)%8*100),i=this.relativeY(this.worldData.regionList[this.worldData.regionList.length-1].worldHeight),s=this.relativeX(50+r%8*100),a=this.relativeY(0)+Math.floor((e+1)*(700/(this.worldData.nextRegions.length+1)));this.regionPaths.push(this.add.line(0,0,t,i,s,a,6684706).setOrigin(0).setLineWidth(4))}for(e=8*this.page;e<Math.min(this.worldData.regionList.length,8*this.page+8);e++){var n=this.relativeX(50+e%8*100)-32,o=this.relativeY(this.worldData.regionList[e].worldHeight)-32;this._setupRegionTile(n,o,this.worldData.regionList[e],e)}if(this.worldData.regionList.length<8*this.page+8)for(e=0;e<this.worldData.nextRegions.length;e++){n=this.relativeX(50+this.worldData.regionList.length%8*100)-32,o=this.relativeY(0)+Math.floor((e+1)*(700/(this.worldData.nextRegions.length+1)))-32;this._setupPotentialRegionTile(n,o,this.worldData.nextRegions[e],e)}}_selectRegion(e){this._disableTooltip(),this.worldData.setCurrentRegion(e),this.scene.get("DarkWorld").changeRegion(),this.scene.get("RegionScene").changeRegion(),this.scene.get("TownScene").changeRegion(),this.scene.bringToTop("RegionScene"),this.scene.bringToTop("DarKWorld")}_chooseNewRegion(e){this.worldData.addRegion(e),this._disableTooltip(),this._refreshRegions()}_createTooltip(e,t,i,s,a){void 0!==this.floatingText&&this.floatingText.destroy(),e+=e+400>1100?-250:64,this.floatingText=new et(this,e,t,400,150),this.floatingText.addText(10,10,"courier20",Ne.REGION_TYPES[a].name),this.floatingText.addText(10,30,"courier16","Difficulty: "+i),void 0!==s&&this.floatingText.addText(200,30,"courier16","Explored: "+s);var r=Pe.processText(ut.getRegionTooltip(a),48);this.floatingText.addText(10,50,"courier16",r)}_disableTooltip(){void 0!==this.floatingText&&(this.floatingText.destroy(),this.floatingText=void 0)}}var Tt=new class extends s{constructor(e,t){super(e,t),this.settings=new We,this.moonlight=new Ie,this.worldData=new Je,this.player=new Fe,this.progression=new Ee,this.gearShowTimer=2e3,this.infuseStart=0,this.gearStart=0,this.detailsStart=0,this.resourceStart=0,this.resourceTierSelected=0,this.saveTimer=Se,this.buyAmount=1,this.talentCost=0,this.statCost=0,this.load()}preload(){this.load.bitmapFont("courier16","./../../assets/font/courier16.png","./../../assets/font/courier16.xml"),this.load.bitmapFont("courier20","./../../assets/font/courier20.png","./../../assets/font/courier20.xml"),this.load.spritesheet("icons","./../../assets/icons/icons.png",{frameWidth:16,frameHeight:16}),this.load.spritesheet("bldicons","./../../assets/icons/buildingicons.png",{frameWidth:16,frameHeight:16}),this.load.spritesheet("roadicons","./../../assets/icons/roadicons.png",{frameWidth:50,frameHeight:50}),this.load.spritesheet("moonicons","./../../assets/icons/moonicons.png",{frameWidth:16,frameHeight:16}),this.load.spritesheet("enemyicons","./../../assets/enemy/enemyicons.png",{frameWidth:16,frameHeight:16})}create(){this.add.bitmapText(10,10,"courier20","Stats"),this.add.rectangle(0,0,200,800,0).setOrigin(0).setInteractive(),this.add.rectangle(200,0,900,100,0).setOrigin(0).setInteractive(),this.statLabels=[],this.statIcons=[],this.statIncButtons=[],this.statIcons.push(new ft(this,20,20,16,16,{sprite:"icons",tile:0},"Strength determines how hard you hit. Each point increases your min Damage by 0.4, max Damage by 1, and increases damage from gear by ~1% (diminishing returns).")),this.statIcons.push(new ft(this,20,40,16,16,{sprite:"icons",tile:1},"Dexterity determines your ability to hit enemies. Each point increases your Hit by 7.")),this.statIcons.push(new ft(this,20,60,16,16,{sprite:"icons",tile:2},"Agility determines how hard you are to hit. Each point increases your Evasion by 7 and gives a small boost to explore speed.")),this.statIcons.push(new ft(this,20,80,16,16,{sprite:"icons",tile:3},"Endurance determines your health. Each point increases your max Health by 5")),this.statIcons.push(new ft(this,20,100,16,16,{sprite:"icons",tile:4},"Recovery determines how easily you heal your wounds. Each point increases your Health Regen by 0.1/s.")),this.statIcons.push(new ft(this,20,120,16,16,{sprite:"icons",tile:5},"Defense determines how durable your body is. Each point increases your armor by 0.2 and increases armor from gear by ~1% (diminishing returns).")),this.statIcons.push(new ft(this,20,140,16,16,{sprite:"icons",tile:6},"Accuracy determines your ability to strike weak points. Each point increases your Crit damage by 2.5%.")),this.statIncButtons.push(new Ze(this,150,20,16,16,"+").onClickHandler(()=>{this._increaseStat("str")})),this.statIncButtons.push(new Ze(this,150,40,16,16,"+").onClickHandler(()=>{this._increaseStat("dex")})),this.statIncButtons.push(new Ze(this,150,60,16,16,"+").onClickHandler(()=>{this._increaseStat("agi")})),this.statIncButtons.push(new Ze(this,150,80,16,16,"+").onClickHandler(()=>{this._increaseStat("end")})),this.statIncButtons.push(new Ze(this,150,100,16,16,"+").onClickHandler(()=>{this._increaseStat("rec")})),this.statIncButtons.push(new Ze(this,150,120,16,16,"+").onClickHandler(()=>{this._increaseStat("def")})),this.statIncButtons.push(new Ze(this,150,140,16,16,"+").onClickHandler(()=>{this._increaseStat("acc")})),this.detailsLabels=[],this.detailsIcons=[],this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:25},"Health, when this runs out you die.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:24},"The damage you deal with each attack. Your damage is reduced by the targets armor, dealing a minimum of 1 damage.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:26},"Armor. Each point reduces damage from enemy attacks by 1.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:27},"Hit Chance. Hit increases your attack speed, while enemy Evasion lowers your attack speed.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:28},"Evasion. Slows enemy attack speed if you have more Evasion then their Hit.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:29},"Health Regen. You restore this much Health every second. Works in combat.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:31},"Crit Chance. The chance any hit is a critical hit, dealing extra damage.")),this.detailsIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:30},"Crit Damage. Your damage is increased by this when you land a critical hit. All sources have diminishing returns.")),this.gearLabels=this.add.bitmapText(20,30,"courier16","").setOrigin(0),this.resourceLabels=[],this.resourceTierButtons=[],this.resourceTierButtons.push(new Ze(this,20,170,16,16,"1").onClickHandler(()=>{this.resourceTierSelected=0,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"2").onClickHandler(()=>{this.resourceTierSelected=1,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"3").onClickHandler(()=>{this.resourceTierSelected=2,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"4").onClickHandler(()=>{this.resourceTierSelected=3,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"5").onClickHandler(()=>{this.resourceTierSelected=4,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"6").onClickHandler(()=>{this.resourceTierSelected=5,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"7").onClickHandler(()=>{this.resourceTierSelected=6,this._updateResources()})),this.resourceTierButtons.push(new Ze(this,20,170,16,16,"8").onClickHandler(()=>{this.resourceTierSelected=7,this._updateResources()})),this.resourceIcons=[],this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:32},"Wood. Found in forests and wodes, duh.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:33},"Leather. The best leather comes from the plains and forests.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:34},"Metal. Hard to find resource thats available in large quantities in the mountains.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:35},"Fiber. Found in swamps and forests.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:36},"Stone. Can be found in abundance in the hills.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:37},"Crystal. Hard to find in large amounts, but can be found in the harder to reach areas.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:38},"Gold. Your current gold cap is equal to (Flat bonuses + population) * Economy Multiplier.")),this.resourceIcons.push(new ft(this,20,170,16,16,{sprite:"icons",tile:39},"Motes of Darkness. Fuse these onto weapons to improve their power.")),this.buyButtons=[],this.buyButtons.push(new Ze(this,10,780,30,18,"x1").onClickHandler(()=>{this._setBuyAmount(1,0)}).setTextColor(Phaser.Display.Color.GetColor(255,255,0))),this.buyButtons.push(new Ze(this,45,780,30,18,"x5").onClickHandler(()=>{this._setBuyAmount(5,1)})),this.buyButtons.push(new Ze(this,80,780,40,18,"x10").onClickHandler(()=>{this._setBuyAmount(10,2)})),this.buyButtons.push(new Ze(this,125,780,40,18,"x100").onClickHandler(()=>{this._setBuyAmount(100,3)})),this.infuseLabel=this.add.bitmapText(10,10,"courier20","Infuse"),this.shadeLabel=this.add.bitmapText(20,10,"courier16","Shade: "+this.player.shade),this.statInfuseLabel=this.add.bitmapText(20,10,"courier16","Infuse Stat"),this.statProgressBar=new at(this,100,10,120,14,Phaser.Display.Color.GetColor(0,0,255),Phaser.Display.Color.GetColor(0,32,0)),this.statInfuseButton=new Ze(this,250,10,16,16,"+"),this.statInfuseButton.onClickHandler(()=>{this._buyStatPoint()}),this.talentInfuseLabel=this.add.bitmapText(20,10,"courier16","Infuse Talent"),this.talentProgressBar=new at(this,100,10,120,14,Phaser.Display.Color.GetColor(0,0,255),Phaser.Display.Color.GetColor(0,32,0)),this.talentInfuseButton=new Ze(this,250,10,16,16,"+"),this.talentInfuseButton.onClickHandler(()=>{this._buyTalentPoint()}),this.gearLabel=this.add.bitmapText(10,10,"courier20","Gear"),this.detailsLabel=this.add.bitmapText(10,10,"courier20","Details"),this.resourceLabel=this.add.bitmapText(10,10,"courier20","Resources"),this.progression.addOnUnlockHandler((e,t,i)=>{this._handleProgressionEvents(e,t,i)}),this.loreButton=new Ze(this,200,60,122,20,"Lore").onClickHandler(()=>{this.scene.bringToTop("LoreScene"),this.scene.bringToTop("DarkWorld")}),this.gearButton=new Ze(this,327,60,122,20,"Gear").onClickHandler(()=>{this.scene.bringToTop("GearScene"),this.scene.bringToTop("DarkWorld")}),this.talentButton=new Ze(this,454,60,122,20,"Talents").onClickHandler(()=>{this.scene.bringToTop("TalentScene"),this.scene.bringToTop("DarkWorld")}),this.regionButton=new Ze(this,581,60,122,20,"Region").onClickHandler(()=>{this.scene.bringToTop("RegionScene"),this.scene.bringToTop("DarkWorld")}),this.combatButton=new Ze(this,708,60,122,20,"Combat").onClickHandler(()=>{this.scene.bringToTop("CombatScene"),this.scene.bringToTop("DarkWorld")}),this.townButton=new Ze(this,835,60,122,20,"Town").onClickHandler(()=>{this.scene.bringToTop("TownScene"),this.scene.bringToTop("DarkWorld")}),this.worldButton=new Ze(this,962,60,122,20,"World").onClickHandler(()=>{this.scene.bringToTop("WorldScene"),this.scene.bringToTop("DarkWorld")}),this.worldTimeLabel=this.add.bitmapText(650,80,"courier20","").setOrigin(.5,0),this.moonlightButton=new $e(this,1005,12,32,32,{sprite:"moonicons",tile:12}).onClickHandler(()=>{this.scene.bringToTop("MoonlightScene")}),this.gearButton.setVisible(this.progression.unlocks.gearTab),this.regionButton.setVisible(this.progression.unlocks.exploreTab),this.combatButton.setVisible(this.progression.unlocks.combatTab),this.townButton.setVisible(Je.instance.getCurrentRegion().townData.townExplored),!0===We.instance.talentsEnabled?this.talentButton.setVisible(this.progression.unlocks.talentsTab):this.talentButton.setVisible(!1),this.worldButton.setVisible(this.progression.unlocks.worldTab),this.moonlightButton.setVisible(this.progression.totalCounts.timesGated>0),this.registry.set("setTooltip",(e,t,i,s,a)=>{this._setTooltip(e,t,i,s,a)}),this.registry.set("disableTooltip",()=>{this._disableTooltip()}),this.regionScene=new st([200,100],"RegionScene"),this.regionScene.registerEvent("onTileClick",(e,t,i)=>{this._handleTileClick(e,t,i)}),this.combatScene=new ht([200,100],"CombatScene"),this.combatScene.registerEvent("onKill",(e,t,i,s)=>{this._onKillCallback(e,t,i,s)}),this.loreScene=new dt([200,100],"LoreScene"),this.gearScene=new vt([200,100],"GearScene"),this.townScene=new mt([200,100],"TownScene"),this.talentScene=new bt([200,100],"TalentScene"),this.worldScene=new Ct([200,100],"WorldScene"),this.moonlightScene=new kt([0,0],"MoonlightScene"),this.scene.add("CombatScene",this.combatScene,!0),this.scene.add("RegionScene",this.regionScene,!0),this.scene.add("LoreScene",this.loreScene,!0),this.scene.add("GearScene",this.gearScene,!0),this.scene.add("TownScene",this.townScene,!0),this.scene.add("TalentScene",this.talentScene,!0),this.scene.add("WorldScene",this.worldScene,!0),this.scene.add("MoonlightScene",this.moonlightScene,!0),this.scene.bringToTop("LoreScene"),this.scene.bringToTop("DarkWorld"),this.player.statBlock.registerEvent("onHealthChanged",()=>{this._updateDetails()}),this.player.registerEvent("onStatChanged",()=>{this._layoutStats()}),this.player.registerEvent("onResourcesChanged",()=>{this._updateResources()}),!1===this.progression.unlocks.gearTab&&this.loreScene.addText("You open your eyes and see a vast wilderness before you. Unsure of how you got here you check your surroundings for any clues. You find a broken sword, an old barrel lid and some worn, raggy leathers. Not great, but you're also naked so you take what you can get.\n\nAfter putting these on you should go exploring."),this._layoutStats(),this._setBuyAmount(1,0)}_setBuyAmount(e,t){this.buyAmount=e,this._updateInfuseCosts();for(var i=0;i<this.buyButtons.length;i++)this.buyButtons[i].setTextColor(Phaser.Display.Color.GetColor(255,255,255));this.buyButtons[t].setTextColor(Phaser.Display.Color.GetColor(255,255,0))}_updateInfuseCosts(){this.statCost=this.player.getStatCost(this.buyAmount),this.talentCost=this.player.getTalentCost(this.buyAmount),this.statProgressBar.setFillPercent(this.player.shade/this.statCost,Pe.numberString(Math.floor(Math.min(this.player.shade,this.statCost)))+"/"+Pe.numberString(this.statCost)),this.talentProgressBar.setFillPercent(this.player.shade/this.talentCost,Pe.numberString(Math.floor(Math.min(this.player.shade,this.talentCost)))+"/"+Pe.numberString(Math.floor(this.talentCost))),this.statInfuseButton.setEnable(this.player.shade>=this.statCost),this.talentInfuseButton.setEnable(this.player.shade>=this.talentCost)}_handleProgressionEvents(e,t,i){switch(void 0!==i&&""!==i&&this.loreButton.setNotification(),e){case n:this.gearButton.setVisible(!0);break;case o:this.regionButton.setVisible(!0);break;case h:this.combatButton.setVisible(!0);break;case l:this.townButton.setVisible(Je.instance.getCurrentRegion().townData.townExplored),this._updateResources();break;case m:!0===We.instance.talentsEnabled&&this.talentButton.setVisible(!0);break;case p:this.worldButton.setVisible(!0);break;case c:case d:this._layoutStats();break;case f:50===t&&this.progression.registerFeatureUnlocked(c);break;case v:5===t&&this.progression.registerFeatureUnlocked(g);break;case x:if(25===t)this.progression.registerFeatureUnlocked(d);else if(100===t){(new Ge).tiersAvailable=1,this.progression.registerFeatureUnlocked(u)}break;case y:this._updateResources()}}_updateStats(){for(var e=0;e<this.statLabels.length;e++)this.statLabels[e].destroy();this.statLabels=[],this.statLabels.push(this.add.bitmapText(20,0,"courier16","Stat Points: "+this.player.statPoints)),this.statLabels.push(this.add.bitmapText(40,20,"courier16",Pe.numberString(this.player.statBlock.Strength()))),this.statLabels.push(this.add.bitmapText(40,40,"courier16",Pe.numberString(this.player.statBlock.Dexterity()))),this.statLabels.push(this.add.bitmapText(40,60,"courier16",Pe.numberString(this.player.statBlock.Agility()))),this.statLabels.push(this.add.bitmapText(40,80,"courier16",Pe.numberString(this.player.statBlock.Endurance()))),this.statLabels.push(this.add.bitmapText(40,100,"courier16",Pe.numberString(this.player.statBlock.Recovery()))),this.statLabels.push(this.add.bitmapText(40,120,"courier16",Pe.numberString(this.player.statBlock.Defense()))),this.statLabels.push(this.add.bitmapText(40,140,"courier16",Pe.numberString(this.player.statBlock.Accuracy()))),this._updateStatButtons()}_updateShade(){this.infuseLabel.setPosition(10,this.infuseStart),this.shadeLabel.setPosition(20,this.infuseStart+20),this.statInfuseLabel.setPosition(20,this.infuseStart+40),this.statProgressBar.setPosition(20,this.infuseStart+60),this.statInfuseButton.setPosition(150,this.infuseStart+60),this.talentInfuseLabel.setPosition(20,this.infuseStart+80),this.talentProgressBar.setPosition(20,this.infuseStart+100),this.talentInfuseButton.setPosition(150,this.infuseStart+100),this.shadeLabel.setText("Shade: "+Pe.numberString(Math.floor(this.player.shade))),this.statProgressBar.setFillPercent(this.player.shade/this.statCost,Pe.numberString(Math.floor(Math.min(this.player.shade,this.statCost)))+"/"+Pe.numberString(this.statCost)),this.talentProgressBar.setFillPercent(this.player.shade/this.talentCost,Pe.numberString(Math.floor(Math.min(this.player.shade,this.talentCost)))+"/"+Pe.numberString(Math.floor(this.talentCost))),this.statInfuseButton.setEnable(this.player.shade>=this.statCost),this.talentInfuseButton.setEnable(this.player.shade>=this.talentCost)}_updateGear(){var e=Pe.processText("W: "+(void 0===this.player.weapon?"None":this.player.weapon.name+" Lv"+this.player.weapon.level),20)+"\n"+Pe.processText("A: "+(void 0===this.player.armor?"None":this.player.armor.name+" Lv"+this.player.armor.level),20)+"\n"+Pe.processText("T: "+(void 0===this.player.trinket?"None":this.player.trinket.name+" Lv"+this.player.trinket.level),20);this.gearLabels.setText(e)}_updateDetails(){this.detailsLabel.setPosition(10,this.detailsStart);for(var e=0;e<this.detailsLabels.length;e++)this.detailsLabels[e].destroy();this.detailsLabels=[];for(e=0;e<this.detailsIcons.length;e++)this.detailsIcons[e].setPosition(20,this.detailsStart+20+20*e);this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+20,"courier16",Pe.numberString(Math.floor(this.player.statBlock.currentHealth))+"/"+Pe.numberString(this.player.statBlock.MaxHealth()))),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+40,"courier16",Pe.numberString(this.player.statBlock.DamageMin())+"-"+Pe.numberString(this.player.statBlock.DamageMax()))),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+60,"courier16",Pe.numberString(this.player.statBlock.Armor()))),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+80,"courier16",Pe.numberString(this.player.statBlock.Hit()))),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+100,"courier16",Pe.numberString(this.player.statBlock.Evasion()))),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+120,"courier16",this.player.statBlock.HealthRegen()+"/s")),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+140,"courier16",Math.floor(100*this.player.statBlock.CritChance())+"%")),this.detailsLabels.push(this.add.bitmapText(40,this.detailsStart+160,"courier16","+"+Pe.numberString(Math.floor(100*(this.player.statBlock.CritDamage()-1)))+"%"))}_updateResources(){this.resourceLabel.setPosition(10,this.resourceStart),this.resourceLabel.setVisible(this.progression.unlocks.resourceUI);for(var e=0;e<this.resourceLabels.length;e++)this.resourceLabels[e].destroy();this.resourceLabels=[];for(e=0;e<this.resourceIcons.length;e++)this.resourceIcons[e].setPosition(20,this.resourceStart+40+20*e),this.resourceIcons[e].setVisible(this.progression.unlocks.resourceUI);for(e=0;e<this.resourceTierButtons.length;e++)this.resourceTierButtons[e].setPosition(20+20*e,this.resourceStart+20),this.resourceTierButtons[e].setVisible(this.player.resourceTierReached>=1&&e<=this.player.resourceTierReached);if(this.resourceIcons[6].setVisible(this.progression.unlocks.townTab),this.resourceIcons[7].setVisible(this.progression.unlocks.motes),!0===this.progression.unlocks.resourceUI){var t=this.player.resources[this.resourceTierSelected];this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+40,"courier16",Pe.numberString(Math.floor(t[0])))),this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+60,"courier16",Pe.numberString(Math.floor(t[1])))),this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+80,"courier16",Pe.numberString(Math.floor(t[2])))),this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+100,"courier16",Pe.numberString(Math.floor(t[3])))),this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+120,"courier16",Pe.numberString(Math.floor(t[4])))),this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+140,"courier16",Pe.numberString(Math.floor(t[5])))),!0===this.progression.unlocks.townTab&&this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+160,"courier16",Pe.numberString(Math.floor(this.player.gold))+"/"+Pe.numberString(Math.floor(this.worldData.getGoldCap())))),!0===this.progression.unlocks.motes&&this.resourceLabels.push(this.add.bitmapText(40,this.resourceStart+180,"courier16",Pe.numberString(Math.floor(this.player.motes))))}}_layoutStats(){var e=160;this.infuseLabel.setVisible(this.progression.unlocks.infuseUI),this.shadeLabel.setVisible(this.progression.unlocks.infuseUI),this.statProgressBar.setVisible(this.progression.unlocks.infuseUI),this.statInfuseButton.setVisible(this.progression.unlocks.infuseUI),this.statInfuseLabel.setVisible(this.progression.unlocks.infuseUI),!0===We.instance.talentsEnabled?(this.talentProgressBar.setVisible(this.progression.unlocks.infuseUI),this.talentInfuseButton.setVisible(this.progression.unlocks.infuseUI),this.talentInfuseLabel.setVisible(this.progression.unlocks.infuseUI)):(this.talentProgressBar.setVisible(!1),this.talentInfuseButton.setVisible(!1),this.talentInfuseLabel.setVisible(!1)),!0===this.progression.unlocks.infuseUI&&(this.infuseStart=e,e+=120),this.gearStart=e,this.gearLabel.setPosition(10,e),this.gearLabels.setPosition(20,e+20),this._updateGear(),e+=this.gearLabels.getTextBounds().local.height+20,this.detailsStart=e,e+=180,this.resourceStart=e,this._updateStats(),this._updateDetails(),this._updateShade(),this._updateResources()}_updateStatButtons(){for(var e=this.player.statPoints>0,t=0;t<this.statIncButtons.length;t++)this.statIncButtons[t].setEnable(e)}_handleTileClick(e,t,i=!1){var s=this.worldData.getCurrentRegion();s.isExplorable(e,t)&&(!1===i&&(this.scene.bringToTop("CombatScene"),this.scene.bringToTop("DarkWorld")),this.combatScene.initFight(s.map[t][e]))}_buyStatPoint(){this.progression.registerStatPointGain(this.buyAmount),this.player.buyStat(this.buyAmount),this._updateInfuseCosts(),this._updateStats(),this._updateShade()}_buyTalentPoint(){!1===this.progression.unlocks.talentsTab&&this.progression.registerFeatureUnlocked(m,"Holding this much raw shade, it almost feels... alive? Or it would be if classes were in the game. Since they're not you just get 1 measly talent point to spend on the basic bitch talents."),this.player.buyTalent(this.buyAmount),this._updateInfuseCosts(),this._updateShade()}_increaseStat(e){this.player.increaseStat(e,this.buyAmount)}_onKillCallback(e,t,i,s){var a=(new Je).getCurrentRegion(),r=Math.floor(e.difficulty/20);if(!0===this.progression.unlocks.craftingUI){var n=new Ge;n.tiersAvailable=Math.max(n.tiersAvailable,r+1),this.gearScene._updateTierButtons()}if(t*=1+.1*this.moonlight.moonperks.shadow.level,this.player.shade+=t,this.player.addResource(i,r),this._updateShade(),this.progression.registerMonsterKill(),this.progression.registerShadeGain(t),this.progression.registerResourceGain(i),!0===this.progression.unlocks.townTab){var o=(e.amountExplored<e.explorationNeeded?5:1)*a.townData.bountyMulti;this.player.addGold(s*o)}}rebirth(){this.player.rebirth(),(new Ge).rebirth(),this.worldData.rebirth(),this.progression.rebirth(),(new ct).rebirth(),this.gearButton.setVisible(this.progression.unlocks.gearTab),this.regionButton.setVisible(this.progression.unlocks.exploreTab),this.combatButton.setVisible(this.progression.unlocks.combatTab),this.townButton.setVisible(Je.instance.getCurrentRegion().townData.townExplored),this.talentButton.setVisible(this.progression.unlocks.talentsTab),this.worldButton.setVisible(this.progression.unlocks.worldTab),this.moonlightButton.setVisible(this.progression.totalCounts.timesGated>0),this._layoutStats(),this.gearShowTimer=2e3,this.loreScene.rebirth(),this.gearScene.rebirth(),this.talentScene.rebirth(),this.regionScene.rebirth(),this.combatScene.rebirth(),this.townScene.rebirth(),this.scene.bringToTop("LoreScene"),this.scene.bringToTop(),this.loreScene.addText("You open your eyes and see a vast wilderness before you. Unsure of how you got here you check your surroundings for any clues. You find a broken sword, an old barrel lid and some worn, raggy leathers. Not great, but you're also naked so you take what you can get.\n\nAfter putting these on you should go exploring.")}changeRegion(){this.townButton.setVisible(Je.instance.getCurrentRegion().townData.townExplored)}update(e,t){this.worldData.time.setFrameDelta(t);var i=this.worldData.time.frameDelta;this.worldData.update(i),this.player.statBlock.tickRegen(i,this.combatScene.isInCombat()),this.worldTimeLabel.setText(this.worldData.time.getText()),!0!==this.progression.unlocks.gearTab&&(this.gearShowTimer-=i,this.gearShowTimer<=0&&this.progression.registerFeatureUnlocked(n)),this.saveTimer-=t,this.saveTimer<=0&&(this.saveTimer=Se,this.save())}save(){var e=new We,t=new Ge,i=new ct,s={version:r,saveTime:Date.now(),settings:e.save(),player:this.player.save(),gear:t.save(),world:this.worldData.save(),progression:this.progression.save(),moon:this.moonlight.save(),lore:i.save()};localStorage.setItem("save",JSON.stringify(s))}load(){var e=JSON.parse(localStorage.getItem("save"));if(null!==e){var t=new Ge,i=new ct;if(e.ver>4)(new We).load(e.settings);t.load(e.gear,e.version),this.player.load(e.player,e.version),this.worldData.load(e.world,e.version),this.progression.load(e.progression,e.version),this.moonlight.load(e.moon,e.version),i.load(e.lore,e.version);var s=Date.now()-e.saveTime;s>6e4&&this.worldData.time.addOfflineTime(s)}}}([200,200],"DarkWorld"),Mt={type:Phaser.AUTO,parent:"phaser-example",width:1100,height:800,pixelArt:!0,scale:{autoCenter:Phaser.Scale.Center.CENTER_BOTH},scene:[Tt]};new Phaser.Game(Mt)}]);